# Phase 13.3: Isometric & Side-Scroller

**Phase**: 13.3
**Priority**: P1
**Dependencies**: Phase 13.1 (Pixel Converter)
**Est. Duration**: 4-5 days

---

## Goal

Implement isometric and side-scroller camera systems for game asset generation from 3D scenes.

---

## Requirements

- REQ-RETRO-04: Isometric projection with multiple angles
- REQ-RETRO-05: Side-scroller view with parallax layers
- REQ-RETRO-07: Sprite sheet generation
- REQ-RETRO-08: Tile-based output

---

## Plans

### Plan 13.3-01: Isometric Types

**Deliverable**: `lib/retro/isometric_types.py`

```python
@dataclass
class IsometricConfig:
    """Isometric view configuration."""
    enabled: bool = True
    angle: str = "pixel"  # true_isometric, pixel, military, dimetric
    tile_width: int = 32
    tile_height: int = 16
    depth_sorting: bool = True
    layer_separation: List[str] = field(default_factory=list)  # ground, objects, characters

    # Camera
    orthographic_scale: float = 10.0

@dataclass
class IsometricAngles:
    """Pre-defined isometric angles."""
    # True isometric: equal angles
    TRUE_ISOMETRIC = {
        "elevation": 35.264,  # arctan(1/√2)
        "rotation": 45.0,
        "description": "True isometric projection"
    }

    # Pixel isometric: 2:1 ratio (most common for games)
    PIXEL_ISOMETRIC = {
        "elevation": 30.0,  # arctan(1/2)
        "rotation": 45.0,
        "description": "2:1 pixel ratio, classic game style"
    }

    # Military (planometric)
    MILITARY = {
        "elevation": 45.0,
        "rotation": 45.0,
        "description": "Military/strategy game style"
    }

    # Dimetric (customizable)
    DIMETRIC = {
        "elevation": 30.0,
        "rotation": 30.0,
        "description": "Dimetric projection"
    }

@dataclass
class SideScrollerConfig:
    """Side-scroller view configuration."""
    enabled: bool = True
    parallax_layers: int = 4
    layer_depths: List[float] = field(default_factory=lambda: [0.25, 0.5, 1.0, 2.0])
    layer_names: List[str] = field(default_factory=lambda: ["far_bg", "mid_bg", "near_bg", "foreground"])

    # Camera
    orthographic: bool = True
    view_direction: str = "side"  # side, front, top

@dataclass
class SpriteSheetConfig:
    """Sprite sheet export configuration."""
    columns: int = 8
    rows: int = 8
    frame_width: int = 32
    frame_height: int = 32
    padding: int = 0
    trim: bool = True
    pivot_x: float = 0.5
    pivot_y: float = 0.5

    # Metadata
    generate_json: bool = True
    json_format: str = "phaser"  # phaser, unity, godot, generic
```

**Tasks**:
1. Create all dataclasses
2. Define angle presets
3. Add validation

---

### Plan 13.3-02: Isometric Camera

**Deliverable**: `lib/retro/isometric.py`

```python
def create_isometric_camera(config: IsometricConfig) -> CameraConfig:
    """Create isometric camera configuration."""
    pass

def set_isometric_angle(camera: Any, angle_preset: str) -> None:
    """Set camera to isometric angle preset."""
    pass

def calculate_isometric_rotation(elevation: float, azimuth: float) -> Tuple[float, float, float]:
    """Calculate Euler rotation for isometric view."""
    pass

def project_to_isometric(point: Tuple, config: IsometricConfig) -> Tuple[int, int]:
    """Project 3D point to isometric 2D coordinates."""
    pass

def render_isometric_tile(scene: Any, config: IsometricConfig) -> Any:
    """Render scene as isometric tile."""
    pass

def depth_sort_objects(objects: List, camera_pos: Tuple) -> List:
    """Sort objects for correct isometric rendering (painter's algorithm)."""
    pass

def create_isometric_grid(config: IsometricConfig) -> Any:
    """Create isometric grid overlay for alignment."""
    pass
```

**Tasks**:
1. Implement camera creation
2. Implement angle presets
3. Implement projection math
4. Implement tile rendering
5. Implement depth sorting
6. Test with various scenes

---

### Plan 13.3-03: Side-Scroller Camera

**Deliverable**: `lib/retro/side_scroller.py`

```python
def create_side_scroller_camera(config: SideScrollerConfig) -> CameraConfig:
    """Create side-scroller camera configuration."""
    pass

def separate_parallax_layers(scene: Any, config: SideScrollerConfig) -> List[Any]:
    """Separate scene into parallax layers based on depth."""
    pass

def render_parallax_layer(scene: Any, layer_index: int, config: SideScrollerConfig) -> Any:
    """Render single parallax layer."""
    pass

def calculate_parallax_offset(layer_depth: float, camera_move: float) -> float:
    """Calculate parallax scroll amount for layer."""
    pass

def create_parallax_animation(layers: List[Any], camera_move: Tuple, frames: int) -> List[List[Any]]:
    """Generate animated parallax sequence."""
    pass

# Depth assignment helpers
def assign_depth_by_z(objects: List, config: SideScrollerConfig) -> Dict[str, int]:
    """Assign objects to layers based on Z position."""
    pass

def assign_depth_by_collection(scene: Any, layer_names: List[str]) -> Dict[str, int]:
    """Assign collections to specific layers."""
    pass
```

**Tasks**:
1. Implement camera creation
2. Implement layer separation
3. Implement parallax calculation
4. Implement layer rendering
5. Implement animation generation
6. Test with game scenes

---

### Plan 13.3-04: Sprite Sheet Generator

**Deliverable**: `lib/retro/sprites.py`

```python
def generate_sprite_sheet(images: List[Any], config: SpriteSheetConfig) -> Tuple[Any, Dict]:
    """Generate sprite sheet from image sequence."""
    pass

def trim_sprite(image: Any) -> Tuple[Any, Tuple[int, int, int, int]]:
    """Trim transparent borders from sprite."""
    pass

def calculate_pivot(image: Any, trim_box: Tuple) -> Tuple[float, float]:
    """Calculate pivot point relative to trimmed sprite."""
    pass

def generate_sprite_metadata(sheet: Any, config: SpriteSheetConfig, trim_data: List) -> Dict:
    """Generate metadata JSON for sprite sheet."""
    pass

# Format-specific exporters
def export_phaser_json(config: SpriteSheetConfig, frames: List[Dict]) -> Dict:
    """Generate Phaser-compatible JSON."""
    pass

def export_unity_json(config: SpriteSheetConfig, frames: List[Dict]) -> Dict:
    """Generate Unity-compatible JSON."""
    pass

def export_godot_json(config: SpriteSheetConfig, frames: List[Dict]) -> Dict:
    """Generate Godot-compatible JSON."""
    pass

# Animation helpers
def extract_animation_frames(animation: Any, config: SpriteSheetConfig) -> List[Any]:
    """Extract frames from Blender animation."""
    pass

def generate_walk_cycle_sheet(character: Any, config: SpriteSheetConfig) -> Tuple[Any, Dict]:
    """Generate walk cycle sprite sheet."""
    pass
```

**Tasks**:
1. Implement sheet generation
2. Implement trimming
3. Implement pivot calculation
4. Implement JSON generation
5. Implement format exporters
6. Test with animations

---

### Plan 13.3-05: Tile System

**Deliverable**: `lib/retro/tiles.py`

```python
@dataclass
class TileConfig:
    """Tile export configuration."""
    tile_size: Tuple[int, int] = (32, 32)
    padding: int = 0
    spacing: int = 0
    format: str = "png"

def render_tile_set(objects: List[Any], config: IsometricConfig, tile_config: TileConfig) -> Any:
    """Render all objects as tile set."""
    pass

def generate_tile_map(scene: Any, config: IsometricConfig) -> List[List[int]]:
    """Generate tile map indices from scene."""
    pass

def export_tile_map(tile_map: List[List], path: str, format: str = "csv") -> None:
    """Export tile map data."""
    pass

def create_autotile_template(config: IsometricConfig) -> Any:
    """Create autotile (blob tile) template."""
    pass

# Common tile sizes
TILE_SIZES = {
    "nes": (16, 16),
    "snes": (16, 16),
    "gba": (16, 16),
    "modern_32": (32, 32),
    "modern_64": (64, 64),
    "isometric_32": (32, 16),
    "isometric_64": (64, 32),
}
```

**Tasks**:
1. Implement tile rendering
2. Implement tile map generation
3. Implement export formats
4. Implement autotile templates
5. Create examples

---

### Plan 13.3-06: Presets & Integration

**Deliverable**: `configs/cinematic/retro/view_presets.yaml`

```yaml
isometric_presets:
  # Classic 2:1 pixel isometric
  classic_pixel:
    angle: "pixel"
    tile_width: 64
    tile_height: 32
    depth_sorting: true

  # True isometric
  true_iso:
    angle: "true_isometric"
    tile_width: 64
    tile_height: 64
    depth_sorting: true

  # Strategy game style
  strategy:
    angle: "military"
    tile_width: 64
    tile_height: 64
    depth_sorting: false

side_scroller_presets:
  # Classic 16-bit platformer
  platformer_16bit:
    parallax_layers: 4
    layer_depths: [0.1, 0.3, 0.6, 1.0]
    layer_names: ["sky", "far", "mid", "near"]

  # Simple 2-layer
  simple:
    parallax_layers: 2
    layer_depths: [0.5, 1.0]
    layer_names: ["background", "foreground"]

sprite_sheet_presets:
  # Standard character sheet
  character:
    columns: 8
    rows: 4
    frame_width: 32
    frame_height: 32
    trim: true
    json_format: "phaser"

  # Tile set
  tileset:
    columns: 16
    rows: 16
    frame_width: 16
    frame_height: 16
    trim: false
```

**Tasks**:
1. Create preset file
2. Implement preset loader
3. Update __init__.py
4. Create examples

---

## Acceptance Criteria

- [ ] Isometric camera positions correctly
- [ ] All angle presets work
- [ ] Depth sorting produces correct order
- [ ] Parallax layers separate correctly
- [ ] Sprite sheets generate with metadata
- [ ] Tile maps export correctly
- [ ] Presets load correctly

---

## Files

```
lib/retro/
├── isometric_types.py     # Data structures
├── isometric.py           # Isometric system
├── side_scroller.py       # Side-scroller system
├── sprites.py             # Sprite sheet generation
└── tiles.py               # Tile system

configs/cinematic/retro/
└── view_presets.yaml      # View presets
```
