---
phase: 18.0
plan: 03
subsystem: projector-profile-system
tags: [projector, projection-mapping, exports, pipeline, stages, integration-tests]
requires: [18.0-01, 18.0-02]
provides: [package-exports, stage-pipeline, integration-tests]
affects: []
completed: 2026-02-25
duration: 15 minutes
tech-stack:
  added: []
  patterns: [stage-pipeline, deterministic-seed, dataclass-state]
key-files:
  created:
    - tests/integration/projection/__init__.py
    - tests/integration/projection/test_projector_integration.py
  modified:
    - lib/cinematic/projection/physical/projector/__init__.py
    - lib/cinematic/projection/physical/__init__.py
    - lib/cinematic/projection/physical/stages/__init__.py
---

# Phase 18.0 Plan 03: Package Exports & Integration Summary

## One-liner

Package exports for physical projector module with 5-stage pipeline interface and integration tests.

## Delivered

### 1. Projector Module Exports (`lib/cinematic/projection/physical/projector/__init__.py`)

Complete exports for projector profile system:
- **Types**: ProjectorProfile, ProjectorType, AspectRatio, LensShift, KeystoneCorrection
- **Database**: PROJECTOR_PROFILES, get_profile, list_profiles, get_profiles_by_throw_ratio, get_profiles_by_resolution, get_short_throw_profiles, get_4k_profiles, load_profile_from_yaml
- **Calibration**: throw_ratio_to_focal_length, focal_length_to_throw_ratio, calculate_throw_distance, calculate_image_width, create_projector_camera, configure_render_for_projector, restore_render_settings

Key formula documentation: `focal_length = sensor_width * throw_ratio` (NOT divided by 2)

### 2. Physical Package Re-exports (`lib/cinematic/projection/physical/__init__.py`)

Re-exports all projector module items at package level for convenient access:
```python
from lib.cinematic.projection.physical import get_profile, create_projector_camera
```

### 3. Stage Pipeline Interface (`lib/cinematic/projection/physical/stages/__init__.py`)

5-stage GSD pipeline for projection mapping:

| Stage | Name | Purpose |
|-------|------|---------|
| 0 | Normalize | Profile validation, deterministic seed hashing |
| 1 | Primary | Base frustum setup, projector camera creation |
| 2 | Secondary | Calibration/alignment (Phase 18.1) |
| 3 | Detail | Content mapping, UV projection (Phase 18.2) |
| 4 | Output | Render configuration, export (Phase 18.2) |

Dataclasses:
- `StageContext`: parameters, profile_name, target_id, seed
- `StageState`: stage, profile, camera, target_checksum, calibration_points, errors

Implemented functions:
- `stage_normalize`: Loads profile, computes deterministic seed from inputs
- `stage_primary`: Creates Blender camera from profile (requires bpy)

### 4. Integration Tests (`tests/integration/projection/test_projector_integration.py`)

8 tests in 3 test classes:
- **TestProjectorWorkflow**: profile-to-camera, short-throw, 4K, lens shift
- **TestStagePipeline**: stage_normalize, stage_primary (with Blender detection)
- **TestDeterminism**: same inputs same seed, different inputs different seed

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Deterministic seed via MD5 hash | Pipeline Rick requirement for reproducible calibration |
| ImportError for Blender-only functions | Clear error messages when running outside Blender |
| Stage 2-4 as placeholders | Full implementation in Phase 18.1/18.2 |
| field(default_factory=list) for errors | Prevents mutable default issues in dataclass |

## Verification

- [x] All exports from `lib.cinematic.projection.physical` work
- [x] Stage pipeline interface defined with StageContext and StageState
- [x] Deterministic seed generation in stage_normalize
- [x] Integration tests pass (8/8)
- [x] Unit tests still pass (69/69)
- [x] Version 0.1.0

## Commits

| Hash | Message |
|------|---------|
| 08fa85a | feat(18.0-03): add complete package exports for projector module |
| 06e667b | feat(18.0-03): add complete re-exports for physical projection package |
| b966c3f | feat(18.0-03): add stage pipeline interface for projector mapping |
| de06411 | test(18.0-03): add integration tests for projector profile system |

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

Ready for Phase 18.1 (Calibration System):
- Stage pipeline interface defined
- stage_normalize and stage_primary implemented
- Deterministic seed generation in place
- Integration test framework established

## Statistics

- **Files created**: 2
- **Files modified**: 3
- **Tests added**: 8
- **Exports added**: 24+
- **Duration**: 15 minutes
