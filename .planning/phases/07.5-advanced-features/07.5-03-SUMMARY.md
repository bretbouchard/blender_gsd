# Phase 07.5 Plan 03: Scan Import Summary

## One-Liner
LiDAR/scan import system with PLY/OBJ parsers, RANSAC floor detection, and scale calibration.

## Completed
2026-02-19

## Files Created/Modified

| File | Action | Lines | Purpose |
|------|--------|-------|---------|
| lib/cinematic/tracking/types.py | Modified | +173 | FloorPlane, ScaleCalibration, ScanData dataclasses |
| lib/cinematic/tracking/scan_import.py | Created | +751 | PLY/OBJ parsers, FloorDetector, ScaleDetector, ScanImporter |
| lib/cinematic/tracking/__init__.py | Modified | +28 | New exports (12 symbols) |

**Total:** 952 lines added

## Tasks Completed

### Task 1: Add Scan Types to types.py
Added three dataclasses after RigidBodySolve:
- **FloorPlane** - Detected floor plane with normal, distance, confidence, inlier count, rotation euler
- **ScaleCalibration** - Scale factor from known references (distance, ArUco, object)
- **ScanData** - Imported scan with metadata, bounds, floor, scale calibration

### Task 2: Create scan_import.py
Implemented complete scan import module:
- **SCAN_FORMATS** - Registry of supported formats (ply, obj, pts, xyz)
- **PLYParser** - Stanford PLY parser (ASCII and binary)
- **OBJParser** - Wavefront OBJ parser (vertices, normals, faces)
- **FloorDetector** - RANSAC-based floor plane detection
- **ScaleDetector** - Scale calibration from distances and ArUco markers
- **ScanImporter** - Main import interface with detect_floor, calibrate_scale, align_to_ground
- **import_polycam()** - Convenience function for Polycam scans
- **import_reality_scan()** - Convenience function for RealityCapture/Meta scans

### Task 3: Update __init__.py Exports
Added 12 new exports:
- Types: FloorPlane, ScaleCalibration, ScanData
- Classes: PLYParser, OBJParser, FloorDetector, ScaleDetector, ScanImporter
- Functions: import_polycam, import_reality_scan
- Constants: SCAN_FORMATS

## Verification Results

```python
# Floor detector test
detector = FloorDetector()
floor = detector.detect([(0, 0, 0), (1, 0, 0), (0, 1, 0), (1, 1, 0)])
# Result: normal=(0.0, 0.0, 1.0), confidence=0.00, inliers=4

# Scale detector test
scale_detector = ScaleDetector()
calibration = scale_detector.calibrate_from_distance((0, 0, 0), (1, 0, 0), 1.0)
# Result: scale_factor=1.0, confidence=1.0

# ScanData serialization test
scan = ScanData(name='test', point_count=1000, floor=FloorPlane())
data = scan.to_dict()
restored = ScanData.from_dict(data)
# Result: name=test, points=1000

All tests passed.
```

## Key Implementation Details

### RANSAC Floor Detection
- Samples 3 random points per iteration
- Computes plane normal via cross product
- Normalizes and ensures normal points up (positive Z)
- Optional horizontal bias (abs(nz) >= 0.7)
- Counts inliers within distance threshold
- Computes rotation to align floor to XY plane

### Scale Calibration
- Distance-based: Known distance between two points
- ArUco-based: Average of 4 marker edge lengths
- Confidence inversely proportional to deviation from 1.0

### PLY Parser
- Supports ASCII and binary formats (little/big endian)
- Parses x, y, z vertex coordinates
- Optional color (r, g, b) and normals (nx, ny, nz)
- Handles unknown properties gracefully

### OBJ Parser
- Parses v (vertex), vn (normal), f (face) commands
- Handles various face formats: v, v/vt, v/vt/vn, v//vn
- Supports negative indices
- Returns vertices, normals, and faces

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

**Status:** Ready for Plan 07.5-04 (Mocap Import)

**Integration Points:**
- ScanImporter can be used by backdrop system for LiDAR environments
- Floor alignment prepares scans for Blender import
- Scale calibration ensures real-world proportions

## Metrics

- Duration: ~15 minutes
- Commits: 1
- Lines added: 952
- New exports: 12
