# Phase 6.6 Plan 02: Render Module Summary

**Completed:** 2026-02-18
**Phase:** 06.6-render-system
**Plan:** 02 - Render Module

## Overview

Created `lib/cinematic/render.py` with complete render system implementation including quality tier application, render pass configuration, EXR output setup, hardware-aware denoising, and batch rendering capabilities.

## Tasks Completed

### Task 1: Quality Tier and Pass Configuration

Created render.py with:
- `ENGINES` constant mapping (CYCLES, EEVEE_NEXT, WORKBENCH)
- `PASS_MAPPING` constant (20 pass mappings to view_layer attributes)
- `apply_quality_profile()` - Apply quality presets from YAML
- `apply_render_settings()` - Apply full CinematicRenderSettings
- `set_render_engine()`, `set_resolution()`, `set_frame_range()` - Basic setters

### Task 2: EXR Output and Denoiser Functions

- `setup_exr_output()` - Configure EXR multi-layer output
- `apply_pass_preset()` - Apply pass presets from YAML
- `configure_render_passes()` - Enable passes via view_layer.use_pass_*
- `setup_cryptomatte()` - Configure cryptomatte with levels and accurate mode
- `detect_optimal_denoiser()` - Auto-detect OPTIX vs OPENIMAGEDENOISE
- `enable_denoising()` - Enable denoising with auto-selection

### Task 3: Composite Render Config and Batch Rendering

- `apply_render_config()` - Combined quality + passes + EXR in one call
- `get_render_metadata()` - Get render state dict for shot tracking
- `batch_render()` - Batch rendering with dependency ordering and resume support
- `get_render_settings()` - Get current settings as dict
- `render_frame()` / `render_animation()` - Render execution functions

## Key Files Modified

| File | Lines | Description |
|------|-------|-------------|
| lib/cinematic/render.py | 830 | Complete render system module |
| lib/cinematic/preset_loader.py | 927 | Added render system preset loaders |

## Exports

```python
__all__ = [
    # Quality tier functions
    "apply_quality_profile",
    "apply_render_settings",
    # Render pass functions
    "configure_render_passes",
    "setup_cryptomatte",
    "apply_pass_preset",
    # EXR output functions
    "setup_exr_output",
    # Denoiser functions
    "detect_optimal_denoiser",
    "enable_denoising",
    # Basic settings functions
    "set_render_engine",
    "set_resolution",
    "set_frame_range",
    # Render execution functions
    "render_frame",
    "render_animation",
    "get_render_settings",
    # Composite configuration
    "apply_render_config",
    "get_render_metadata",
    # Batch rendering
    "batch_render",
    # Constants
    "ENGINES",
    "PASS_MAPPING",
    "EXR_CODECS",
    "BLENDER_AVAILABLE",
]
```

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| BLENDER_EEVEE_NEXT not BLENDER_EEVEE | Deprecated in Blender 4.2+, EEVEE Next has raytracing |
| view_layer for pass configuration | Passes are view_layer.use_pass_*, not scene attributes |
| cryptomatte_levels = 6 | Standard levels for object isolation |
| use_pass_cryptomatte_accurate = True | Better object isolation in compositing |
| OPEN_EXR_MULTILAYER for multi-pass | Required for all passes in one file |
| Auto-detect denoiser | OPTIX for NVIDIA, OPENIMAGEDENOISE for Apple/CPU |

## Usage Example

```python
from lib.cinematic.render import (
    apply_render_config,
    get_render_metadata,
    batch_render
)

# Apply complete render configuration
apply_render_config(
    quality_tier="cycles_production",
    pass_group="full_production",
    exr_preset="multi_layer_compositing"
)

# Get metadata for shot tracking
metadata = get_render_metadata()
# Returns: engine, samples, resolution, frame_range, enabled_passes, etc.

# Batch render with dependencies
shots = [
    {"shot": "hero_01", "quality_tier": "cycles_production"},
    {"shot": "hero_02", "depends_on": ["hero_01"], "output_path": "//renders/hero_02/"},
]
results = batch_render(shots, resume_on_failure=True)
```

## Verification

- [x] All constants (ENGINES, PASS_MAPPING, EXR_CODECS) have correct values
- [x] apply_quality_profile() loads and applies profile settings
- [x] configure_render_passes() enables correct view_layer attributes
- [x] setup_exr_output() sets OPEN_EXR_MULTILAYER format
- [x] detect_optimal_denoiser() returns valid denoiser string
- [x] All functions handle BLENDER_AVAILABLE check
- [x] Module exports are complete

## Next Steps

1. Plan 06.6-03: Package Exports + Version Bump
   - Add render module exports to lib/cinematic/__init__.py
   - Bump version to 0.2.3
