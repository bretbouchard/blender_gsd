---
phase: 06.6-render-system
plan: 02
type: execute
wave: 2
depends_on: ["06.6-01"]
files_modified:
  - lib/cinematic/render.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Quality tier presets apply correct engine, resolution, and sample settings"
    - "Render pass groups enable the correct view_layer passes"
    - "Cryptomatte passes are configured with correct levels and accurate mode"
    - "EXR output is configured for multi-layer with correct compression and depth"
    - "Denoiser is auto-selected based on available hardware"
    - "Batch rendering processes multiple shots with dependency ordering"
    - "Render metadata is captured for shot tracking"
  artifacts:
    - path: "lib/cinematic/render.py"
      provides: "Complete render system with quality tiers, passes, EXR, batch"
      min_lines: 400
      exports:
        - apply_quality_tier
        - configure_render_passes
        - configure_exr_output
        - select_denoiser
        - apply_render_config
        - batch_render
        - get_render_metadata
  key_links:
    - from: "lib/cinematic/render.py"
      to: "lib/cinematic/preset_loader.py"
      via: "get_quality_profile, get_pass_preset, get_exr_settings"
      pattern: "get_quality_profile"
    - from: "lib/cinematic/render.py"
      to: "bpy.context.scene.render"
      via: "render settings API"
      pattern: "scene\\.render\\."
    - from: "lib/cinematic/render.py"
      to: "bpy.context.view_layer"
      via: "pass enablement"
      pattern: "view_layer\\.use_pass_"
---

<objective>
Create lib/cinematic/render.py with complete render system implementation

Purpose: Provide render configuration functions for quality tiers, pass groups, EXR output, and batch rendering
Output: Full render.py module with all functions from RESEARCH.md patterns
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Config files
@configs/cinematic/render/quality_profiles.yaml
@configs/cinematic/render/pass_presets.yaml

# Reference implementations (for pattern)
@lib/cinematic/color.py
@lib/cinematic/lighting.py

# Research findings (contains all API patterns)
@.planning/phases/06.6-render-system/06.6-RESEARCH.md

# Prior plan summary (for types/preset loaders)
@.planning/phases/06.6-render-system/06.6-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create render.py with Quality Tier and Pass Configuration</name>
  <files>lib/cinematic/render.py</files>
  <action>
Create lib/cinematic/render.py with quality tier and pass configuration functions.

Follow the pattern from RESEARCH.md exactly:

1. Create module header with docstring describing render system

2. Add try/except import for bpy with BLENDER_AVAILABLE flag

3. Add ENGINES constant mapping:
```python
ENGINES = {
    'CYCLES': 'CYCLES',
    'EEVEE_NEXT': 'BLENDER_EEVEE_NEXT',  # CRITICAL: NOT 'BLENDER_EEVEE'
    'WORKBENCH': 'BLENDER_WORKBENCH'
}
```

4. Add PASS_MAPPING constant (from RESEARCH.md Pattern 2):
   - combined -> use_pass_combined
   - depth -> use_pass_z
   - normal -> use_pass_normal
   - vector -> use_pass_vector
   - diffuse_direct -> use_pass_diffuse_direct
   - diffuse_indirect -> use_pass_diffuse_indirect
   - diffuse_color -> use_pass_diffuse_color
   - glossy_direct -> use_pass_glossy_direct
   - glossy_indirect -> use_pass_glossy_indirect
   - glossy_color -> use_pass_glossy_color
   - transmission_direct -> use_pass_transmission_direct
   - transmission_indirect -> use_pass_transmission_indirect
   - transmission_color -> use_pass_transmission_color
   - emission -> use_pass_emit
   - environment -> use_pass_environment
   - shadow -> use_pass_shadow
   - ao -> use_pass_ambient_occlusion
   - cryptomatte_object -> use_pass_cryptomatte_object
   - cryptomatte_material -> use_pass_cryptomatte_material
   - cryptomatte_asset -> use_pass_cryptomatte_asset

5. Add EXR_CODECS constant (from RESEARCH.md Pattern 3)

6. Implement apply_quality_tier(profile_name: str) -> bool (from RESEARCH.md Pattern 1):
   - Load profile via get_quality_profile()
   - Set engine via ENGINES mapping
   - Set resolution (base and scale)
   - Set samples for Cycles
   - Configure adaptive sampling if present
   - Configure denoiser if present
   - Return True on success

7. Implement configure_render_passes(pass_group: str) -> bool (from RESEARCH.md Pattern 2):
   - Load preset via get_pass_preset()
   - Disable all passes first (clean slate)
   - Enable requested passes via PASS_MAPPING
   - CRITICAL: For cryptomatte passes, set view_layer.cryptomatte_levels = 6 and use_pass_cryptomatte_accurate = True
   - Return True on success

8. All functions must check BLENDER_AVAILABLE and raise RuntimeError if not available.

Follow the exact pattern from color.py for bpy availability checking.
  </action>
  <verify>python3 -c "from lib.cinematic.render import apply_quality_tier, configure_render_passes, ENGINES, PASS_MAPPING; print(len(PASS_MAPPING))"</verify>
  <done>apply_quality_tier() and configure_render_passes() functions available with correct constants</done>
</task>

<task type="auto">
  <name>Task 2: Add EXR Output and Denoiser Selection Functions</name>
  <files>lib/cinematic/render.py</files>
  <action>
Add EXR output and denoiser selection functions to lib/cinematic/render.py:

1. Implement select_denoiser() -> str (from RESEARCH.md Pattern 4):
   - Check OptiX availability via _has_optix() helper
   - Check Apple Silicon via _is_apple_silicon() helper
   - Return 'OPTIX' for NVIDIA, 'OPENIMAGEDENOISE' for Apple/CPU
   - Helper functions:
     - _has_optix(): Check bpy.context.preferences.addons['cycles'].preferences.compute_device_type
     - _is_apple_silicon(): Check platform.processor() == 'arm'

2. Implement configure_exr_output(preset_name: str = 'multi_layer_compositing') -> bool (from RESEARCH.md Pattern 3):
   - Load preset via get_exr_settings()
   - Set file_format = 'OPEN_EXR_MULTILAYER' (NOT 'OPEN_EXR')
   - Set exr_codec via EXR_CODECS mapping
   - Set color_depth as string
   - Enable use_preview
   - Set film_transparent = True
   - Return True on success

3. Add these after the pass configuration function, in a logical order.

All functions must handle BLENDER_AVAILABLE check.
  </action>
  <verify>python3 -c "from lib.cinematic.render import select_denoiser, configure_exr_output, EXR_CODECS; print(list(EXR_CODECS.keys()))"</verify>
  <done>select_denoiser() and configure_exr_output() functions available</done>
</task>

<task type="auto">
  <name>Task 3: Add Composite Render Config and Batch Rendering Functions</name>
  <files>lib/cinematic/render.py</files>
  <action>
Add composite render config and batch rendering functions to lib/cinematic/render.py:

1. Implement apply_render_config(quality_tier, pass_group, exr_preset) -> bool (from RESEARCH.md Code Examples):
   - Call apply_quality_tier(quality_tier)
   - Call configure_render_passes(pass_group)
   - Call configure_exr_output(exr_preset)
   - Return True on success

2. Implement get_render_metadata() -> Dict[str, Any]:
   - Return dict with:
     - engine: scene.render.engine
     - samples: scene.cycles.samples (if Cycles)
     - resolution: f"{x}x{y}"
     - quality_tier: from active profile
     - pass_group: from active preset
     - film_transparent: scene.render.film_transparent
     - frame_range: f"{start}-{end}"
     - fps: scene.render.fps
   - Handle BLENDER_AVAILABLE check

3. Implement batch_render(shots, parallel_jobs=1, resume_on_failure=True) -> Dict[str, bool] (from RESEARCH.md Code Examples):
   - Accept list of shot configs with 'shot' and 'depends_on' keys
   - Check dependencies before rendering each shot
   - Check if output already exists (resume support)
   - Return dict mapping shot names to success status
   - Note: parallel_jobs parameter for future implementation, currently single-threaded

4. Add at module level the list of exports in __all__ following the pattern from other modules.
  </action>
  <verify>python3 -c "from lib.cinematic.render import apply_render_config, get_render_metadata, batch_render; print('imports ok')"</verify>
  <done>apply_render_config(), get_render_metadata(), batch_render() functions available</done>
</task>

</tasks>

<verification>
1. Verify all constants (ENGINES, PASS_MAPPING, EXR_CODECS) have correct values
2. Verify apply_quality_tier() loads and applies profile settings
3. Verify configure_render_passes() enables correct view_layer attributes
4. Verify configure_exr_output() sets OPEN_EXR_MULTILAYER format
5. Verify select_denoiser() returns valid denoiser string
6. Verify all functions handle BLENDER_AVAILABLE check
7. Verify module exports are complete
</verification>

<success_criteria>
- lib/cinematic/render.py exists with ~400+ lines
- apply_quality_tier() applies engine, resolution, samples, denoiser
- configure_render_passes() enables passes including cryptomatte setup
- configure_exr_output() sets multi-layer EXR with compression
- select_denoiser() returns hardware-appropriate denoiser
- apply_render_config() combines all configuration functions
- get_render_metadata() returns render state dict
- batch_render() processes shots with dependency ordering
- All functions check BLENDER_AVAILABLE
</success_criteria>

<output>
After completion, create `.planning/phases/06.6-render-system/06.6-02-SUMMARY.md`
</output>
