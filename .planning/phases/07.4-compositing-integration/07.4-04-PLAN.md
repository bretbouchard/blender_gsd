---
phase: 07.4-compositing-integration
plan: 04
type: execute
wave: 3
depends_on: ["07.4-03"]
files_modified:
  - lib/cinematic/shot.py
  - configs/cinematic/tracking/composite_presets.yaml
autonomous: true

must_haves:
  truths:
    - "Shadow catcher material works with film transparent"
    - "Shadow pass is available in compositor"
    - "Composite presets can be loaded from YAML"
  artifacts:
    - path: "lib/cinematic/shot.py"
      provides: "Extended with tracking integration hooks"
      contains: "assemble_shot_with_tracking integration"
    - path: "configs/cinematic/tracking/composite_presets.yaml"
      provides: "Composite mode presets"
      contains: "over_footage, multiply, screen presets"
  key_links:
    - from: "lib/cinematic/shot.py"
      to: "lib/cinematic/tracking/shot_integration.py"
      via: "assemble_shot_with_tracking"
      pattern: "from.*shot_integration import.*assemble_shot_with_tracking"
---

<objective>
Extend shot.py with shadow catcher workflow and add composite presets.

Purpose: Complete the integration by extending the main shot assembly module with tracking hooks and providing ready-to-use composite presets.

Output: Extended lib/cinematic/shot.py with tracking support, new configs/cinematic/tracking/composite_presets.yaml.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.4-compositing-integration/07.4-RESEARCH.md

# Existing modules
@lib/cinematic/shot.py
@lib/cinematic/backdrops.py
@lib/cinematic/tracking/compositor.py
@lib/cinematic/tracking/shot_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shadow catcher workflow to shot.py</name>
  <files>lib/cinematic/shot.py</files>
  <action>
Extend shot.py with shadow catcher support:

1. Add `setup_shadow_catcher(config, scene)` function:
   - Create shadow catcher material with CLIP shadow method
   - Create ground plane with shadow catcher material
   - Configure render settings for transparent film
   - Enable shadow pass in view layer
   - Pattern from RESEARCH section 5.1-5.3

2. Modify `assemble_shot()` to check for shadow_catcher config:
   ```python
   # After backdrop creation
   if config.get('composite', {}).get('shadow_catcher'):
       result['shadow_catcher'] = setup_shadow_catcher(config, scene)
   ```

3. Add `ShadowCatcherConfig` dataclass (or inline in ShotAssemblyConfig):
   ```python
   @dataclass
   class ShadowCatcherConfig:
       enabled: bool = False
       ground_size: float = 10.0
       ground_location: Tuple[float, float, float] = (0, 0, 0)
       receive_shadows: bool = True
       shadow_only: bool = True
   ```

Shadow catcher material pattern from RESEARCH:
```python
mat = bpy.data.materials.new(name="ShadowCatcher")
mat.use_nodes = True
mat.shadow_method = 'CLIP'  # Blender 4.x

# For film transparent
scene.render.film_transparent = True
view_layer.use_pass_shadow = True
```
  </action>
  <verify>Shadow catcher ground plane created with proper material when enabled</verify>
  <done>Shadow catcher workflow integrated into shot assembly</done>
</task>

<task type="auto">
  <name>Task 2: Add tracking integration hooks to shot.py</name>
  <files>lib/cinematic/shot.py</files>
  <action>
Extend shot.py with tracking integration:

1. Add import for shot_integration (with try/except guard):
   ```python
   try:
       from .tracking.shot_integration import (
           assemble_shot_with_tracking,
           TrackingShotConfig,
           CompositeShotConfig,
           FootageConfig
       )
       TRACKING_AVAILABLE = True
   except ImportError:
       TRACKING_AVAILABLE = False
   ```

2. Modify `load_shot_yaml()` to parse tracking config:
   - Check for 'footage' key in YAML
   - Check for 'tracking' key in YAML
   - Check for 'composite' key in YAML
   - Parse into config objects

3. Add `assemble_tracked_shot()` convenience function:
   ```python
   def assemble_tracked_shot(yaml_path: Path, scene: Any = None) -> Dict[str, Any]:
       """Load and assemble shot with tracking support."""
       config = load_shot_yaml(yaml_path)

       if config.get('tracking', {}).get('enabled') and TRACKING_AVAILABLE:
           return assemble_shot_with_tracking(config, scene)
       else:
           return assemble_shot(config, scene)
   ```

4. Update `ShotAssemblyConfig` to include optional tracking fields:
   - `footage: Optional[FootageConfig] = None`
   - `tracking: Optional[TrackingShotConfig] = None`
   - `composite: Optional[CompositeShotConfig] = None`
   </action>
  <verify>load_shot_yaml parses tracking config, assemble_tracked_shot works</verify>
  <done>Shot assembly extended with tracking hooks</done>
</task>

<task type="auto">
  <name>Task 3: Create composite_presets.yaml configuration</name>
  <files>configs/cinematic/tracking/composite_presets.yaml</files>
  <action>
Create composite presets YAML file:

```yaml
# Composite Mode Presets for Tracked Shot Assembly
# These presets configure how CG renders composite over footage

presets:
  # Standard CG over footage
  over_footage:
    name: "CG Over Footage"
    description: "Standard compositing with CG rendered over background footage"
    mode: "over_footage"
    background_source: "footage"
    shadow_catcher: true
    film_transparent: true
    lens_distortion:
      apply_to_cg: true

  # Static image plate
  over_plate:
    name: "CG Over Plate"
    description: "Composite CG over static background image"
    mode: "over_footage"
    background_source: "image"
    shadow_catcher: true
    film_transparent: true

  # Multiply blend for shadows only
  shadow_multiply:
    name: "Shadow Multiply"
    description: "CG shadows multiplied over background"
    mode: "multiply"
    background_source: "footage"
    shadow_catcher: true
    film_transparent: false

  # Additive glow
  additive_glow:
    name: "Additive Glow"
    description: "CG added to background for light/glow effects"
    mode: "add"
    background_source: "footage"
    shadow_catcher: false
    film_transparent: true

  # Screen blend
  screen_blend:
    name: "Screen Blend"
    description: "Screen blend mode for light compositing"
    mode: "screen"
    background_source: "footage"
    shadow_catcher: false
    film_transparent: true

  # Lens distortion workflow
  with_distortion:
    name: "With Lens Distortion"
    description: "Apply lens distortion to CG before compositing"
    mode: "over_footage"
    background_source: "footage"
    shadow_catcher: true
    film_transparent: true
    lens_distortion:
      apply_to_cg: true
      use_st_map: true

  # Stabilized composite
  stabilized:
    name: "Stabilized Composite"
    description: "Stabilize footage before compositing CG"
    mode: "over_footage"
    background_source: "footage"
    shadow_catcher: true
    film_transparent: true
    stabilization:
      enabled: true
      tracks: "all"
```

Also add a preset loader function reference comment pointing to lib/cinematic/tracking/compositor.py
  </action>
  <verify>YAML file is valid and parseable</verify>
  <done>7 composite presets available for shot configuration</done>
</task>

<task type="auto">
  <name>Task 4: Add preset loader for composite configs</name>
  <files>lib/cinematic/tracking/compositor.py</files>
  <action>
Add composite preset loading to compositor.py:

1. Add preset loader function:
   ```python
   def load_composite_preset(preset_name: str) -> CompositeConfig:
       """Load composite preset from YAML.

       Args:
           preset_name: Name of preset (over_footage, shadow_multiply, etc.)

       Returns:
           CompositeConfig with preset values

       Raises:
           FileNotFoundError: If preset file doesn't exist
           KeyError: If preset name not found
       """
       preset_path = Path("configs/cinematic/tracking/composite_presets.yaml")
       if not preset_path.exists():
           raise FileNotFoundError(f"Preset file not found: {preset_path}")

       with open(preset_path) as f:
           data = yaml.safe_load(f)

       presets = data.get('presets', {})
       if preset_name not in presets:
           raise KeyError(f"Preset '{preset_name}' not found. Available: {list(presets.keys())}")

       return CompositeConfig.from_dict(presets[preset_name])
   ```

2. Add to __all__ exports

3. Update docstring with available presets list
  </action>
  <verify>load_composite_preset("over_footage") returns valid CompositeConfig</verify>
  <done>Composite presets loadable from YAML configuration</done>
</task>

</tasks>

<verification>
- Shadow catcher creates ground plane with proper material
- Tracking config parsed from shot YAML
- Composite presets loaded from YAML
- assemble_tracked_shot function works correctly
</verification>

<success_criteria>
- shot.py extended with shadow catcher and tracking hooks
- 7 composite presets available in composite_presets.yaml
- Single function call produces tracked composite shot
</success_criteria>

<output>
After completion, create `.planning/phases/07.4-compositing-integration/07.4-04-SUMMARY.md`
</output>
