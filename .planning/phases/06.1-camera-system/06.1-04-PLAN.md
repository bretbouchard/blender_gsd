---
phase: 06.1-camera-system
plan: 04
type: execute
wave: 3
depends_on: ["06.1-02", "06.1-03"]
enables: ["06.1-05"]
test_coverage: 80%
oracle_validators: ["compare_numbers", "compare_within_range"]
universal_stages:
  normalize: "Load ImperfectionConfig and validate values"
  primary: "Setup compositor node tree for lens effects"
  secondary: "Apply effects in correct pipeline order (geometric -> luminance -> color -> film)"
  detail: "Configure bokeh shape via aperture blades"
  output: "Return configured compositor nodes"
files_modified:
  - lib/cinematic/lenses.py
  - lib/cinematic/__init__.py
autonomous: true

must_haves:
  truths:
    - "Lens imperfections can be applied via compositor nodes"
    - "Compositor pipeline order is correct (geometric -> luminance -> color -> film)"
    - "Lens presets can be loaded and applied to cameras"
    - "Bokeh shape can be configured via aperture blades"
  artifacts:
    - path: "lib/cinematic/lenses.py"
      provides: "Lens system and imperfection effects"
      exports: ["apply_lens_imperfections", "setup_compositor_for_lens", "get_bokeh_blade_count", "clear_lens_effects", "apply_imperfection_preset"]
      min_lines: 150
  key_links:
    - from: "lib/cinematic/lenses.py"
      to: "bpy.context.scene.node_tree"
      via: "Compositor nodes"
      pattern: "scene\\.node_tree|scene\\.use_nodes"
    - from: "lib/cinematic/lenses.py"
      to: "lib/cinematic/types.py"
      via: "ImperfectionConfig import"
      pattern: "from.*types import.*ImperfectionConfig"
---

<objective>
Create lenses.py module for lens system and imperfection effects.

Purpose: Implement lens imperfections (vignette, chromatic aberration, flare) via Blender compositor. Apply lens presets and bokeh configuration. Follow correct compositor pipeline order.

Output: lenses.py module with 5+ exported functions, updated __init__.py exports.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 6.1 Summaries
@.planning/phases/06.1-camera-system/06.1-01-SUMMARY.md
@.planning/phases/06.1-camera-system/06.1-02-SUMMARY.md

# Existing codebase
@lib/cinematic/types.py
@lib/cinematic/preset_loader.py

# Research with compositor pipeline order
@.planning/phases/06.1-camera-system/06.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lenses.py module</name>
  <files>lib/cinematic/lenses.py</files>
  <action>
Create lib/cinematic/lenses.py with lens system functions.

**CRITICAL COMPOSITOR PIPELINE ORDER (from research):**
1. Geometric distortions (chromatic aberration, lens distortion)
2. Luminance effects (glare, bloom)
3. Color grading
4. Film effects (grain, vignette)

Module structure:

```python
"""
Lens System Module

Provides lens imperfections via compositor nodes.
Follows correct pipeline order: geometric -> luminance -> color -> film
"""

from __future__ import annotations
from typing import Optional, Any, Dict
from pathlib import Path

from .types import ImperfectionConfig
from .preset_loader import get_imperfection_preset

try:
    import bpy
    BLENDER_AVAILABLE = True
except ImportError:
    bpy = None
    BLENDER_AVAILABLE = False
```

Functions to implement:

1. `setup_compositor_for_lens() -> bool`
   - Enable scene.use_nodes = True
   - Get or create compositor node tree
   - Ensure Render Layers and Composite nodes exist
   - Return True on success

2. `apply_lens_imperfections(config: ImperfectionConfig) -> bool`
   - Setup compositor if needed
   - Apply effects in correct order:
     - Chromatic aberration (if > 0): Use LensDistortion node with dispersion
     - Vignette (if > 0): Create elliptical mask, invert, multiply with image
     - Flare (if enabled): Use Glare node with fog glow type
   - Connect nodes properly in pipeline
   - Return True on success

3. `get_bokeh_blade_count(shape: str) -> int`
   - Map shape name to blade count:
     - "circular" -> 0 (circular aperture)
     - "hexagonal" -> 6
     - "octagonal" -> 8
     - "rounded" -> 9 (rounded octagon)
   - Return count for use with camera.dof.aperture_blades

4. `clear_lens_effects() -> bool`
   - Remove all lens-related compositor nodes
   - Keep only Render Layers and Composite
   - Return True on success

5. `apply_imperfection_preset(preset_name: str) -> bool`
   - Load preset using get_imperfection_preset()
   - Create ImperfectionConfig from preset data
   - Call apply_lens_imperfections()
   - Return True on success

6. `apply_bokeh_to_camera(camera_name: str, shape: str) -> bool`
   - Get camera by name
   - Get blade count from get_bokeh_blade_count()
   - Set camera.data.dof.aperture_blades
   - Return True on success

COMPOSITOR NODE EXAMPLES (from research):
```python
# Enable compositor
scene.use_nodes = True
tree = scene.node_tree

# Get render layers node
render_layers = tree.nodes.get('Render Layers')
if not render_layers:
    render_layers = tree.nodes.new('CompositorNodeRLayers')

# Add lens distortion for chromatic aberration
lens_distort = tree.nodes.new('CompositorNodeLensdist')
lens_distort.use_fit = False
lens_distort.use_jitter = False
lens_distort.use_projector = False

# Add vignette (mask + invert + mix)
mask = tree.nodes.new('CompositorNodeEllipseMask')
invert = tree.nodes.new('CompositorNodeInvert')
mix = tree.nodes.new('CompositorNodeMixRGB')
```

COMMON PITFALLS:
- Always check scene.use_nodes before accessing node_tree
- Connect nodes in correct order (link inputs to outputs)
- Don't create duplicate nodes - check if they exist first
</action>
  <verify>
python3 -c "
from lib.cinematic.lenses import (
    setup_compositor_for_lens, apply_lens_imperfections,
    get_bokeh_blade_count, clear_lens_effects,
    apply_imperfection_preset, apply_bokeh_to_camera,
    BLENDER_AVAILABLE
)
from lib.cinematic.types import ImperfectionConfig

print(f'BLENDER_AVAILABLE: {BLENDER_AVAILABLE}')

# Test bokeh blade count mapping
assert get_bokeh_blade_count('circular') == 0
assert get_bokeh_blade_count('hexagonal') == 6
assert get_bokeh_blade_count('octagonal') == 8
assert get_bokeh_blade_count('rounded') == 9
print('Bokeh blade counts correct')

# Test config creation
config = ImperfectionConfig(
    name='test',
    vignette=0.2,
    chromatic_aberration=0.001,
    flare_enabled=True,
    flare_intensity=0.3
)
print(f'ImperfectionConfig: vignette={config.vignette}')

# Test functions outside Blender (should return False)
result = setup_compositor_for_lens()
print(f'setup_compositor_for_lens: {result} (expected False outside Blender)')

result = apply_lens_imperfections(config)
print(f'apply_lens_imperfections: {result} (expected False outside Blender)')

print('All lenses functions importable')
"
</verify>
  <done>Lenses module with 6 functions created, compositor pipeline order correct, bokeh mapping implemented</done>
</task>

<task type="auto">
  <name>Task 2: Update __init__.py with lenses exports</name>
  <files>lib/cinematic/__init__.py</files>
  <action>
Update lib/cinematic/__init__.py to export lenses module functions:

1. Add imports from .lenses:
   - setup_compositor_for_lens
   - apply_lens_imperfections
   - get_bokeh_blade_count
   - clear_lens_effects
   - apply_imperfection_preset
   - apply_bokeh_to_camera

2. Add to __all__ list

3. Update module docstring to mention lenses module
</action>
  <verify>
python3 -c "
from lib.cinematic import (
    setup_compositor_for_lens, apply_lens_imperfections,
    get_bokeh_blade_count, clear_lens_effects,
    apply_imperfection_preset, apply_bokeh_to_camera
)
print('All lenses functions exported from lib.cinematic')
"
</verify>
  <done>All lenses functions exported from lib.cinematic package</done>
</task>

</tasks>

<verification>
1. lenses.py module exists with 6 exported functions
2. Compositor pipeline order correct (geometric -> luminance -> color -> film)
3. Bokeh blade count mapping works for all shapes
4. ImperfectionConfig properly used
5. All bpy access guarded
6. All functions exported from lib.cinematic
</verification>

<success_criteria>
- Lenses module functional with guarded bpy access
- All 6 functions implemented and exported
- Compositor pipeline order correct
- Bokeh shape mapping works
- Works outside Blender for testing
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-camera-system/06.1-04-SUMMARY.md`
</output>
