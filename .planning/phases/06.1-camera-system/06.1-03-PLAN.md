---
phase: 06.1-camera-system
plan: 03
type: execute
wave: 2
depends_on: ["06.1-01"]
enables: ["06.1-04", "06.1-05"]
test_coverage: 80%
oracle_validators: ["compare_numbers", "compare_vectors", "compare_within_range"]
universal_stages:
  normalize: "Load PlumbBobConfig and validate mode/focus_mode"
  primary: "Calculate target position from auto/manual/object mode"
  secondary: "Create target empty and calculate focus distance"
  detail: "Handle focus_mode (auto/manual) for focus distance"
  output: "Return target empty object for rig connection"
files_modified:
  - lib/cinematic/plumb_bob.py
  - lib/cinematic/__init__.py
autonomous: true

must_haves:
  truths:
    - "Plumb bob target can be calculated from subject bounding box in auto mode"
    - "Plumb bob target can be set manually with explicit coordinates"
    - "Plumb bob target can reference another object by name"
    - "Focus distance is correctly calculated from camera to target"
    - "Focus mode (auto/manual) controls how focus distance is determined"
    - "Plumb bob target connects to camera rig setup"
  artifacts:
    - path: "lib/cinematic/plumb_bob.py"
      provides: "Plumb bob targeting system"
      exports: ["calculate_plumb_bob", "create_target_empty", "calculate_focus_distance", "set_camera_focus_target", "remove_target_empty", "get_or_create_target", "apply_plumb_bob_to_rig"]
      min_lines: 150
  key_links:
    - from: "lib/cinematic/plumb_bob.py"
      to: "lib/cinematic/types.py"
      via: "PlumbBobConfig import"
      pattern: "from.*types import.*PlumbBobConfig"
    - from: "lib/cinematic/plumb_bob.py"
      to: "bpy.data.objects"
      via: "Empty creation for target"
      pattern: "bpy\\.data\\.objects\\.new.*empty"
    - from: "lib/cinematic/plumb_bob.py"
      to: "lib/cinematic/camera.py"
      via: "Focus mode handling"
      pattern: "set_focus_mode|focus_distance"
---

<objective>
Create plumb_bob.py module for orbit/focus targeting system.

Purpose: Implement plumb bob targeting that allows cameras to orbit around and focus on a calculated or specified point. Supports auto (bounding box center), manual (explicit coords), and object (reference by name) modes. Handles focus_mode (auto/manual) for focus distance control. Connects to rig setup workflow.

Output: plumb_bob.py module with 7+ exported functions, updated __init__.py exports.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 6.1 Plan 01 Summary
@.planning/phases/06.1-camera-system/06.1-01-SUMMARY.md

# Existing codebase patterns
@lib/cinematic/types.py
@lib/cinematic/state_manager.py

# Research findings with plumb bob algorithm
@.planning/phases/06.1-camera-system/06.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plumb_bob.py module</name>
  <files>lib/cinematic/plumb_bob.py</files>
  <action>
Create lib/cinematic/plumb_bob.py with plumb bob targeting functions.

**CRITICAL:** All bpy access must be guarded. Follow state_manager.py patterns.

Module structure:

```python
"""
Plumb Bob Targeting System

Provides orbit/focus targeting for cameras.
Supports auto (bounding box), manual (explicit), and object modes.
Handles focus_mode (auto/manual) for focus distance control.
Connects to camera rig setup workflow.
"""

from __future__ import annotations
from typing import Optional, Tuple, Literal, Any
from pathlib import Path

from .types import PlumbBobConfig

# Guarded imports
try:
    import bpy
    from mathutils import Vector
    BLENDER_AVAILABLE = True
except ImportError:
    bpy = None
    Vector = None
    BLENDER_AVAILABLE = False
```

Functions to implement (from research document):

1. `calculate_plumb_bob(subject_name: str, config: PlumbBobConfig) -> Optional[Tuple[float, float, float]]`
   - subject_name: Name of subject object in scene
   - config: PlumbBobConfig with mode and parameters
   - Returns: World position tuple (x, y, z) or None
   - Algorithm:
     - If mode == "manual": return manual_position + offset
     - If mode == "object": get target object by name, return world position + offset
     - If mode == "auto": calculate bounding box center, convert to world space, add offset
   - Guard all bpy access

2. `create_target_empty(position: Tuple[float, float, float], name: str = "plumb_bob_target") -> Optional[Any]`
   - Create empty object at position
   - Use 'PLAIN_AXES' display type
   - Link to scene collection
   - Return empty object or None

3. `calculate_focus_distance(camera_name: str, target: Tuple[float, float, float]) -> float`
   - Get camera world position from matrix_world
   - Calculate distance to target
   - Return distance in meters
   - Return 0.0 if Blender not available

4. `set_camera_focus_target(camera_name: str, target_position: Tuple[float, float, float], config: PlumbBobConfig) -> float`
   - Get camera object by name
   - Handle focus_mode:
     - If config.focus_mode == "manual": Use config.focus_distance directly
     - If config.focus_mode == "auto": Calculate distance from camera to target_position
   - Set camera.data.dof.focus_distance to the determined value
   - Set camera.data.dof.use_dof = True
   - Return the focus distance used

5. `remove_target_empty(name: str = "plumb_bob_target") -> bool`
   - Remove empty object by name
   - Also remove from bpy.data.objects
   - Return True if removed, False if not found

6. `get_or_create_target(subject_name: str, config: PlumbBobConfig) -> Optional[Any]`
   - Convenience function that:
     - Calculates plumb bob position
     - Creates or updates target empty
     - Returns the empty object

7. `apply_plumb_bob_to_rig(camera_name: str, subject_name: str, config: PlumbBobConfig) -> Optional[Any]`
   - Complete workflow for connecting plumb bob to camera rig:
     1. Calculate plumb bob position using calculate_plumb_bob()
     2. Create/update target empty using get_or_create_target()
     3. Set camera focus target using set_camera_focus_target()
   - Returns the target empty object or None
   - This function is the primary entry point for the plumb bob -> rig workflow
   - Guard all bpy access

KEY ALGORITHM (from research):
```python
# Auto mode: Calculate bounding box center
bbox = subject.bound_box  # 8 corners in local space

center = Vector((
    sum(v[0] for v in bbox) / 8,
    sum(v[1] for v in bbox) / 8,
    sum(v[2] for v in bbox) / 8
))

# Convert to world space
world_center = subject.matrix_world @ center
```

FOCUS MODE HANDLING:
```python
# In set_camera_focus_target:
if config.focus_mode == "manual":
    # Use explicit focus distance from config
    focus_dist = config.focus_distance
elif config.focus_mode == "auto":
    # Calculate from camera position to target
    cam_pos = camera.matrix_world.translation
    target_vec = Vector(target_position)
    focus_dist = (target_vec - cam_pos).length
else:
    raise ValueError(f"Unknown focus_mode: {config.focus_mode}")

camera.data.dof.focus_distance = focus_dist
camera.data.dof.use_dof = True
```

COMMON PITFALLS:
- Use matrix_world @ Vector() for world space conversion
- Guard bpy.context.scene access
- Return None/0.0 gracefully when Blender unavailable
- Handle both focus_mode values correctly
</action>
  <verify>
python3 -c "
from lib.cinematic.plumb_bob import (
    calculate_plumb_bob, create_target_empty, calculate_focus_distance,
    set_camera_focus_target, remove_target_empty, get_or_create_target,
    apply_plumb_bob_to_rig,
    BLENDER_AVAILABLE
)
from lib.cinematic.types import PlumbBobConfig

print(f'BLENDER_AVAILABLE: {BLENDER_AVAILABLE}')

# Test config creation with focus_mode
config = PlumbBobConfig(mode='manual', manual_position=(1.0, 2.0, 3.0))
print(f'PlumbBobConfig: mode={config.mode}, pos={config.manual_position}')
print(f'focus_mode={config.focus_mode}, focus_distance={config.focus_distance}')

# Test with manual focus mode
manual_config = PlumbBobConfig(
    mode='manual',
    manual_position=(1.0, 2.0, 3.0),
    focus_mode='manual',
    focus_distance=5.0
)
print(f'Manual focus config: focus_mode={manual_config.focus_mode}, distance={manual_config.focus_distance}')

# Test auto focus mode
auto_config = PlumbBobConfig(mode='auto', offset=(0, 0, 0.5), focus_mode='auto')
print(f'Auto focus config: mode={auto_config.mode}, focus_mode={auto_config.focus_mode}')

# Test calculation outside Blender (should return None)
result = calculate_plumb_bob('subject', config)
print(f'calculate_plumb_bob returned: {result} (expected None outside Blender)')

# Test apply_plumb_bob_to_rig outside Blender
rig_result = apply_plumb_bob_to_rig('camera', 'subject', config)
print(f'apply_plumb_bob_to_rig returned: {rig_result} (expected None outside Blender)')

print('All plumb_bob functions importable')
"
</verify>
  <done>Plumb bob module with 7 functions created, focus_mode handling, all bpy access guarded, rig workflow connection implemented</done>
</task>

<task type="auto">
  <name>Task 2: Update __init__.py with plumb_bob exports</name>
  <files>lib/cinematic/__init__.py</files>
  <action>
Update lib/cinematic/__init__.py to export plumb_bob module functions:

1. Add imports from .plumb_bob:
   - calculate_plumb_bob
   - create_target_empty
   - calculate_focus_distance
   - set_camera_focus_target
   - remove_target_empty
   - get_or_create_target
   - apply_plumb_bob_to_rig

2. Add to __all__ list

3. Update module docstring to mention plumb_bob module
</action>
  <verify>
python3 -c "
from lib.cinematic import (
    calculate_plumb_bob, create_target_empty, calculate_focus_distance,
    set_camera_focus_target, remove_target_empty, get_or_create_target,
    apply_plumb_bob_to_rig
)
print('All plumb_bob functions exported from lib.cinematic')
"
</verify>
  <done>All plumb_bob functions including apply_plumb_bob_to_rig exported from lib.cinematic package</done>
</task>

</tasks>

<verification>
1. plumb_bob.py module exists with 7 exported functions
2. calculate_plumb_bob supports auto/manual/object modes
3. Bounding box center calculation correct (sum/8, matrix_world conversion)
4. Focus distance calculation uses world space positions
5. Focus mode (auto/manual) handling implemented in set_camera_focus_target
6. apply_plumb_bob_to_rig provides complete workflow for rig connection
7. All bpy access guarded
8. All functions exported from lib.cinematic
</verification>

<success_criteria>
- Plumb bob module functional with guarded bpy access
- All 7 functions implemented and exported
- Three targeting modes (auto/manual/object) working
- Focus mode (auto/manual) handling working
- Rig workflow connection via apply_plumb_bob_to_rig
- Works outside Blender for testing
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-camera-system/06.1-03-SUMMARY.md`
</output>
