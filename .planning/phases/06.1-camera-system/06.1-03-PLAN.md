---
phase: 06.1-camera-system
plan: 03
type: execute
wave: 2
depends_on: ["06.1-01"]
files_modified:
  - lib/cinematic/plumb_bob.py
  - lib/cinematic/__init__.py
autonomous: true

must_haves:
  truths:
    - "Plumb bob target can be calculated from subject bounding box in auto mode"
    - "Plumb bob target can be set manually with explicit coordinates"
    - "Plumb bob target can reference another object by name"
    - "Focus distance is correctly calculated from camera to target"
  artifacts:
    - path: "lib/cinematic/plumb_bob.py"
      provides: "Plumb bob targeting system"
      exports: ["calculate_plumb_bob", "create_target_empty", "calculate_focus_distance", "set_camera_focus_target", "remove_target_empty"]
      min_lines: 120
  key_links:
    - from: "lib/cinematic/plumb_bob.py"
      to: "lib/cinematic/types.py"
      via: "PlumbBobConfig import"
      pattern: "from.*types import.*PlumbBobConfig"
    - from: "lib/cinematic/plumb_bob.py"
      to: "bpy.data.objects"
      via: "Empty creation for target"
      pattern: "bpy\\.data\\.objects\\.new.*empty"
---

<objective>
Create plumb_bob.py module for orbit/focus targeting system.

Purpose: Implement plumb bob targeting that allows cameras to orbit around and focus on a calculated or specified point. Supports auto (bounding box center), manual (explicit coords), and object (reference by name) modes.

Output: plumb_bob.py module with 5+ exported functions, updated __init__.py exports.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 6.1 Plan 01 Summary
@.planning/phases/06.1-camera-system/06.1-01-SUMMARY.md

# Existing codebase patterns
@lib/cinematic/types.py
@lib/cinematic/state_manager.py

# Research findings with plumb bob algorithm
@.planning/phases/06.1-camera-system/06.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plumb_bob.py module</name>
  <files>lib/cinematic/plumb_bob.py</files>
  <action>
Create lib/cinematic/plumb_bob.py with plumb bob targeting functions.

**CRITICAL:** All bpy access must be guarded. Follow state_manager.py patterns.

Module structure:

```python
"""
Plumb Bob Targeting System

Provides orbit/focus targeting for cameras.
Supports auto (bounding box), manual (explicit), and object modes.
"""

from __future__ import annotations
from typing import Optional, Tuple, Literal, Any
from pathlib import Path

from .types import PlumbBobConfig

# Guarded imports
try:
    import bpy
    from mathutils import Vector
    BLENDER_AVAILABLE = True
except ImportError:
    bpy = None
    Vector = None
    BLENDER_AVAILABLE = False
```

Functions to implement (from research document):

1. `calculate_plumb_bob(subject_name: str, config: PlumbBobConfig) -> Optional[Tuple[float, float, float]]`
   - subject_name: Name of subject object in scene
   - config: PlumbBobConfig with mode and parameters
   - Returns: World position tuple (x, y, z) or None
   - Algorithm:
     - If mode == "manual": return manual_position + offset
     - If mode == "object": get target object by name, return world position + offset
     - If mode == "auto": calculate bounding box center, convert to world space, add offset
   - Guard all bpy access

2. `create_target_empty(position: Tuple[float, float, float], name: str = "plumb_bob_target") -> Optional[Any]`
   - Create empty object at position
   - Use 'PLAIN_AXES' display type
   - Link to scene collection
   - Return empty object or None

3. `calculate_focus_distance(camera_name: str, target: Tuple[float, float, float]) -> float`
   - Get camera world position from matrix_world
   - Calculate distance to target
   - Return distance in meters
   - Return 0.0 if Blender not available

4. `set_camera_focus_target(camera_name: str, target_position: Tuple[float, float, float]) -> bool`
   - Get camera object by name
   - Calculate focus distance
   - Set camera.data.dof.focus_distance
   - Set camera.data.dof.use_dof = True
   - Return True on success

5. `remove_target_empty(name: str = "plumb_bob_target") -> bool`
   - Remove empty object by name
   - Also remove from bpy.data.objects
   - Return True if removed, False if not found

6. `get_or_create_target(subject_name: str, config: PlumbBobConfig) -> Optional[Any]`
   - Convenience function that:
     - Calculates plumb bob position
     - Creates or updates target empty
     - Returns the empty object

KEY ALGORITHM (from research):
```python
# Auto mode: Calculate bounding box center
bbox = subject.bound_box  # 8 corners in local space

center = Vector((
    sum(v[0] for v in bbox) / 8,
    sum(v[1] for v in bbox) / 8,
    sum(v[2] for v in bbox) / 8
))

# Convert to world space
world_center = subject.matrix_world @ center
```

COMMON PITFALLS:
- Use matrix_world @ Vector() for world space conversion
- Guard bpy.context.scene access
- Return None/0.0 gracefully when Blender unavailable
</action>
  <verify>
python3 -c "
from lib.cinematic.plumb_bob import (
    calculate_plumb_bob, create_target_empty, calculate_focus_distance,
    set_camera_focus_target, remove_target_empty, get_or_create_target,
    BLENDER_AVAILABLE
)
from lib.cinematic.types import PlumbBobConfig

print(f'BLENDER_AVAILABLE: {BLENDER_AVAILABLE}')

# Test config creation
config = PlumbBobConfig(mode='manual', manual_position=(1.0, 2.0, 3.0))
print(f'PlumbBobConfig: mode={config.mode}, pos={config.manual_position}')

# Test calculation outside Blender (should return None)
result = calculate_plumb_bob('subject', config)
print(f'calculate_plumb_bob returned: {result} (expected None outside Blender)')

# Test auto config
auto_config = PlumbBobConfig(mode='auto', offset=(0, 0, 0.5))
print(f'Auto config created: {auto_config.mode}')

print('All plumb_bob functions importable')
"
</verify>
  <done>Plumb bob module with 6 functions created, all bpy access guarded, bounding box algorithm implemented</done>
</task>

<task type="auto">
  <name>Task 2: Update __init__.py with plumb_bob exports</name>
  <files>lib/cinematic/__init__.py</files>
  <action>
Update lib/cinematic/__init__.py to export plumb_bob module functions:

1. Add imports from .plumb_bob:
   - calculate_plumb_bob
   - create_target_empty
   - calculate_focus_distance
   - set_camera_focus_target
   - remove_target_empty
   - get_or_create_target

2. Add to __all__ list

3. Update module docstring to mention plumb_bob module
</action>
  <verify>
python3 -c "
from lib.cinematic import (
    calculate_plumb_bob, create_target_empty, calculate_focus_distance,
    set_camera_focus_target, remove_target_empty, get_or_create_target
)
print('All plumb_bob functions exported from lib.cinematic')
"
</verify>
  <done>All plumb_bob functions exported from lib.cinematic package</done>
</task>

</tasks>

<verification>
1. plumb_bob.py module exists with 6 exported functions
2. calculate_plumb_bob supports auto/manual/object modes
3. Bounding box center calculation correct (sum/8, matrix_world conversion)
4. Focus distance calculation uses world space positions
5. All bpy access guarded
6. All functions exported from lib.cinematic
</verification>

<success_criteria>
- Plumb bob module functional with guarded bpy access
- All 6 functions implemented and exported
- Three targeting modes (auto/manual/object) working
- Works outside Blender for testing
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-camera-system/06.1-03-SUMMARY.md`
</output>
