---
phase: 06.1-camera-system
plan: 01
type: execute
wave: 1
depends_on: []
enables: ["06.1-02", "06.1-03", "06.1-04", "06.1-05", "06.2-01"]
test_coverage: 80%
oracle_validators: ["compare_numbers", "compare_vectors", "file_exists"]
universal_stages:
  normalize: "Load preset YAML files from configs/cinematic/"
  primary: "Parse YAML into Python dataclasses (PlumbBobConfig, RigConfig, etc.)"
  secondary: "Implement to_dict/from_dict serialization methods"
  detail: "Add focus_mode field and aperture validation"
  output: "Export all types from lib.cinematic package"
files_modified:
  - lib/cinematic/types.py
  - lib/cinematic/preset_loader.py
  - lib/cinematic/__init__.py
autonomous: true

must_haves:
  truths:
    - "New dataclass types can be imported from lib.cinematic.types"
    - "Preset loader can load lens, sensor, rig, and imperfection YAML files"
    - "All preset files are accessible and parseable"
    - "PlumbBobConfig includes focus_mode field for auto/manual focus control"
  artifacts:
    - path: "lib/cinematic/types.py"
      provides: "Extended dataclasses for camera system"
      contains: "class PlumbBobConfig"
    - path: "lib/cinematic/types.py"
      contains: "focus_mode"
    - path: "lib/cinematic/types.py"
      contains: "class RigConfig"
    - path: "lib/cinematic/types.py"
      contains: "class ImperfectionConfig"
    - path: "lib/cinematic/types.py"
      contains: "class MultiCameraLayout"
    - path: "lib/cinematic/preset_loader.py"
      provides: "YAML preset loading with JSON fallback"
      exports: ["load_preset", "get_lens_preset", "get_sensor_preset", "get_rig_preset", "get_imperfection_preset"]
  key_links:
    - from: "lib/cinematic/preset_loader.py"
      to: "configs/cinematic/cameras/*.yaml"
      via: "Path-based file loading"
      pattern: "load_preset.*configs/cinematic"
---

<objective>
Extend cinematic types with camera system dataclasses and create preset loader utility.

Purpose: Provide type-safe configuration classes for plumb bob targeting, camera rigs, lens imperfections, and multi-camera layouts. Create preset loader to access existing YAML configurations.

Output: Extended types.py with 4 new dataclasses, new preset_loader.py module, updated __init__.py exports.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 6.0 Summary (Foundation - COMPLETE)
@.planning/phases/06-foundation-cinematic/06-01-SUMMARY.md

# Existing codebase patterns to follow
@lib/cinematic/types.py
@lib/cinematic/enums.py
@lib/cinematic/state_manager.py
@lib/cinematic/__init__.py

# Research findings
@.planning/phases/06.1-camera-system/06.1-RESEARCH.md

# Existing preset files (DO NOT MODIFY)
@configs/cinematic/cameras/lens_presets.yaml
@configs/cinematic/cameras/sensor_presets.yaml
@configs/cinematic/cameras/rig_presets.yaml
@configs/cinematic/cameras/imperfection_presets.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend types.py with camera system dataclasses</name>
  <files>lib/cinematic/types.py</files>
  <action>
Add the following dataclasses to lib/cinematic/types.py (append to existing file, do not modify existing classes):

1. **PlumbBobConfig** - Configuration for plumb bob targeting system:
   - `mode: str = "auto"` - Positioning mode: "auto", "manual", or "object"
   - `offset: Tuple[float, float, float] = (0.0, 0.0, 0.0)` - World space offset
   - `manual_position: Tuple[float, float, float] = (0.0, 0.0, 0.0)` - Explicit position for manual mode
   - `target_object: str = ""` - Target object name for object mode
   - `focus_mode: str = "auto"` - Focus distance mode: "auto" (calculated from camera to target) or "manual" (explicit distance)
   - `focus_distance: float = 0.0` - Manual focus distance in meters (used when focus_mode="manual")
   - Include to_dict() and from_dict() class methods following existing patterns

2. **RigConfig** - Configuration for camera rig systems:
   - `rig_type: str = "tripod"` - Type: "tripod", "tripod_orbit", "dolly", "dolly_curved", "crane", "steadicam", "drone"
   - `constraints: Dict[str, Any] = field(default_factory=dict)` - Motion constraints
   - `smoothing: Dict[str, float] = field(default_factory=dict)` - Smoothing parameters for steadicam
   - `track_config: Dict[str, Any] = field(default_factory=dict)` - Track configuration for dolly
   - Include to_dict() and from_dict() class methods

3. **ImperfectionConfig** - Configuration for lens imperfections:
   - `name: str = "clean"` - Preset name
   - `flare_enabled: bool = False` - Enable lens flare
   - `flare_intensity: float = 0.0` - Flare intensity (0.0 to 1.0)
   - `flare_streaks: int = 8` - Number of flare streaks
   - `vignette: float = 0.0` - Vignette intensity (0.0 to 1.0)
   - `chromatic_aberration: float = 0.0` - Chromatic aberration amount
   - `bokeh_shape: str = "circular"` - Bokeh shape: "circular", "hexagonal", "octagonal", "rounded"
   - `bokeh_swirl: float = 0.0` - Bokeh swirl amount (for vintage lenses)
   - Include to_dict() and from_dict() class methods

4. **MultiCameraLayout** - Configuration for multi-camera setups:
   - `layout_type: str = "grid"` - Layout: "grid", "horizontal", "vertical", "circle", "arc", "custom"
   - `spacing: float = 2.0` - Distance between cameras
   - `cameras: List[str] = field(default_factory=list)` - Camera names
   - `positions: List[Tuple[float, float, float]] = field(default_factory=list)` - Custom positions for "custom" layout
   - `composite_output: bool = True` - Enable compositor-based composite output (grid layout to single image)
   - `composite_rows: int = 0` - Number of rows in composite (0 = auto-calculate)
   - `composite_cols: int = 0` - Number of columns in composite (0 = auto-calculate)
   - Include to_dict() and from_dict() class methods

CRITICAL: Follow the exact patterns from existing dataclasses:
- Use `from __future__ import annotations` (already at top of file)
- Use `@dataclass` decorator
- Use `field(default_factory=dict)` for mutable defaults
- Implement to_dict() returning Dict[str, Any]
- Implement from_dict() classmethod with `data.get("key", default)` pattern
- All rotations in Euler degrees (XYZ order) for consistency
</action>
  <verify>
python3 -c "
from lib.cinematic.types import PlumbBobConfig, RigConfig, ImperfectionConfig, MultiCameraLayout
print('PlumbBobConfig:', PlumbBobConfig())
print('RigConfig:', RigConfig())
print('ImperfectionConfig:', ImperfectionConfig())
print('MultiCameraLayout:', MultiCameraLayout())
# Test focus_mode field
config = PlumbBobConfig(mode='manual', focus_mode='manual', focus_distance=5.0)
assert config.focus_mode == 'manual'
assert config.focus_distance == 5.0
print('focus_mode field works correctly')
# Test serialization round-trip
data = config.to_dict()
restored = PlumbBobConfig.from_dict(data)
assert restored.focus_mode == 'manual'
assert restored.focus_distance == 5.0
print('All dataclasses created and serialization works')
"
</verify>
  <done>All 4 new dataclasses defined with focus_mode, composite fields, and to_dict/from_dict methods, importable from lib.cinematic.types</done>
</task>

<task type="auto">
  <name>Task 2: Create preset_loader.py module</name>
  <files>lib/cinematic/preset_loader.py</files>
  <action>
Create lib/cinematic/preset_loader.py with preset loading utilities:

1. Module docstring explaining purpose
2. Optional yaml import with JSON fallback (copy pattern from state_manager.py)
3. CONFIG_ROOT constant pointing to configs/cinematic/
4. Functions:
   - `load_preset(path: Path) -> Dict[str, Any]` - Load any YAML preset file
   - `get_lens_preset(name: str) -> Dict[str, Any]` - Load specific lens preset
   - `get_sensor_preset(name: str) -> Dict[str, Any]` - Load specific sensor preset
   - `get_rig_preset(name: str) -> Dict[str, Any]` - Load specific rig preset
   - `get_imperfection_preset(name: str) -> Dict[str, Any]` - Load specific imperfection preset
   - `list_lens_presets() -> List[str]` - List available lens presets
   - `list_sensor_presets() -> List[str]` - List available sensor presets
   - `list_rig_presets() -> List[str]` - List available rig presets
   - `list_imperfection_presets() -> List[str]` - List available imperfection presets
   - `get_aperture_preset(f_stop: float) -> Dict[str, Any]` - Get aperture configuration for given f-stop

Each get_*_preset function should:
- Use CONFIG_ROOT to build path
- Call load_preset()
- Return the specific preset dict or raise ValueError if not found

APERTURE PRESET FUNCTION:
- `get_aperture_preset(f_stop: float)` should validate that f_stop is in valid range (0.95 to 22.0)
- Return dict with:
  - `f_stop: float` - The f-stop value
  - `aperture_blades: int` - Recommended blade count based on f-stop
  - `valid: bool` - True if within valid range
- Raise ValueError if f_stop is outside 0.95-22.0 range

Follow the error handling pattern from state_manager.py:
- FileNotFoundError for missing files
- RuntimeError if YAML file but PyYAML not available
- ValueError if preset name not found in file
</action>
  <verify>
python3 -c "
from lib.cinematic.preset_loader import (
    load_preset, get_lens_preset, get_sensor_preset,
    get_rig_preset, get_imperfection_preset,
    list_lens_presets, list_sensor_presets,
    get_aperture_preset
)
# Test lens preset loading
lens = get_lens_preset('85mm_portrait')
assert lens['focal_length'] == 85
print('85mm_portrait preset loaded:', lens['description'])
# Test sensor preset loading
sensor = get_sensor_preset('full_frame')
assert sensor['width'] == 36.0
print('full_frame sensor loaded:', sensor['description'])
# Test aperture preset validation
aperture = get_aperture_preset(2.8)
assert aperture['f_stop'] == 2.8
assert aperture['valid'] == True
print('Aperture f/2.8 validated')
# Test aperture range validation
try:
    get_aperture_preset(0.5)  # Below minimum
    print('ERROR: Should have raised ValueError')
except ValueError as e:
    print(f'Correctly rejected f/0.5: {e}')
try:
    get_aperture_preset(32.0)  # Above maximum
    print('ERROR: Should have raised ValueError')
except ValueError as e:
    print(f'Correctly rejected f/32: {e}')
# Test listing
lenses = list_lens_presets()
assert '85mm_portrait' in lenses
assert '50mm_normal' in lenses
print(f'Available lenses: {len(lenses)}')
print('Preset loader working correctly')
"
</verify>
  <done>All preset loader functions working, can load lens/sensor/rig/imperfection presets from YAML files, aperture validation f/0.95-f/22 implemented</done>
</task>

<task type="auto">
  <name>Task 3: Update __init__.py exports</name>
  <files>lib/cinematic/__init__.py</files>
  <action>
Update lib/cinematic/__init__.py to export the new types and preset loader:

1. Add imports for new types from .types:
   - PlumbBobConfig
   - RigConfig
   - ImperfectionConfig
   - MultiCameraLayout

2. Add imports from .preset_loader:
   - load_preset
   - get_lens_preset
   - get_sensor_preset
   - get_rig_preset
   - get_imperfection_preset
   - list_lens_presets
   - list_sensor_presets
   - list_rig_presets
   - list_imperfection_presets
   - get_aperture_preset

3. Update __all__ list to include all new exports

4. Update module docstring to mention preset_loader in the Modules section

Do NOT change __version__ (keep at 0.1.0)
</action>
  <verify>
python3 -c "
from lib.cinematic import (
    PlumbBobConfig, RigConfig, ImperfectionConfig, MultiCameraLayout,
    load_preset, get_lens_preset, get_sensor_preset,
    get_rig_preset, get_imperfection_preset,
    list_lens_presets, list_sensor_presets, list_rig_presets, list_imperfection_presets,
    get_aperture_preset
)
print('All new types imported successfully')
print('All preset loader functions imported successfully')
print('get_aperture_preset imported successfully')
"
</verify>
  <done>All new types and preset loader functions including get_aperture_preset exported from lib.cinematic package</done>
</task>

</tasks>

<verification>
1. All 4 new dataclasses exist in types.py with proper to_dict/from_dict methods
2. PlumbBobConfig includes focus_mode and focus_distance fields for auto/manual focus control
3. MultiCameraLayout includes composite_output, composite_rows, composite_cols fields
4. preset_loader.py can load all 4 preset YAML files
5. get_aperture_preset() validates f-stop range (0.95 to 22.0)
6. list_*_presets() functions return correct preset names
7. All new exports accessible from lib.cinematic
8. Serialization round-trip works for all new dataclasses
</verification>

<success_criteria>
- PlumbBobConfig, RigConfig, ImperfectionConfig, MultiCameraLayout dataclasses defined
- focus_mode field (auto/manual) added to PlumbBobConfig
- composite_output fields added to MultiCameraLayout
- Preset loader module functional with all get/list functions
- Aperture validation for f/0.95 to f/22 range implemented
- Package exports updated
- Code follows existing patterns (dataclass serialization, YAML loading, guarded imports)
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-camera-system/06.1-01-SUMMARY.md`
</output>
