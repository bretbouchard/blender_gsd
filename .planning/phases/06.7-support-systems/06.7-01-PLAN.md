---
phase: 06.7-support-systems
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/cinematic/types.py
  - lib/cinematic/enums.py
  - lib/cinematic/preset_loader.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Shot variations can be configured with camera angle, lighting, and focal length tweaks"
    - "Scene state can be captured for comparison and undo operations"
    - "Objects can be organized into depth layers (foreground, midground, background)"
    - "Composition guides can be configured for rule of thirds and golden ratio"
    - "Lens effects (bloom, flare, vignette) can be configured for post-processing"
  artifacts:
    - path: "lib/cinematic/types.py"
      provides: "ShuffleConfig, FrameState, DepthLayerConfig, CompositionGuide, LensFXConfig dataclasses"
      min_lines: 200
    - path: "lib/cinematic/enums.py"
      provides: "CompositionGuideType, DepthLayer enum"
    - path: "lib/cinematic/preset_loader.py"
      provides: "Preset loaders for shuffler, depth layers, composition, lens FX"
  key_links:
    - from: "lib/cinematic/preset_loader.py"
      to: "configs/cinematic/support/"
      via: "load_preset()"
      pattern: "support_"
---

<objective>
Add support system types, enums, and preset loaders for shuffler, frame_store, depth_layers, composition, and lens_fx modules

Purpose: Enable type-safe configuration for shot variation, state capture, depth organization, composition guides, and lens effects
Output: Extended types, enums, and preset loader functions for the support systems
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference implementations for patterns
@lib/cinematic/types.py
@lib/cinematic/enums.py
@lib/cinematic/preset_loader.py

# Existing lenses module (pattern for lens_fx)
@lib/cinematic/lenses.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Support System Enums to enums.py</name>
  <files>lib/cinematic/enums.py</files>
  <action>
Add support system enums to lib/cinematic/enums.py following the existing enum pattern:

1. Add CompositionGuideType enum:
   - RULE_OF_THIRDS = "rule_of_thirds"
   - GOLDEN_RATIO = "golden_ratio"
   - GOLDEN_SPIRAL = "golden_spiral"
   - CENTER_CROSS = "center_cross"
   - DIAGONAL = "diagonal"

2. Add DepthLayer enum:
   - FOREGROUND = "foreground"
   - MIDGROUND = "midground"
   - BACKGROUND = "background"

3. Add LensFXType enum:
   - BLOOM = "bloom"
   - FLARE = "flare"
   - VIGNETTE = "vignette"
   - CHROMATIC = "chromatic"
   - GLITCH = "glitch"

Import these from the same location as existing enums (inheriting from str, Enum).
Add these after the existing RenderEngine and DenoiserType enums.
  </action>
  <verify>python3 -c "from lib.cinematic.enums import CompositionGuideType, DepthLayer, LensFXType; print(CompositionGuideType.RULE_OF_THIRDS.value)"</verify>
  <done>CompositionGuideType, DepthLayer, LensFXType enums available with correct string values</done>
</task>

<task type="auto">
  <name>Task 2: Add Support System Dataclasses to types.py</name>
  <files>lib/cinematic/types.py</files>
  <action>
Add the following 5 dataclasses to lib/cinematic/types.py after the existing CinematicRenderSettings class:

```python
@dataclass
class ShuffleConfig:
    """
    Configuration for shot variation generation.

    Generates multiple shot variations with randomized camera,
    lighting, and lens parameters within defined ranges.

    Attributes:
        name: Preset name
        count: Number of variations to generate
        camera_angle_range: (min, max) horizontal angle range in degrees
        camera_height_range: (min, max) height offset range in meters
        focal_length_range: (min, max) focal length range in mm
        f_stop_range: (min, max) f-stop range
        light_intensity_range: (min, max) intensity multiplier range
        light_angle_range: (min, max) light rotation range in degrees
        seed: Random seed for reproducibility (0 = random)
    """
    name: str = "default"
    count: int = 5
    camera_angle_range: Tuple[float, float] = (-30.0, 30.0)
    camera_height_range: Tuple[float, float] = (-0.2, 0.2)
    focal_length_range: Tuple[float, float] = (35.0, 85.0)
    f_stop_range: Tuple[float, float] = (2.8, 8.0)
    light_intensity_range: Tuple[float, float] = (0.8, 1.2)
    light_angle_range: Tuple[float, float] = (-45.0, 45.0)
    seed: int = 0

    def to_dict(self) -> Dict[str, Any]: ...
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> "ShuffleConfig": ...

@dataclass
class FrameState:
    """
    Captured scene state for comparison and undo.

    Stores camera, lighting, and object transforms at a point in time.
    Can be compared against current state or other captured frames.

    Attributes:
        frame_id: Unique frame identifier
        timestamp: ISO 8601 timestamp of capture
        label: User-friendly label for the frame
        camera: CameraConfig snapshot
        lights: Dict of light name -> Transform3D
        objects: Dict of object name -> Transform3D
        render_settings: Render settings snapshot
    """
    frame_id: str = ""
    timestamp: str = ""
    label: str = ""
    camera: CameraConfig = field(default_factory=CameraConfig)
    lights: Dict[str, Transform3D] = field(default_factory=dict)
    objects: Dict[str, Transform3D] = field(default_factory=dict)
    render_settings: Dict[str, Any] = field(default_factory=dict)

    def to_dict(self) -> Dict[str, Any]: ...
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> "FrameState": ...

@dataclass
class DepthLayerConfig:
    """
    Configuration for depth layer organization.

    Organizes scene objects into foreground, midground, and background
    for DOF control and compositing workflows.

    Attributes:
        name: Layer name (foreground, midground, background)
        distance_min: Minimum distance from camera in meters
        distance_max: Maximum distance from camera in meters
        blur_amount: DOF blur amount for this layer (0-1)
        objects: List of object names assigned to this layer
        collection_name: Blender collection name for this layer
        render_pass: Whether to output as separate render pass
    """
    name: str = "midground"
    distance_min: float = 0.5
    distance_max: float = 5.0
    blur_amount: float = 0.0
    objects: List[str] = field(default_factory=list)
    collection_name: str = ""
    render_pass: bool = False

    def to_dict(self) -> Dict[str, Any]: ...
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> "DepthLayerConfig": ...

@dataclass
class CompositionGuide:
    """
    Configuration for viewport composition overlays.

    Provides visual guides for cinematography composition rules
    rendered as viewport annotations.

    Attributes:
        guide_type: Type of composition guide
        opacity: Guide opacity (0-1)
        color: RGB color for guide lines (0-1)
        enabled: Whether guide is visible
        show_safe_areas: Show title/action safe areas
        show_center: Show center crosshair
        custom_aspect: Custom aspect ratio (width/height, 0 = use render)
    """
    guide_type: str = "rule_of_thirds"
    opacity: float = 0.5
    color: Tuple[float, float, float] = (1.0, 0.5, 0.0)
    enabled: bool = True
    show_safe_areas: bool = False
    show_center: bool = True
    custom_aspect: float = 0.0

    def to_dict(self) -> Dict[str, Any]: ...
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> "CompositionGuide": ...

@dataclass
class LensFXConfig:
    """
    Configuration for post-process lens effects via compositor.

    Extends ImperfectionConfig with additional effects like bloom
    and more fine-grained control over each effect type.

    Attributes:
        name: Preset name
        bloom_enabled: Enable bloom effect
        bloom_intensity: Bloom intensity (0-1)
        bloom_threshold: Bloom threshold (brightness cutoff)
        flare_enabled: Enable lens flare
        flare_intensity: Flare intensity (0-1)
        flare_streaks: Number of flare streaks
        vignette_enabled: Enable vignette
        vignette_intensity: Vignette darkness (0-1)
        vignette_roundness: Vignette shape (0=square, 1=circle)
        chromatic_enabled: Enable chromatic aberration
        chromatic_amount: CA amount
        grain_enabled: Enable film grain
        grain_amount: Grain intensity (0-1)
    """
    name: str = "clean"
    bloom_enabled: bool = False
    bloom_intensity: float = 0.3
    bloom_threshold: float = 0.8
    flare_enabled: bool = False
    flare_intensity: float = 0.5
    flare_streaks: int = 8
    vignette_enabled: bool = False
    vignette_intensity: float = 0.3
    vignette_roundness: float = 0.5
    chromatic_enabled: bool = False
    chromatic_amount: float = 0.0
    grain_enabled: bool = False
    grain_amount: float = 0.0

    def to_dict(self) -> Dict[str, Any]: ...
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> "LensFXConfig": ...
```

Implement the to_dict() and from_dict() methods for each class following existing patterns in types.py.
  </action>
  <verify>python3 -c "from lib.cinematic.types import ShuffleConfig, FrameState, DepthLayerConfig, CompositionGuide, LensFXConfig; s = ShuffleConfig(); print(s.count)"</verify>
  <done>ShuffleConfig, FrameState, DepthLayerConfig, CompositionGuide, LensFXConfig dataclasses available with all required fields</done>
</task>

<task type="auto">
  <name>Task 3: Add Support System Preset Loaders to preset_loader.py</name>
  <files>lib/cinematic/preset_loader.py</files>
  <action>
Add support system preset loaders to lib/cinematic/preset_loader.py following the existing pattern:

1. Add SUPPORT_CONFIG_ROOT constant:
```python
# Support system configuration root directory
SUPPORT_CONFIG_ROOT = Path("configs/cinematic/support")
```

2. Add the following loader functions following existing patterns:

- get_shuffle_preset(name: str) -> Dict[str, Any]
  - Load from SUPPORT_CONFIG_ROOT / "shuffle_presets.yaml"
  - Get presets section, return preset dict

- get_depth_layer_preset(name: str) -> Dict[str, Any]
  - Load from SUPPORT_CONFIG_ROOT / "depth_layers.yaml"
  - Get layers section, return layer dict

- get_composition_guide_preset(name: str) -> Dict[str, Any]
  - Load from SUPPORT_CONFIG_ROOT / "composition_guides.yaml"
  - Get guides section, return guide dict

- get_lens_fx_preset(name: str) -> Dict[str, Any]
  - Load from SUPPORT_CONFIG_ROOT / "lens_fx_presets.yaml"
  - Get effects section, return effect dict

3. Add list functions:
- list_shuffle_presets() -> List[str]
- list_depth_layer_presets() -> List[str]
- list_composition_guide_presets() -> List[str]
- list_lens_fx_presets() -> List[str]

Add these in a new section after the Render System Preset Loaders section.

IMPORTANT: These functions will initially fail with FileNotFoundError since the YAML files
do not exist yet. That is expected - the config files will be created in Wave 2 with the modules.
  </action>
  <verify>python3 -c "from lib.cinematic.preset_loader import get_shuffle_preset, get_depth_layer_preset, get_composition_guide_preset, get_lens_fx_preset; print('Loaders imported successfully')"</verify>
  <done>get_shuffle_preset(), get_depth_layer_preset(), get_composition_guide_preset(), get_lens_fx_preset() and list functions available for support system configuration</done>
</task>

</tasks>

<verification>
1. Verify enums can be imported and have correct values
2. Verify all 5 dataclasses can be instantiated and serialized
3. Verify preset loader functions are importable
4. Verify list functions are defined
</verification>

<success_criteria>
- CompositionGuideType, DepthLayer, LensFXType enums in enums.py
- ShuffleConfig, FrameState, DepthLayerConfig, CompositionGuide, LensFXConfig dataclasses in types.py
- get_shuffle_preset(), get_depth_layer_preset(), get_composition_guide_preset(), get_lens_fx_preset() in preset_loader.py
- All list_* functions defined
- All imports work without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06.7-support-systems/06.7-01-SUMMARY.md`
</output>
