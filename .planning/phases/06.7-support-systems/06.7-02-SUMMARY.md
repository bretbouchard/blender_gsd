---
phase: 06.7-support-systems
plan: 02
subsystem: support
tags: [shuffler, frame-store, depth-layers, composition, lens-fx, cinematic]
requires:
  - 06.7-01 (Support System Types + Preset Loaders)
provides:
  - Shot variation generation (shuffler)
  - State capture/restore (frame_store)
  - Depth layer organization (depth_layers)
  - Composition guide overlays (composition)
  - Post-process lens effects (lens_fx)
affects:
  - Future cinematic workflows
completed: 2026-02-19
duration: 45 minutes
---

# Phase 6.7 Plan 02: Support Modules Summary

## One-Liner

Complete implementations for shuffler (shot variations), frame_store (state capture), depth_layers (DOF organization), composition (viewport guides), and lens_fx (compositor effects).

## Key Changes

### 1. shuffler.py (365 lines)
Shot variation generator with:
- `generate_variations(config, base_camera)` - Create N camera variations
- `apply_variation(camera_name, variation)` - Apply variation to Blender camera
- `create_shuffle_set(shot_name, config)` - Create multiple camera objects
- `randomize_parameter(value, range, seed)` - Random value within range
- `generate_light_variations(config, lights)` - Light variation sets
- `clear_shuffle_set(shot_name)` - Remove shuffle cameras
- `apply_shuffle_preset(preset_name)` - Apply preset by name

### 2. frame_store.py (419 lines)
State capture and comparison:
- `capture_frame(label)` - Capture current scene state
- `restore_frame(frame)` - Restore to captured state
- `compare_frames(frame_a, frame_b)` - Diff two states
- `save_state_to_file(frame, path)` - Persist to JSON
- `load_state_from_file(path)` - Load from JSON
- `save_frame(shot_name, frame)` - Auto-numbered save
- `load_frame(shot_name, frame_num)` - Load by number
- `get_frame_history(shot_name)` - All frames for shot

### 3. depth_layers.py (438 lines)
Depth organization for DOF:
- `create_depth_layer(config)` - Create layer with collection
- `organize_depth_layers(config)` - Group objects by layer
- `assign_to_layer(object_name, layer, pass_index)` - Assign object
- `setup_dof_for_layers(layers, focus_layer)` - Configure camera DOF
- `apply_layer_dof(layer_name, blur_amount)` - Compositor DOF
- `get_layer_for_distance(distance, layers)` - Layer lookup
- `auto_assign_by_distance(camera, layers)` - Auto-assign objects
- `get_layer_statistics()` - Count by layer

### 4. composition.py (643 lines)
Viewport composition overlays:
- `setup_composition_guides(config)` - Apply from config
- `show_rule_of_thirds(opacity, color)` - 2x2 grid overlay
- `show_golden_ratio(opacity, color)` - Phi-based divisions
- `show_golden_spiral(opacity, color)` - Fibonacci focus points
- `show_center_cross(opacity, color)` - Center crosshair
- `show_diagonal_overlay(opacity, color)` - Corner diagonals
- `show_safe_areas(opacity, color)` - Title/action safe zones
- `clear_guides()` - Remove all overlays
- `get_active_guides()` - List active types

### 5. lens_fx.py (719 lines)
Compositor lens effects:
- `apply_lens_fx(config)` - Apply all effects from config
- `setup_bloom(intensity, threshold)` - Fog glow via Glare node
- `setup_flare(intensity, ghost_count)` - Ghosts via Glare node
- `setup_vignette(intensity, radius)` - Elliptical mask + multiply
- `setup_chromatic_aberration(strength)` - LensDistortion node
- `setup_film_grain(intensity)` - Noise + overlay mix
- `remove_lens_fx()` - Clear all FX nodes
- `apply_lens_fx_preset(preset_name)` - Apply preset by name
- `get_active_effects()` - List active effect types

### 6. Preset Files

**shuffle_presets.yaml:**
- subtle: +/- 5 deg, +/- 5 cm (A/B testing)
- moderate: +/- 15 deg, +/- 20 cm (exploration)
- aggressive: +/- 45 deg, +/- 50 cm (creative)
- lens_exploration: Wide focal length range
- lighting_exploration: Strong light variations
- reproducible: Fixed seed=42
- portrait: Optimized for portraits
- product: Optimized for products

**lens_fx_presets.yaml:**
- clean: No effects
- cinematic: Subtle bloom/vignette
- vintage: Film grain + CA
- dream: Ethereal soft look
- dramatic: Strong vignette
- horror: Strong CA + grain
- scifi: Subtle CA + flare
- flare: Strong lens flare
- film_stock: 35mm simulation
- polaroid: Instant camera look
- product_clean: Minimal effects
- product_dramatic: Enhanced presentation

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Compositor pipeline order: CA -> bloom -> flare -> vignette -> grain | Follows standard post-production order: geometric -> luminance -> film |
| Mesh objects for composition guides | Render-independent, always visible via show_in_front |
| Collection-based depth layers | Easy object management, supports render layers |
| JSON for frame state files | Human-readable, no YAML dependency |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Types/Enums from 06.7-01**
- **Found during:** Module imports
- **Issue:** Plan 06.7-02 depends on 06.7-01 types which were not yet created
- **Fix:** Added CompositionGuideType, DepthLayer, LensFXType enums and updated types.py inline
- **Files modified:** lib/cinematic/enums.py, lib/cinematic/preset_loader.py
- **Commit:** Part of this commit

**2. [Rule 1 - Bug] Existing stub modules**
- **Found during:** File creation
- **Issue:** composition.py and lens_fx.py existed as stubs (~100 lines each)
- **Fix:** Replaced with full implementations (643 and 719 lines respectively)
- **Files modified:** lib/cinematic/composition.py, lib/cinematic/lens_fx.py
- **Commit:** Part of this commit

## Files Created/Modified

| File | Lines | Status | Purpose |
|------|-------|--------|---------|
| lib/cinematic/shuffler.py | 365 | Created | Shot variation generator |
| lib/cinematic/frame_store.py | 419 | Created | State capture/restore |
| lib/cinematic/depth_layers.py | 438 | Created | Depth layer organization |
| lib/cinematic/composition.py | 643 | Expanded | Viewport composition guides |
| lib/cinematic/lens_fx.py | 719 | Expanded | Compositor lens effects |
| lib/cinematic/enums.py | +27 | Modified | Added support system enums |
| lib/cinematic/preset_loader.py | +44 | Modified | Added support loaders |
| configs/cinematic/support/shuffle_presets.yaml | 107 | Created | 8 variation presets |
| configs/cinematic/support/lens_fx_presets.yaml | 142 | Created | 12 lens FX presets |

**Total additions:** 2,896 lines

## Next Phase Readiness

### Complete
- All 5 support modules implemented
- All preset YAML files created
- Enums and preset loaders added
- All minimum line requirements exceeded

### Ready For
- Phase 6.7-03: Package exports + version bump
- Future: Integration with shot_builder and render pipeline

## Verification

```bash
# Verify module line counts
wc -l lib/cinematic/shuffler.py lib/cinematic/frame_store.py \
       lib/cinematic/depth_layers.py lib/cinematic/composition.py \
       lib/cinematic/lens_fx.py
# Output: 365, 419, 438, 643, 719 (all exceed minimums)

# Verify enums
grep -c "class.*Enum" lib/cinematic/enums.py
# Output: 11 enums including new support system ones

# Verify preset files
ls configs/cinematic/support/
# Output: lens_fx_presets.yaml, shuffle_presets.yaml
```
