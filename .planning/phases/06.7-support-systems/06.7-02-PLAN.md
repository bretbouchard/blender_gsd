---
phase: 06.7-support-systems
plan: 02
type: execute
wave: 2
depends_on:
  - 06.7-01
files_modified:
  - lib/cinematic/shuffler.py
  - lib/cinematic/frame_store.py
  - lib/cinematic/depth_layers.py
  - lib/cinematic/composition.py
  - lib/cinematic/lens_fx.py
  - configs/cinematic/support/shuffle_presets.yaml
  - configs/cinematic/support/depth_layers.yaml
  - configs/cinematic/support/composition_guides.yaml
  - configs/cinematic/support/lens_fx_presets.yaml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Shot variations generate with randomized camera/lighting within defined ranges"
    - "Scene state is captured with camera, lights, and object transforms"
    - "Depth layers organize objects for DOF and compositing workflows"
    - "Composition guides display rule of thirds and golden ratio overlays"
    - "Lens effects apply bloom, flare, and vignette via compositor nodes"
  artifacts:
    - path: "lib/cinematic/shuffler.py"
      provides: "generate_variations, apply_variation, create_shuffle_set"
      min_lines: 150
    - path: "lib/cinematic/frame_store.py"
      provides: "capture_frame, restore_frame, compare_frames"
      min_lines: 200
    - path: "lib/cinematic/depth_layers.py"
      provides: "create_depth_layer, assign_to_layer, setup_dof_for_layers"
      min_lines: 200
    - path: "lib/cinematic/composition.py"
      provides: "create_guide_overlay, show_rule_of_thirds, show_golden_ratio"
      min_lines: 200
    - path: "lib/cinematic/lens_fx.py"
      provides: "apply_lens_fx, apply_bloom, apply_vignette, clear_lens_fx"
      min_lines: 250
  key_links:
    - from: "lib/cinematic/shuffler.py"
      to: "lib/cinematic/types.ShuffleConfig"
      via: "import"
      pattern: "ShuffleConfig"
    - from: "lib/cinematic/lens_fx.py"
      to: "bpy.context.scene.node_tree"
      via: "compositor nodes"
      pattern: "CompositorNode"
---

<objective>
Create 5 support system modules with corresponding YAML preset files

Purpose: Implement shot variation, state capture, depth organization, composition guides, and lens effects functionality
Output: shuffler.py, frame_store.py, depth_layers.py, composition.py, lens_fx.py modules with preset files
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Types from Wave 1
@lib/cinematic/types.py

# Reference implementations for compositor patterns
@lib/cinematic/lenses.py

# Existing state manager (pattern for frame_store)
@lib/cinematic/state_manager.py

# Existing camera module (pattern for camera manipulation)
@lib/cinematic/camera.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shuffler.py - Shot Variation Generator</name>
  <files>lib/cinematic/shuffler.py, configs/cinematic/support/shuffle_presets.yaml</files>
  <action>
Create lib/cinematic/shuffler.py for shot variation generation:

1. Create the module with docstring following existing module patterns

2. Implement core functions:
   - generate_variations(config: ShuffleConfig, base_camera: CameraConfig) -> List[CameraConfig]
     - Generate N variations based on config parameters
     - Use random.seed(config.seed) for reproducibility
     - Apply ranges for angle, height, focal length, f-stop

   - apply_variation(camera_name: str, variation: CameraConfig) -> bool
     - Apply a variation to an existing camera in Blender
     - Update camera position, rotation, lens settings

   - create_shuffle_set(shot_name: str, config: ShuffleConfig) -> List[str]
     - Create multiple camera objects with variations
     - Return list of camera names created

3. Create configs/cinematic/support/shuffle_presets.yaml:
```yaml
# Shot Variation Presets for Cinematic Shuffler
presets:
  default:
    description: "Default shuffle - moderate variations"
    count: 5
    camera_angle_range: [-30.0, 30.0]
    camera_height_range: [-0.2, 0.2]
    focal_length_range: [35.0, 85.0]
    f_stop_range: [2.8, 8.0]
    light_intensity_range: [0.8, 1.2]
    light_angle_range: [-45.0, 45.0]
    seed: 0

  subtle:
    description: "Subtle variations - small tweaks"
    count: 3
    camera_angle_range: [-10.0, 10.0]
    camera_height_range: [-0.1, 0.1]
    focal_length_range: [45.0, 65.0]
    f_stop_range: [4.0, 5.6]
    light_intensity_range: [0.9, 1.1]
    light_angle_range: [-15.0, 15.0]
    seed: 0

  dramatic:
    description: "Dramatic variations - wide range"
    count: 8
    camera_angle_range: [-90.0, 90.0]
    camera_height_range: [-0.5, 0.5]
    focal_length_range: [24.0, 135.0]
    f_stop_range: [1.4, 16.0]
    light_intensity_range: [0.5, 1.5]
    light_angle_range: [-90.0, 90.0]
    seed: 0

  lens_test:
    description: "Lens focal length test - fixed position"
    count: 5
    camera_angle_range: [0.0, 0.0]
    camera_height_range: [0.0, 0.0]
    focal_length_range: [24.0, 100.0]
    f_stop_range: [2.8, 2.8]
    light_intensity_range: [1.0, 1.0]
    light_angle_range: [0.0, 0.0]
    seed: 42
```

Follow the pattern from lenses.py for BLENDER_AVAILABLE guard and error handling.
  </action>
  <verify>python3 -c "from lib.cinematic.shuffler import generate_variations, apply_variation, create_shuffle_set; print('Shuffler functions imported')"</verify>
  <done>shuffler.py with generate_variations(), apply_variation(), create_shuffle_set() and shuffle_presets.yaml created</done>
</task>

<task type="auto">
  <name>Task 2: Create frame_store.py - State Capture/Comparison</name>
  <files>lib/cinematic/frame_store.py</files>
  <action>
Create lib/cinematic/frame_store.py for scene state capture and comparison:

1. Create the module extending the existing FrameStore functionality

2. Implement core functions:
   - capture_frame(label: str = "") -> FrameState
     - Capture current scene state (camera, lights, selected objects)
     - Generate unique frame_id with UUID
     - Set timestamp to current time

   - restore_frame(frame: FrameState) -> bool
     - Restore scene to captured state
     - Apply camera, light transforms
     - Return success/failure

   - compare_frames(frame_a: FrameState, frame_b: FrameState) -> Dict[str, Any]
     - Compare two captured frames
     - Return dict of differences (camera, lights, objects)

   - get_frame_history(shot_name: str) -> List[FrameState]
     - Load all frames for a shot from .gsd-state
     - Return sorted by timestamp

   - label_frame(frame_id: str, label: str) -> bool
     - Update frame label in storage
     - Return success/failure

3. Extend the existing FrameStore class to support FrameState:
   - save_frame_state(shot_name: str, frame: FrameState) -> str
   - load_frame_state(shot_name: str, frame_id: str) -> FrameState

This module builds on state_manager.py patterns but focuses on comparison and history.
  </action>
  <verify>python3 -c "from lib.cinematic.frame_store import capture_frame, restore_frame, compare_frames; print('Frame store functions imported')"</verify>
  <done>frame_store.py with capture_frame(), restore_frame(), compare_frames(), get_frame_history(), label_frame() created</done>
</task>

<task type="auto">
  <name>Task 3: Create depth_layers.py - Fore/Mid/Background Organization</name>
  <files>lib/cinematic/depth_layers.py, configs/cinematic/support/depth_layers.yaml</files>
  <action>
Create lib/cinematic/depth_layers.py for depth layer organization:

1. Create the module for organizing objects into depth layers

2. Implement core functions:
   - create_depth_layer(config: DepthLayerConfig) -> bpy.types.Collection
     - Create a Blender collection for the layer
     - Set up pass index for render layers if enabled

   - assign_to_layer(object_name: str, layer_name: str) -> bool
     - Move object to layer collection
     - Update object pass_index

   - setup_dof_for_layers(layers: List[DepthLayerConfig], focus_layer: str) -> bool
     - Configure camera DOF based on layer distances
     - Set focus distance to center of focus_layer

   - get_layer_for_distance(distance: float, layers: List[DepthLayerConfig]) -> str
     - Determine which layer a distance falls into
     - Return layer name

   - auto_assign_by_distance(camera_name: str, layers: List[DepthLayerConfig]) -> Dict[str, List[str]]
     - Automatically assign scene objects to layers by distance from camera
     - Return mapping of layer_name -> object_names

3. Create configs/cinematic/support/depth_layers.yaml:
```yaml
# Depth Layer Presets for DOF and Compositing
layers:
  foreground:
    description: "Close-up detail layer"
    distance_min: 0.0
    distance_max: 1.0
    blur_amount: 0.8
    collection_name: "depth_foreground"
    render_pass: true

  midground:
    description: "Main subject layer"
    distance_min: 1.0
    distance_max: 3.0
    blur_amount: 0.0
    collection_name: "depth_midground"
    render_pass: false

  background:
    description: "Environment layer"
    distance_min: 3.0
    distance_max: 100.0
    blur_amount: 0.5
    collection_name: "depth_background"
    render_pass: true

  product_standard:
    description: "Standard product rendering layers"
    distance_min: 0.5
    distance_max: 5.0
    blur_amount: 0.0
    collection_name: "depth_product"
    render_pass: false

presets:
  product_shallow:
    description: "Shallow DOF for product detail"
    layers: ["foreground", "midground", "background"]
    focus_layer: "midground"

  product_deep:
    description: "Deep DOF for full product"
    layers: ["product_standard"]
    focus_layer: "product_standard"

  portrait:
    description: "Portrait-style layering"
    layers: ["foreground", "midground", "background"]
    focus_layer: "midground"
```
  </action>
  <verify>python3 -c "from lib.cinematic.depth_layers import create_depth_layer, assign_to_layer, setup_dof_for_layers; print('Depth layer functions imported')"</verify>
  <done>depth_layers.py with create_depth_layer(), assign_to_layer(), setup_dof_for_layers(), auto_assign_by_distance() and depth_layers.yaml created</done>
</task>

<task type="auto">
  <name>Task 4: Create composition.py - Guide Overlays</name>
  <files>lib/cinematic/composition.py, configs/cinematic/support/composition_guides.yaml</files>
  <action>
Create lib/cinematic/composition.py for viewport composition guides:

1. Create the module for composition guide overlays

2. Implement core functions:
   - create_guide_overlay(config: CompositionGuide) -> bool
     - Create viewport annotation for composition guide
     - Use Blender's gpencil or annotation system

   - show_rule_of_thirds(opacity: float = 0.5, color: Tuple = (1, 0.5, 0)) -> bool
     - Display rule of thirds grid
     - 2 vertical + 2 horizontal lines at 1/3 intervals

   - show_golden_ratio(opacity: float = 0.5, color: Tuple = (1, 0.5, 0)) -> bool
     - Display golden ratio spiral approximation
     - Phi = 1.618 ratio divisions

   - show_golden_spiral(opacity: float = 0.5, color: Tuple = (1, 0.5, 0)) -> bool
     - Display golden spiral overlay
     - Approximate with arc segments

   - show_center_cross(opacity: float = 0.5, color: Tuple = (1, 0.5, 0)) -> bool
     - Display center crosshair
     - Single vertical + horizontal through center

   - show_safe_areas(opacity: float = 0.3, color: Tuple = (0.5, 0.5, 0.5)) -> bool
     - Display title safe (90%) and action safe (93%) areas
     - Standard broadcast safe zones

   - clear_guides() -> bool
     - Remove all composition guide overlays

   - get_active_guides() -> List[str]
     - Return list of currently active guide types

3. Create configs/cinematic/support/composition_guides.yaml:
```yaml
# Composition Guide Presets
guides:
  rule_of_thirds:
    description: "Classic rule of thirds grid"
    guide_type: "rule_of_thirds"
    opacity: 0.5
    color: [1.0, 0.5, 0.0]
    show_safe_areas: false
    show_center: false

  golden_ratio:
    description: "Golden ratio (phi) composition"
    guide_type: "golden_ratio"
    opacity: 0.5
    color: [1.0, 0.8, 0.0]
    show_safe_areas: false
    show_center: false

  golden_spiral:
    description: "Fibonacci spiral overlay"
    guide_type: "golden_spiral"
    opacity: 0.4
    color: [0.0, 0.8, 1.0]
    show_safe_areas: false
    show_center: false

  center:
    description: "Center crosshair only"
    guide_type: "center_cross"
    opacity: 0.3
    color: [1.0, 0.0, 0.0]
    show_safe_areas: false
    show_center: true

  broadcast:
    description: "Broadcast safe areas"
    guide_type: "rule_of_thirds"
    opacity: 0.4
    color: [0.5, 0.5, 0.5]
    show_safe_areas: true
    show_center: true

  full:
    description: "All guides enabled"
    guide_type: "rule_of_thirds"
    opacity: 0.3
    color: [1.0, 0.5, 0.0]
    show_safe_areas: true
    show_center: true
```

Note: Blender annotation API requires careful handling. Use bpy.data.grease_pencils_v3 or annotations.
  </action>
  <verify>python3 -c "from lib.cinematic.composition import create_guide_overlay, show_rule_of_thirds, show_golden_ratio, clear_guides; print('Composition functions imported')"</verify>
  <done>composition.py with create_guide_overlay(), show_rule_of_thirds(), show_golden_ratio(), show_safe_areas(), clear_guides() and composition_guides.yaml created</done>
</task>

<task type="auto">
  <name>Task 5: Create lens_fx.py - Post-Process Lens Effects</name>
  <files>lib/cinematic/lens_fx.py, configs/cinematic/support/lens_fx_presets.yaml</files>
  <action>
Create lib/cinematic/lens_fx.py extending the lenses.py compositor patterns:

1. Create the module for post-process lens effects via compositor

2. Implement core functions:
   - setup_lens_fx_compositor() -> bool
     - Enable compositor and ensure basic nodes
     - Same pattern as lenses.py setup_compositor_for_lens()

   - apply_lens_fx(config: LensFXConfig) -> bool
     - Apply all enabled effects from config
     - Chain effects in correct order: bloom -> flare -> vignette -> chromatic -> grain

   - apply_bloom(intensity: float, threshold: float) -> bool
     - Add glare node with bloom settings
     - Use FOG_GLOW type

   - apply_flare(intensity: float, streaks: int) -> bool
     - Add glare node with ghost glow
     - Configure streak count

   - apply_vignette(intensity: float, roundness: float) -> bool
     - Add elliptical mask + mix node
     - Same pattern as lenses.py vignette

   - apply_chromatic_aberration(amount: float) -> bool
     - Add lens distortion node
     - Set dispersion parameter

   - apply_film_grain(amount: float) -> bool
     - Add noise/texture overlay
     - Use compositor noise node

   - clear_lens_fx() -> bool
     - Remove all lens FX nodes
     - Keep only Render Layers and Composite

   - get_active_fx() -> Dict[str, bool]
     - Return dict of effect_name -> enabled status

3. Create configs/cinematic/support/lens_fx_presets.yaml:
```yaml
# Lens Effects Presets for Post-Processing
effects:
  clean:
    description: "No effects - clean output"
    bloom_enabled: false
    bloom_intensity: 0.0
    bloom_threshold: 1.0
    flare_enabled: false
    flare_intensity: 0.0
    flare_streaks: 8
    vignette_enabled: false
    vignette_intensity: 0.0
    vignette_roundness: 0.5
    chromatic_enabled: false
    chromatic_amount: 0.0
    grain_enabled: false
    grain_amount: 0.0

  cinematic:
    description: "Cinematic look with subtle effects"
    bloom_enabled: true
    bloom_intensity: 0.2
    bloom_threshold: 0.9
    flare_enabled: true
    flare_intensity: 0.3
    flare_streaks: 6
    vignette_enabled: true
    vignette_intensity: 0.25
    vignette_roundness: 0.7
    chromatic_enabled: false
    chromatic_amount: 0.0
    grain_enabled: true
    grain_amount: 0.05

  vintage:
    description: "Vintage lens character"
    bloom_enabled: true
    bloom_intensity: 0.15
    bloom_threshold: 0.85
    flare_enabled: true
    flare_intensity: 0.5
    flare_streaks: 8
    vignette_enabled: true
    vignette_intensity: 0.4
    vignette_roundness: 0.5
    chromatic_enabled: true
    chromatic_amount: 0.002
    grain_enabled: true
    grain_amount: 0.1

  dreamy:
    description: "Soft, dreamy aesthetic"
    bloom_enabled: true
    bloom_intensity: 0.5
    bloom_threshold: 0.7
    flare_enabled: true
    flare_intensity: 0.4
    flare_streaks: 4
    vignette_enabled: true
    vignette_intensity: 0.2
    vignette_roundness: 0.9
    chromatic_enabled: false
    chromatic_amount: 0.0
    grain_enabled: false
    grain_amount: 0.0

  dramatic:
    description: "High contrast dramatic look"
    bloom_enabled: false
    bloom_intensity: 0.0
    bloom_threshold: 1.0
    flare_enabled: false
    flare_intensity: 0.0
    flare_streaks: 8
    vignette_enabled: true
    vignette_intensity: 0.5
    vignette_roundness: 0.3
    chromatic_enabled: false
    chromatic_amount: 0.0
    grain_enabled: true
    grain_amount: 0.15

  anamorphic:
    description: "Anamorphic lens simulation"
    bloom_enabled: true
    bloom_intensity: 0.3
    bloom_threshold: 0.8
    flare_enabled: true
    flare_intensity: 0.6
    flare_streaks: 2
    vignette_enabled: true
    vignette_intensity: 0.35
    vignette_roundness: 0.4
    chromatic_enabled: true
    chromatic_amount: 0.001
    grain_enabled: true
    grain_amount: 0.08
```

Follow the exact compositor patterns from lenses.py for node creation and linking.
  </action>
  <verify>python3 -c "from lib.cinematic.lens_fx import apply_lens_fx, apply_bloom, apply_vignette, clear_lens_fx; print('Lens FX functions imported')"</verify>
  <done>lens_fx.py with apply_lens_fx(), apply_bloom(), apply_flare(), apply_vignette(), apply_chromatic_aberration(), clear_lens_fx() and lens_fx_presets.yaml created</done>
</task>

</tasks>

<verification>
1. Verify all 5 modules can be imported
2. Verify all preset YAML files exist and are valid YAML
3. Verify functions have correct signatures matching types
4. Verify compositor functions follow lenses.py patterns
</verification>

<success_criteria>
- shuffler.py with generate_variations(), apply_variation(), create_shuffle_set()
- frame_store.py with capture_frame(), restore_frame(), compare_frames()
- depth_layers.py with create_depth_layer(), assign_to_layer(), setup_dof_for_layers()
- composition.py with create_guide_overlay(), show_rule_of_thirds(), show_golden_ratio(), clear_guides()
- lens_fx.py with apply_lens_fx(), apply_bloom(), apply_flare(), apply_vignette(), clear_lens_fx()
- All 4 YAML preset files created with valid structure
- All imports work without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06.7-support-systems/06.7-02-SUMMARY.md`
</output>
