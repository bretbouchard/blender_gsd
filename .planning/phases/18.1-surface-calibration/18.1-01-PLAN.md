# Phase 18.1-01: Surface Calibration Types & Configuration

**Phase**: 18.1 - Surface Calibration
**Requirement**: REQ-PROJ-02
**Priority**: P0
**Est. Effort**: 1 day
**Depends on**: Phase 18.0 (Projector Profile System)

## Goal

Create data types and configuration for 3-point surface alignment and calibration pattern generation.

## Background

From the design document:
- 3-point alignment assumes a **planar target surface**
- For multi-surface targets (reading room with cabinets, desks), use **4-point DLT alignment**
- Adapted from Compify's camera_align.py technique

## Tasks

### 1. Create Calibration Types (`lib/cinematic/projection/physical/calibration/types.py`)

```python
@dataclass
class CalibrationPoint:
    """Single calibration point with real-world and projector coordinates."""
    world_position: Tuple[float, float, float]  # 3D position in scene
    projector_uv: Tuple[float, float]           # 2D position in projector space (0-1)
    label: str                                   # Human-readable label (e.g., "Bottom Left")

@dataclass
class SurfaceCalibration:
    """Calibration data for a projection surface."""
    name: str
    calibration_type: CalibrationType  # THREE_POINT, FOUR_POINT_DLT
    points: List[CalibrationPoint]

    # Computed transform
    projector_transform: Optional[Matrix]  # 4x4 transform matrix
    calibration_error: float               # RMS error in pixels
    is_calibrated: bool

    # Metadata
    created_at: datetime
    last_modified: datetime

@dataclass
class CalibrationPattern:
    """Test pattern for physical alignment."""
    pattern_type: PatternType  # CHECKERBOARD, COLOR_BARS, GRID, CROSSHAIR
    resolution: Tuple[int, int]
    grid_size: int             # For checkerboard: squares per row/column
    color_depth: int           # Bits per channel (8, 10, 12)

class CalibrationType(Enum):
    THREE_POINT = "three_point"        # Planar surfaces
    FOUR_POINT_DLT = "four_point_dlt"  # Non-planar/multi-surface

class PatternType(Enum):
    CHECKERBOARD = "checkerboard"
    COLOR_BARS = "color_bars"
    GRID = "grid"
    CROSSHAIR = "crosshair"
    GRADIENT = "gradient"
```

### 2. Create Calibration Pattern Generator (`lib/cinematic/projection/physical/calibration/patterns.py`)

```python
def generate_checkerboard_pattern(
    resolution: Tuple[int, int],
    grid_size: int = 8,
    colors: Tuple[Color, Color] = ((1, 1, 1), (0, 0, 0))
) -> bpy.types.Image:
    """Generate checkerboard calibration pattern."""
    pass

def generate_color_bars_pattern(
    resolution: Tuple[int, int],
    smpte: bool = True  # SMPTE vs ARIB color bars
) -> bpy.types.Image:
    """Generate SMPTE/ARIB color bars for color calibration."""
    pass

def generate_grid_pattern(
    resolution: Tuple[int, int],
    spacing: int = 100,
    line_width: int = 2
) -> bpy.types.Image:
    """Generate grid pattern for alignment."""
    pass
```

### 3. Create Calibration YAML (`configs/cinematic/projection/calibration_patterns.yaml`)

```yaml
# Calibration pattern presets
patterns:
  checkerboard_standard:
    type: checkerboard
    grid_size: 8
    description: "8x8 checkerboard for alignment"

  checkerboard_fine:
    type: checkerboard
    grid_size: 16
    description: "16x16 fine checkerboard for precision alignment"

  color_bars_smpte:
    type: color_bars
    standard: smpte
    description: "SMPTE color bars for color calibration"

  grid_100px:
    type: grid
    spacing: 100
    line_width: 2
    description: "100px grid for keystone adjustment"

# Calibration presets
calibration_presets:
  planar_fast:
    type: three_point
    description: "Quick 3-point calibration for flat surfaces"
    tolerance_px: 5

  planar_precise:
    type: three_point
    description: "Precise 3-point calibration"
    tolerance_px: 1

  multi_surface:
    type: four_point_dlt
    description: "4-point DLT for non-planar surfaces"
    tolerance_px: 3
```

### 4. Create Surface Presets YAML (`configs/cinematic/projection/surface_presets.yaml`)

```yaml
# Common projection surface configurations
surfaces:
  # Planar surfaces
  flat_wall:
    type: planar
    description: "Standard flat wall"
    calibration_type: three_point
    default_points:
      - label: "Bottom Left"
        position: [0, 0, 0]
      - label: "Bottom Right"
        position: [1, 0, 0]
      - label: "Top Left"
        position: [0, 1, 0]

  garage_door:
    type: planar
    description: "Standard garage door (7ft x 16ft typical)"
    calibration_type: three_point
    dimensions:
      width_m: 4.88  # 16ft
      height_m: 2.13  # 7ft

  # Multi-surface targets
  reading_room:
    type: multi_surface
    description: "Reading room with cabinets and desks"
    calibration_type: four_point_dlt
    sub_surfaces:
      - name: "upper_cabinet"
        type: planar
      - name: "lower_cabinet"
        type: planar
      - name: "desk_surface"
        type: planar
```

## Deliverables

```
lib/cinematic/projection/physical/calibration/
├── __init__.py
├── types.py              # CalibrationPoint, SurfaceCalibration, CalibrationPattern
└── patterns.py           # Pattern generation functions

configs/cinematic/projection/
├── calibration_patterns.yaml
└── surface_presets.yaml
```

## Tests

- `test_calibration_types.py`: Data structure tests
- `test_pattern_generation.py`: Pattern image generation tests

## Acceptance Criteria

- [ ] CalibrationPoint, SurfaceCalibration types defined
- [ ] 3-point and 4-point DLT calibration types supported
- [ ] Checkerboard, color bars, grid patterns generate correctly
- [ ] YAML configuration files created
- [ ] 15+ unit tests passing
