---
phase: 06.2-lighting-system
plan: 03
type: execute
wave: 2
depends_on: ["06.2-01"]
files_modified:
  - lib/cinematic/gel.py
autonomous: true
must_haves:
  truths:
    - "User can apply gel presets (CTB, CTO, diffusion) to lights"
    - "User can create custom gel configurations"
    - "Combined gels work (CTO + diffusion)"
    - "Color temperature conversion works correctly"
  artifacts:
    - path: "lib/cinematic/gel.py"
      provides: "Gel application and color temperature functions"
      exports: ["apply_gel", "create_gel_from_preset", "kelvin_to_rgb", "combine_gels"]
      min_lines: 150
  key_links:
    - from: "lib/cinematic/gel.py"
      to: "lib/cinematic/types.py"
      via: "GelConfig import"
      pattern: "from .types import GelConfig"
    - from: "lib/cinematic/gel.py"
      to: "lib/cinematic/lighting.py"
      via: "light object manipulation"
      pattern: "light_obj.data"
---

<objective>
Create the gel/color filter system module.

Purpose: Implement gel.py for applying color filters and corrections to lights. Supports industry-standard CTB (Color Temperature Blue), CTO (Color Temperature Orange), diffusion grades, creative colors, and combined gels.

Output: lib/cinematic/gel.py with apply_gel, create_gel_from_preset, kelvin_to_rgb, and combine_gels functions.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.2-lighting-system/06.2-RESEARCH.md

# Reference patterns
@lib/cinematic/camera.py
@lib/cinematic/types.py
@configs/cinematic/lighting/gel_presets.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gel module foundation</name>
  <files>lib/cinematic/gel.py</files>
  <action>
Create lib/cinematic/gel.py with foundation:

1. Module docstring explaining gel system
2. Guarded bpy import (same pattern as camera.py)
3. Imports:
   ```python
   from __future__ import annotations
   from typing import Dict, Any, Optional, Tuple, List
   import math

   from .types import GelConfig
   from .preset_loader import get_gel_preset
   ```

4. Constants:
   ```python
   # Valid Kelvin range for color temperature
   KELVIN_MIN = 1000
   KELVIN_MAX = 40000

   # Blender 4.0+ for native temperature support
   BLENDER_40_MIN = (4, 0, 0)
   ```
</action>
  <verify>python3 -c "from lib.cinematic.gel import KELVIN_MIN, KELVIN_MAX; print(KELVIN_MIN, KELVIN_MAX)"</verify>
  <done>gel.py created with guarded imports and constants</done>
</task>

<task type="auto">
  <name>Task 2: Implement kelvin_to_rgb function</name>
  <files>lib/cinematic/gel.py</files>
  <action>
Add kelvin_to_rgb conversion function (fallback for Blender < 4.0):

```python
def kelvin_to_rgb(kelvin: float) -> Tuple[float, float, float]:
    """
    Convert color temperature in Kelvin to RGB.

    Uses Tanner Helland algorithm. Valid range: 1000K to 40000K.
    Common values:
    - Candle: 1900K
    - Tungsten: 3200K
    - Daylight: 5500K-6500K
    - Overcast: 7000K
    - Blue sky: 10000K+

    Args:
        kelvin: Color temperature in Kelvin

    Returns:
        RGB tuple (0-1 range)
    """
```

Implementation (from RESEARCH.md):
1. Clamp kelvin to KELVIN_MIN-KELVIN_MAX range
2. Convert to temp = kelvin / 100.0
3. Calculate red, green, blue using Tanner Helland algorithm
4. Clamp each channel to 0-255, then divide by 255.0
5. Return (r, g, b) tuple

This is a fallback for Blender < 4.0 which lacks native temperature support.
</action>
  <verify>python3 -c "from lib.cinematic.gel import kelvin_to_rgb; r,g,b = kelvin_to_rgb(5500); print(f'{r:.3f},{g:.3f},{b:.3f}')"</verify>
  <done>kelvin_to_rgb converts Kelvin temperature to RGB tuple</done>
</task>

<task type="auto">
  <name>Task 3: Implement apply_gel function</name>
  <files>lib/cinematic/gel.py</files>
  <action>
Add apply_gel function:

```python
def apply_gel(
    light_obj: Any,
    gel_config: GelConfig
) -> bool:
    """
    Apply gel/color filter to a light.

    Modifies light color, softness, and optionally uses native
    temperature mode on Blender 4.0+.

    Args:
        light_obj: Blender light object
        gel_config: GelConfig with gel settings

    Returns:
        True if successful, False if failed
    """
```

Implementation:
1. Guard: if not BLENDER_AVAILABLE, return False
2. Try/except wrapper
3. Get light data from light_obj.data
4. Apply color if specified (RGB tuple)
5. If temperature_shift > 0 and Blender 4.0+:
   - Use native use_temperature + temperature
6. If temperature_shift > 0 and Blender < 4.0:
   - Use kelvin_to_rgb conversion, multiply with existing color
7. Apply softness if > 0: light.shadow_soft_size
8. Return True on success
</action>
  <verify>python3 -c "from lib.cinematic.gel import apply_gel; print(apply_gel.__doc__[:40] if apply_gel.__doc__ else 'no doc')" 2>&1 | head -1</verify>
  <done>apply_gel function applies GelConfig to a light object</done>
</task>

<task type="auto">
  <name>Task 4: Implement create_gel_from_preset</name>
  <files>lib/cinematic/gel.py</files>
  <action>
Add create_gel_from_preset function:

```python
def create_gel_from_preset(preset_name: str) -> GelConfig:
    """
    Create a GelConfig from a preset name.

    Loads preset from configs/cinematic/lighting/gel_presets.yaml.

    Args:
        preset_name: Name of gel preset (e.g., "cto_full", "diffusion_half")

    Returns:
        GelConfig instance

    Raises:
        ValueError: If preset not found
    """
```

Implementation:
1. Call get_gel_preset(preset_name)
2. Extract fields: name, color, temperature_shift, softness, transmission
3. Create and return GelConfig instance
</action>
  <verify>python3 -c "from lib.cinematic.gel import create_gel_from_preset; g = create_gel_from_preset('cto_full'); print(g.name, g.color)"</verify>
  <done>create_gel_from_preset loads gel presets and creates GelConfig</done>
</task>

<task type="auto">
  <name>Task 5: Implement combine_gels function</name>
  <files>lib/cinematic/gel.py</files>
  <action>
Add combine_gels function for combined presets:

```python
def combine_gels(gel_names: List[str]) -> GelConfig:
    """
    Combine multiple gels into a single GelConfig.

    Multiplies colors, sums temperature_shifts, averages softness.

    Args:
        gel_names: List of gel preset names to combine

    Returns:
        Combined GelConfig
    """
```

Implementation:
1. Load each gel preset using get_gel_preset
2. Combine colors by multiplying RGB values
3. Sum temperature_shift values
4. Average softness values
5. Create and return combined GelConfig

This enables presets like "cto_diffusion" which combines CTO with diffusion.
</action>
  <verify>python3 -c "from lib.cinematic.gel import combine_gels; g = combine_gels(['cto_quarter', 'diffusion_half']); print(g.name)"</verify>
  <done>combine_gels creates combined gel from multiple preset names</done>
</task>

</tasks>

<verification>
1. Module imports: python3 -c "from lib.cinematic.gel import apply_gel, create_gel_from_preset, kelvin_to_rgb, combine_gels"
2. Kelvin conversion works: python3 -c "from lib.cinematic.gel import kelvin_to_rgb; rgb = kelvin_to_rgb(3200); print(len(rgb) == 3)"
3. Preset loading works: python3 -c "from lib.cinematic.gel import create_gel_from_preset; g = create_gel_from_preset('ctb_full'); print(g.color)"
4. Combine gels works: python3 -c "from lib.cinematic.gel import combine_gels; g = combine_gels(['cto_quarter', 'diffusion_half']); print(type(g).__name__)"
</verification>

<success_criteria>
- kelvin_to_rgb converts temperature to RGB correctly
- apply_gel applies GelConfig to light objects
- create_gel_from_preset loads presets from YAML
- combine_gels combines multiple gels
- All functions handle errors gracefully
- All functions follow guarded bpy import pattern
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-lighting-system/06.2-03-SUMMARY.md`
</output>
