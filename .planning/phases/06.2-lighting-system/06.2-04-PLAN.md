---
phase: 06.2-lighting-system
plan: 04
type: execute
wave: 2
depends_on: ["06.2-01"]
files_modified:
  - lib/cinematic/hdri.py
autonomous: true
must_haves:
  truths:
    - "User can set up HDRI environment lighting"
    - "User can load HDRI presets"
    - "HDRI exposure and rotation controls work"
    - "Background visibility can be toggled"
    - "Multi-path search finds HDRI files"
  artifacts:
    - path: "lib/cinematic/hdri.py"
      provides: "HDRI environment system functions"
      exports: ["setup_hdri", "load_hdri_preset", "find_hdri_path", "clear_hdri"]
      min_lines: 200
  key_links:
    - from: "lib/cinematic/hdri.py"
      to: "bpy.types.World"
      via: "World shader nodes"
      pattern: "scene.world"
    - from: "lib/cinematic/hdri.py"
      to: "ShaderNodeTexEnvironment"
      via: "HDRI texture loading"
      pattern: "ShaderNodeTexEnvironment"
---

<objective>
Create the HDRI environment lighting system module.

Purpose: Implement hdri.py for setting up environment lighting using HDRI maps. Supports multi-path search for HDRI files, world shader node setup, exposure/rotation control, and background visibility toggle.

Output: lib/cinematic/hdri.py with setup_hdri, load_hdri_preset, find_hdri_path, and clear_hdri functions.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.2-lighting-system/06.2-RESEARCH.md

# Reference patterns
@lib/cinematic/camera.py
@lib/cinematic/types.py
@configs/cinematic/lighting/hdri_presets.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HDRI module foundation</name>
  <files>lib/cinematic/hdri.py</files>
  <action>
Create lib/cinematic/hdri.py with foundation:

1. Module docstring explaining HDRI system
2. Guarded bpy import
3. Imports:
   ```python
   from __future__ import annotations
   from pathlib import Path
   from typing import Dict, Any, Optional, List
   import math

   from .types import HDRIConfig
   from .preset_loader import get_hdri_preset
   ```

4. Constants:
   ```python
   # Default HDRI search paths (in priority order)
   DEFAULT_HDRI_PATHS = [
       Path("assets/hdri"),           # Project local
       Path("configs/cinematic/lighting/hdri"),  # Config bundled
       Path("~/hdri_library").expanduser(),  # External library
   ]

   # Common HDRI file extensions
   HDRI_EXTENSIONS = [".hdr", ".exr", ".hdri"]
   ```
</action>
  <verify>python3 -c "from lib.cinematic.hdri import DEFAULT_HDRI_PATHS, HDRI_EXTENSIONS; print(len(DEFAULT_HDRI_PATHS), HDRI_EXTENSIONS)"</verify>
  <done>hdri.py created with guarded imports, search paths, and extensions constant</done>
</task>

<task type="auto">
  <name>Task 2: Implement find_hdri_path function</name>
  <files>lib/cinematic/hdri.py</files>
  <action>
Add find_hdri_path multi-path search function:

```python
def find_hdri_path(
    filename: str,
    search_paths: Optional[List[Path]] = None
) -> Optional[Path]:
    """
    Find HDRI file using multi-path search.

    Searches in order:
    1. Project local: assets/hdri/
    2. Config bundled: configs/cinematic/lighting/hdri/
    3. External library: ~/hdri_library/

    Args:
        filename: HDRI filename (e.g., "studio_bright_4k.hdr")
        search_paths: Custom search paths (uses DEFAULT_HDRI_PATHS if None)

    Returns:
        Path to found file, or None if not found
    """
```

Implementation:
1. Use search_paths or DEFAULT_HDRI_PATHS
2. For each path:
   - Check if path / filename exists
   - Return Path if found
3. Return None if not found in any path

This prevents FileNotFoundError when HDRI images are in different locations.
</action>
  <verify>python3 -c "from lib.cinematic.hdri import find_hdri_path; print(find_hdri_path.__doc__[:40] if find_hdri_path.__doc__ else 'no doc')" 2>&1 | head -1</verify>
  <done>find_hdri_path searches multiple locations for HDRI files</done>
</task>

<task type="auto">
  <name>Task 3: Implement setup_hdri function</name>
  <files>lib/cinematic/hdri.py</files>
  <action>
Add setup_hdri function for world shader node setup:

```python
def setup_hdri(
    hdri_path: str,
    exposure: float = 0.0,
    rotation: float = 0.0,
    background_visible: bool = False,
    saturation: float = 1.0
) -> bool:
    """
    Set up HDRI environment lighting via world shader nodes.

    Creates node tree:
    TexCoord -> Mapping -> Environment Texture -> Background -> Output

    Args:
        hdri_path: Path to HDRI file
        exposure: Exposure adjustment (0 = default, positive = brighter)
        rotation: Rotation angle in radians
        background_visible: If True, HDRI visible in render background
        saturation: Color saturation (1.0 = normal)

    Returns:
        True if successful, False if failed
    """
```

Implementation (from RESEARCH.md pattern):
1. Guard: if not BLENDER_AVAILABLE, return False
2. Try/except wrapper
3. Get or create scene.world
4. Enable world.use_nodes = True
5. Clear existing nodes
6. Create nodes: TexCoord, Mapping, Environment Texture, Background, Output
7. Load HDRI image into Environment Texture node
8. Set Background strength: 1.0 + exposure
9. Set Mapping rotation for rotation parameter
10. Link nodes in order
11. Set background visibility if supported
12. Return True on success
</action>
  <verify>python3 -c "from lib.cinematic.hdri import setup_hdri; print(setup_hdri.__doc__[:40] if setup_hdri.__doc__ else 'no doc')" 2>&1 | head -1</verify>
  <done>setup_hdri creates world shader node tree with HDRI environment</done>
</task>

<task type="auto">
  <name>Task 4: Implement load_hdri_preset function</name>
  <files>lib/cinematic/hdri.py</files>
  <action>
Add load_hdri_preset function:

```python
def load_hdri_preset(
    preset_name: str,
    search_paths: Optional[List[Path]] = None
) -> bool:
    """
    Load and apply HDRI preset by name.

    Loads preset from configs/cinematic/lighting/hdri_presets.yaml
    and sets up the HDRI environment.

    Args:
        preset_name: Name of HDRI preset (e.g., "studio_bright", "golden_hour")
        search_paths: Custom HDRI search paths

    Returns:
        True if successful, False if failed
    """
```

Implementation:
1. Load preset using get_hdri_preset(preset_name)
2. Extract file path from preset
3. Call find_hdri_path to locate the file
4. If not found, return False
5. Call setup_hdri with preset parameters (exposure, rotation, background_visible)
6. Return result
</action>
  <verify>python3 -c "from lib.cinematic.hdri import load_hdri_preset; print(load_hdri_preset.__doc__[:40] if load_hdri_preset.__doc__ else 'no doc')" 2>&1 | head -1</verify>
  <done>load_hdri_preset loads preset and sets up HDRI environment</done>
</task>

<task type="auto">
  <name>Task 5: Implement clear_hdri function</name>
  <files>lib/cinematic/hdri.py</files>
  <action>
Add clear_hdri function:

```python
def clear_hdri() -> bool:
    """
    Clear HDRI environment and reset to default world.

    Returns:
        True if successful, False if failed
    """
```

Implementation:
1. Guard: if not BLENDER_AVAILABLE, return False
2. Try/except wrapper
3. Get scene.world if exists
4. Clear node tree nodes
5. Create simple Background node with white color
6. Return True on success

This allows resetting to clean state without HDRI.
</action>
  <verify>python3 -c "from lib.cinematic.hdri import clear_hdri; print(clear_hdri.__doc__[:30] if clear_hdri.__doc__ else 'no doc')" 2>&1 | head -1</verify>
  <done>clear_hdri resets world to default state</done>
</task>

</tasks>

<verification>
1. Module imports: python3 -c "from lib.cinematic.hdri import setup_hdri, load_hdri_preset, find_hdri_path, clear_hdri"
2. Search paths defined: python3 -c "from lib.cinematic.hdri import DEFAULT_HDRI_PATHS; print(len(DEFAULT_HDRI_PATHS) >= 3)"
3. Extensions defined: python3 -c "from lib.cinematic.hdri import HDRI_EXTENSIONS; print('.hdr' in HDRI_EXTENSIONS)"
4. Function docstrings present
</verification>

<success_criteria>
- find_hdri_path searches multiple locations for HDRI files
- setup_hdri creates world shader node tree correctly
- load_hdri_preset loads preset and applies HDRI
- clear_hdri resets world to default
- All functions handle errors gracefully
- All functions follow guarded bpy import pattern
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-lighting-system/06.2-04-SUMMARY.md`
</output>
