# Phase 11.1: Timeline System

**Phase**: 11.1
**Priority**: P1
**Dependencies**: Phase 6.x (Core Cinematic)
**Est. Duration**: 4-5 days

---

## Goal

Implement timeline and editorial system for assembling shots into sequences.

---

## Requirements

- REQ-EDIT-01: Timeline creation and management
- REQ-EDIT-02: Clip placement and trimming
- REQ-EDIT-03: Transitions (cut, dissolve, wipe)
- REQ-EDIT-04: EDL/XML export
- REQ-EDIT-05: Runtime calculation

---

## Plans

### Plan 11.1-01: Timeline Types

**Deliverable**: `lib/editorial/timeline_types.py`

```python
@dataclass
class Timecode:
    """SMPTE timecode representation."""
    hours: int = 0
    minutes: int = 0
    seconds: int = 0
    frames: int = 0
    frame_rate: float = 24.0

    def to_frames(self) -> int:
        """Convert to total frames."""
        pass

    @classmethod
    def from_frames(cls, frames: int, frame_rate: float) -> "Timecode":
        """Create from frame count."""
        pass

    def __str__(self) -> str:
        """Return SMPTE format (HH:MM:SS:FF)."""
        pass

@dataclass
class Clip:
    """Single clip on timeline."""
    name: str
    source_path: str  # Path to source media
    source_in: Timecode  # Start point in source
    source_out: Timecode  # End point in source
    record_in: Timecode  # Start point on timeline
    record_out: Timecode  # End point on timeline
    track: int = 1  # Video track number

    # Metadata
    scene: int = 0
    take: int = 1
    notes: str = ""

@dataclass
class Transition:
    """Transition between clips."""
    type: str  # cut, dissolve, wipe, fade
    duration: int = 0  # Frames (0 for cut)
    from_clip: str = ""
    to_clip: str = ""
    wipe_direction: str = "left"  # For wipe type

@dataclass
class Track:
    """Timeline track."""
    name: str
    track_type: str  # video, audio
    track_number: int
    clips: List[Clip] = field(default_factory=list)
    muted: bool = False
    locked: bool = False

@dataclass
class Timeline:
    """Complete timeline."""
    name: str
    frame_rate: float = 24.0
    duration: Timecode = field(default_factory=Timecode)
    video_tracks: List[Track] = field(default_factory=list)
    audio_tracks: List[Track] = field(default_factory=list)
    transitions: List[Transition] = field(default_factory=list)
    markers: List[Marker] = field(default_factory=list)

@dataclass
class Marker:
    """Timeline marker."""
    name: str
    position: Timecode
    color: str = "blue"
    note: str = ""
```

**Tasks**:
1. Create Timecode class with all operations
2. Create Clip dataclass
3. Create Transition dataclass
4. Create Track and Timeline
5. Add serialization

---

### Plan 11.1-02: Timeline Manager

**Deliverable**: `lib/editorial/timeline_manager.py`

```python
class TimelineManager:
    """Manage timeline operations."""

    def __init__(self, timeline: Timeline):
        self.timeline = timeline

    # Clip operations
    def add_clip(self, clip: Clip) -> None:
        """Add clip to timeline."""
        pass

    def remove_clip(self, clip_name: str) -> None:
        """Remove clip from timeline."""
        pass

    def move_clip(self, clip_name: str, new_position: Timecode) -> None:
        """Move clip to new position."""
        pass

    def trim_clip_in(self, clip_name: str, new_in: Timecode) -> None:
        """Trim clip in point."""
        pass

    def trim_clip_out(self, clip_name: str, new_out: Timecode) -> None:
        """Trim clip out point."""
        pass

    def slip_clip(self, clip_name: str, offset: int) -> None:
        """Slip clip (change source in/out, keep duration)."""
        pass

    def slide_clip(self, clip_name: str, offset: int) -> None:
        """Slide clip (move position, adjust adjacent clips)."""
        pass

    # Transition operations
    def add_transition(self, transition: Transition) -> None:
        """Add transition between clips."""
        pass

    def remove_transition(self, from_clip: str) -> None:
        """Remove transition."""
        pass

    # Query
    def get_clip_at(self, position: Timecode, track: int) -> Optional[Clip]:
        """Get clip at timeline position."""
        pass

    def get_all_clips(self) -> List[Clip]:
        """Get all clips in timeline order."""
        pass

    def calculate_duration(self) -> Timecode:
        """Calculate total timeline duration."""
        pass

    def find_gaps(self) -> List[Tuple[Timecode, Timecode]]:
        """Find gaps between clips."""
        pass
```

**Tasks**:
1. Implement TimelineManager class
2. Implement clip operations
3. Implement transition operations
4. Implement query methods
5. Test all operations

---

### Plan 11.1-03: Transitions

**Deliverable**: `lib/editorial/transitions.py`

```python
def create_cut() -> Transition:
    """Create cut transition (instant)."""
    return Transition(type="cut", duration=0)

def create_dissolve(duration: int = 12) -> Transition:
    """Create dissolve/crossfade transition."""
    pass

def create_wipe(direction: str = "left", duration: int = 12) -> Transition:
    """Create wipe transition."""
    pass

def create_fade_to_black(duration: int = 24) -> Transition:
    """Create fade to black."""
    pass

def create_fade_from_black(duration: int = 24) -> Transition:
    """Create fade from black."""
    pass

# Apply transitions in Blender
def apply_transition_blender(transition: Transition, from_clip: Clip, to_clip: Clip) -> None:
    """Apply transition in Blender VSE."""
    pass

def create_dissolve_effect(duration: int) -> Any:
    """Create Blender cross effect."""
    pass

def create_wipe_effect(direction: str, duration: int) -> Any:
    """Create Blender wipe effect."""
    pass
```

**Tasks**:
1. Implement transition creation
2. Implement Blender VSE integration
3. Test all transition types

---

### Plan 11.1-04: Export Formats

**Deliverable**: `lib/editorial/export.py`

```python
def export_edl(timeline: Timeline, path: str) -> None:
    """Export as EDL (Edit Decision List)."""
    pass

def export_xml(timeline: Timeline, path: str) -> None:
    """Export as FCPXML (Final Cut Pro XML)."""
    pass

def export_aaf(timeline: Timeline, path: str) -> None:
    """Export as AAF (Avid)."""
    pass

def export_otio(timeline: Timeline, path: str) -> None:
    """Export as OpenTimelineIO JSON."""
    pass

def export_fcpxml(timeline: Timeline, path: str) -> None:
    """Export as Final Cut Pro XML."""
    pass

# EDL format
def generate_edl_content(timeline: Timeline) -> str:
    """Generate EDL file content."""
    # Standard CMX 3600 format
    pass

# XML format
def generate_xml_content(timeline: Timeline) -> str:
    """Generate FCPXML content."""
    pass
```

**Tasks**:
1. Implement EDL export
2. Implement XML export
3. Implement OTIO export (if library available)
4. Test import in other applications

---

### Plan 11.1-05: Import Formats

**Deliverable**: `lib/editorial/import.py`

```python
def import_edl(path: str) -> Timeline:
    """Import from EDL file."""
    pass

def import_xml(path: str) -> Timeline:
    """Import from FCPXML file."""
    pass

def import_otio(path: str) -> Timeline:
    """Import from OpenTimelineIO JSON."""
    pass

def parse_edl(content: str, frame_rate: float) -> Timeline:
    """Parse EDL file content."""
    pass

def parse_xml(content: str) -> Timeline:
    """Parse FCPXML content."""
    pass
```

**Tasks**:
1. Implement EDL parsing
2. Implement XML parsing
3. Test with sample files

---

### Plan 11.1-06: Assembly

**Deliverable**: `lib/editorial/assembly.py`

```python
def assemble_from_shot_list(shots: List[ShotConfig], timeline_name: str) -> Timeline:
    """Create timeline from shot list."""
    pass

def auto_sequence_clips(clips: List[Clip], transition_type: str = "cut") -> Timeline:
    """Automatically sequence clips."""
    pass

def conform_timeline(timeline: Timeline, source_clips: Dict[str, str]) -> Timeline:
    """Relink timeline to new source clips."""
    pass

def create_sequence_from_scenes(scenes: List[Scene]) -> Timeline:
    """Create timeline from script scenes."""
    pass

# Utilities
def calculate_total_runtime(timeline: Timeline) -> float:
    """Calculate total runtime in minutes."""
    pass

def generate_cut_list(timeline: Timeline) -> List[Dict]:
    """Generate cut list for online editing."""
    pass
```

**Tasks**:
1. Implement shot list assembly
2. Implement auto-sequencing
3. Implement conform
4. Implement runtime calculation
5. Test end-to-end

---

## Acceptance Criteria

- [ ] Timeline creates and manages clips
- [ ] Transitions apply correctly
- [ ] EDL export produces valid files
- [ ] XML export works with FCP
- [ ] Import loads external timelines
- [ ] Runtime calculation accurate
- [ ] Cut list generates correctly

---

## Files

```
lib/editorial/
├── __init__.py
├── timeline_types.py      # Data structures
├── timeline_manager.py    # Operations
├── transitions.py         # Transition effects
├── export.py              # EDL/XML export
├── import.py              # EDL/XML import
└── assembly.py            # Timeline assembly

configs/editorial/
├── timeline_templates.yaml
└── export_presets.yaml
```
