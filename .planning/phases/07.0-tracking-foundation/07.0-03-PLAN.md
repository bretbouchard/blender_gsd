---
phase: 07.0-tracking-foundation
plan: 03
type: execute
wave: 2
depends_on: ["07.0-01"]
files_modified:
  - lib/cinematic/tracking/footage.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Footage metadata can be extracted from video files"
    - "ffprobe provides comprehensive video metadata"
    - "FootageMetadata dataclass stores extracted information"
    - "Frame rate is parsed correctly from rational format"
  artifacts:
    - path: "lib/cinematic/tracking/footage.py"
      provides: "Footage analysis and metadata extraction"
      min_lines: 100
      exports: ["extract_metadata", "analyze_footage", "get_frame_rate"]
  key_links:
    - from: "lib/cinematic/tracking/footage.py"
      to: "lib/cinematic/tracking/types.py"
      via: "FootageMetadata type"
      pattern: "from .types import FootageMetadata"
---

<objective>
Create footage analysis module for video metadata extraction.

Purpose: Implement ffprobe-based video metadata extraction following research patterns.
Output: footage.py with extract_metadata(), analyze_footage() functions.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07.0-tracking-foundation/07.0-RESEARCH.md
@.planning/REQUIREMENTS_TRACKING.md

# Reference types from Plan 01
@lib/cinematic/tracking/types.py
</context>

<tasks>

<task type="auto">
  <name>Create footage.py with metadata extraction</name>
  <files>lib/cinematic/tracking/footage.py</files>
  <action>
Create the footage module with ffprobe-based metadata extraction.

Follow the research patterns from 07.0-RESEARCH.md:

1. Import dependencies:
   - subprocess for ffprobe calls
   - json for parsing ffprobe output
   - Path from pathlib
   - FootageMetadata from .types

2. Implement extract_metadata(video_path: str) -> FootageMetadata:
   - Run ffprobe with JSON output
   - Parse video stream for resolution, codec, frame rate
   - Handle frame rate as rational (e.g., "30000/1001" -> 29.97)
   - Extract format duration
   - Return populated FootageMetadata

3. Implement get_frame_rate(stream: dict) -> float:
   - Parse r_frame_rate field (format: "num/den")
   - Handle edge cases (missing field, division by zero)
   - Return float frame rate

4. Implement analyze_footage(video_path: str) -> dict:
   - Call extract_metadata() for basic info
   - Add placeholder content analysis (motion_blur, rolling_shutter)
   - Return comprehensive analysis dict

5. Add BLENDER_AVAILABLE guard and optional Blender integration:
   - load_footage_to_clip() function using bpy.data.movieclips

Key implementation from RESEARCH.md:
```python
def extract_metadata(video_path: str) -> FootageMetadata:
    cmd = [
        'ffprobe', '-v', 'quiet',
        '-print_format', 'json',
        '-show_format', '-show_streams',
        video_path
    ]
    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        raise RuntimeError(f"ffprobe failed: {result.stderr}")

    data = json.loads(result.stdout)
    metadata = FootageMetadata(filename=Path(video_path).name)

    for stream in data.get('streams', []):
        if stream.get('codec_type') == 'video':
            metadata.resolution = (stream.get('width', 1920), stream.get('height', 1080))
            metadata.codec = stream.get('codec_name', '')

            fps_str = stream.get('r_frame_rate', '24/1')
            if '/' in fps_str:
                num, den = fps_str.split('/')
                metadata.frame_rate = float(num) / float(den) if float(den) > 0 else 24.0
            else:
                metadata.frame_rate = float(fps_str)
            break

    fmt = data.get('format', {})
    if 'duration' in fmt:
        metadata.duration_seconds = float(fmt['duration'])
        metadata.duration_frames = int(metadata.duration_seconds * metadata.frame_rate)

    return metadata
```

Add proper error handling for:
- ffprobe not found
- Invalid video file
- Missing streams
  </action>
  <verify>
python3 -c "
from lib.cinematic.tracking.footage import extract_metadata, analyze_footage, get_frame_rate

# Test frame rate parsing
assert get_frame_rate({'r_frame_rate': '24/1'}) == 24.0
assert get_frame_rate({'r_frame_rate': '30000/1001'}) == 29.97
assert abs(get_frame_rate({'r_frame_rate': '25/1'}) - 25.0) < 0.01

# Test with missing field
assert get_frame_rate({}) == 24.0  # Default

print('Footage module functions work')
" 2>&1 || echo "Note: ffprobe tests require ffmpeg installed"
  </verify>
  <done>
- footage.py exists with extract_metadata(), analyze_footage(), get_frame_rate()
- Frame rate parsing handles rational format correctly
- Error handling for missing ffprobe and invalid files
  </done>
</task>

</tasks>

<verification>
# Phase-level verification
1. footage.py imports without errors
2. get_frame_rate() correctly parses rational frame rates
3. FootageMetadata type is used for return values
4. Subprocess calls use proper error handling
</verification>

<success_criteria>
- lib/cinematic/tracking/footage.py exists
- extract_metadata() function implemented
- get_frame_rate() handles rational format (e.g., 30000/1001)
- analyze_footage() returns comprehensive analysis dict
</success_criteria>

<output>
After completion, create `.planning/phases/07.0-tracking-foundation/07.0-03-SUMMARY.md`
</output>
