---
phase: 06.5-animation-system
plan: 02
type: execute
wave: 2
depends_on:
  - 06.5-01
files_modified:
  - lib/cinematic/animation.py
  - lib/cinematic/motion_path.py
autonomous: true

must_haves:
  truths:
    - "Camera orbit animation creates keyframes around plumb bob target"
    - "Turntable animation rotates subject with LINEAR interpolation"
    - "Dolly/truck animations move camera along forward/lateral axes"
    - "Rack focus animates DoF focus_distance between values"
    - "Easing functions apply smooth acceleration/deceleration"
    - "Motion paths generate Bezier curve points procedurally"
  artifacts:
    - path: "lib/cinematic/animation.py"
      provides: "Camera animation functions and keyframe generation"
      exports: ["create_orbit_animation", "create_dolly_animation", "create_turntable_animation", "create_rack_focus_animation", "apply_camera_move_preset", "clear_animation"]
      min_lines: 400
    - path: "lib/cinematic/motion_path.py"
      provides: "Procedural motion path generation"
      exports: ["generate_bezier_path", "create_motion_path_curve", "setup_camera_follow_path", "apply_easing"]
      min_lines: 250
  key_links:
    - from: "lib/cinematic/animation.py"
      to: "lib/cinematic/plumb_bob.py"
      via: "calculate_plumb_bob for orbit center"
      pattern: "from.*plumb_bob import"
    - from: "lib/cinematic/animation.py"
      to: "lib/cinematic/camera.py"
      via: "get_active_camera, set_focus_mode"
      pattern: "from.*camera import"
    - from: "lib/cinematic/motion_path.py"
      to: "bpy.data.curves"
      via: "Create Bezier curve object for path"
      pattern: "bpy.data.curves.new"
---

<objective>
Implement the core animation modules for camera moves, turntable rotation, and procedural motion paths.

Purpose: Provide the animation execution layer that creates keyframes, applies easing curves, and generates motion paths for cinematic shots.
Output: animation.py (camera animations, turntable), motion_path.py (Bezier paths, Follow Path constraint setup)
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.5-animation-system/06.5-RESEARCH.md
@lib/cinematic/types.py
@lib/cinematic/camera.py
@lib/cinematic/plumb_bob.py
@configs/cinematic/animation/camera_moves.yaml
@configs/cinematic/animation/easing_curves.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create animation.py Module</name>
  <files>lib/cinematic/animation.py</files>
  <action>
Create the animation.py module with the following functions:

**Imports and Setup:**
```python
from __future__ import annotations
from typing import Dict, Any, Optional, List, Tuple
import math

from .types import AnimationConfig, TurntableConfig
from .preset_loader import get_camera_move_preset, get_easing_preset, get_turntable_preset

# Guarded imports
try:
    import bpy
    from mathutils import Vector
    BLENDER_AVAILABLE = True
except ImportError:
    bpy = None
    Vector = None
    BLENDER_AVAILABLE = False
```

**Easing Functions (internal):**
- `apply_easing(t: float, easing: str) -> float`: Apply easing function to normalized time 0-1
  - Support: linear, ease_in, ease_out, ease_in_out, ease_in_quad, ease_out_quad, ease_in_cubic, ease_out_cubic, ease_in_out_cubic, ease_out_bounce, ease_out_elastic
  - Follow formulas from easing_curves.yaml and RESEARCH.md

**Core Animation Functions:**
- `create_orbit_animation(camera_name, target_position, radius, angle_range, duration, easing, start_frame)`: Create orbit keyframes around target
  - Use trigonometry: x = center.x + radius * sin(angle), y = center.y - radius * cos(angle)
  - Add Track To constraint pointing at target
  - Set LINEAR interpolation for constant speed
  - Clear existing animation data first

- `create_dolly_animation(camera_name, distance, direction, duration, easing, start_frame)`: Move camera forward/backward
  - Calculate forward direction from camera's -Z axis
  - Apply eased distance to position keyframes
  - Support directions: forward, backward

- `create_truck_animation(camera_name, distance, direction, duration, easing, start_frame)`: Lateral camera movement
  - Calculate right direction from camera's X axis
  - Support directions: left, right

- `create_crane_animation(camera_name, elevation_range, distance, duration, easing, start_frame)`: Vertical crane movement
  - Combine forward movement with vertical elevation
  - Support elevation in degrees or meters

- `create_pan_animation(camera_name, angle, direction, duration, easing, start_frame)`: Pan camera rotation
  - Rotate camera around local Z axis
  - Support directions: left, right

- `create_tilt_animation(camera_name, angle, direction, duration, easing, start_frame)`: Tilt camera rotation
  - Rotate camera around local X axis
  - Support directions: up, down

- `create_rack_focus_animation(camera_name, from_distance, to_distance, duration, easing, start_frame)`: Animate focus distance
  - Keyframe dof.focus_distance
  - Enable DoF if not already enabled

- `create_push_in_animation(camera_name, dolly_distance, focal_from, focal_to, duration, start_frame)`: Combined dolly + zoom
  - Simultaneous dolly movement and focal length change
  - Creates vertigo/dolly zoom effect

**Turntable Functions:**
- `create_turntable_animation(subject_name, config)`: Rotate subject object for product showcase
  - Set rotation_mode to 'XYZ' for Euler keyframing
  - Create start/end keyframes for rotation_euler
  - Use LINEAR interpolation for constant speed
  - Support axis selection (X, Y, Z)
  - Convert direction to positive/negative rotation

- `apply_turntable_preset(subject_name, preset_name, start_frame)`: Apply turntable preset to subject

**Preset Application:**
- `apply_camera_move_preset(camera_name, preset_name, target_position, start_frame)`: Apply camera move from preset
  - Load preset from get_camera_move_preset()
  - Dispatch to appropriate create_*_animation() function based on preset type

**Utility Functions:**
- `clear_animation(object_name)`: Clear all animation data from object
- `set_scene_frame_range(start_frame, end_frame)`: Set scene frame_start and frame_end
- `create_animation_target_empty(position, name)`: Create empty for Track To target

**Key Implementation Details:**
- Always use `obj.keyframe_insert(data_path=..., frame=frame)` directly (NOT bpy.ops)
- Always set `kp.interpolation = 'LINEAR'` for constant-speed motion (except ease_in_out presets)
- Always clear existing animation data before creating new: `obj.animation_data_clear()`
- Use `math.radians()` for all angle conversions (API uses radians, presets use degrees)
</action>
  <verify>test -f lib/cinematic/animation.py && grep -c "create_orbit_animation\|create_turntable_animation\|apply_easing\|BLENDER_AVAILABLE" lib/cinematic/animation.py</verify>
  <done>animation.py module exists with orbit, dolly, turntable, rack_focus functions and easing support</done>
</task>

<task type="auto">
  <name>Task 2: Create motion_path.py Module</name>
  <files>lib/cinematic/motion_path.py</files>
  <action>
Create the motion_path.py module for procedural path generation:

**Imports and Setup:**
```python
from __future__ import annotations
from typing import Dict, Any, Optional, List, Tuple
import math

from .types import MotionPathConfig
from .preset_loader import get_camera_move_preset

try:
    import bpy
    from mathutils import Vector
    BLENDER_AVAILABLE = True
except ImportError:
    bpy = None
    Vector = None
    BLENDER_AVAILABLE = False
```

**Path Generation Functions:**
- `generate_bezier_path(control_points, segments)`: Generate points along cubic Bezier curve
  - Accept list of 4 control points (tuples of x,y,z)
  - Return list of (position, t_value) tuples
  - Use cubic Bezier formula: B(t) = (1-t)^3*P0 + 3(1-t)^2*t*P1 + 3(1-t)*t^2*P2 + t^3*P3

- `generate_arc_path(center, radius, angle_start, angle_end, segments, axis)`: Generate arc path points
  - Support Z-axis (horizontal) and Y-axis (vertical) arcs
  - Return list of Vector positions

- `generate_orbit_path(center, radius, angle_range, elevation, segments)`: Generate procedural orbit path
  - Create points around center with optional elevation change
  - Return list of (position, quaternion) tuples with look-at rotation

- `interpolate_catmull_rom(points, segments)`: Catmull-Rom spline interpolation
  - Smooth interpolation through multiple points
  - Return list of Vector positions

**Path Object Creation:**
- `create_motion_path_curve(points, name)`: Create Blender Curve object from points
  - Create CurveData with Bezier splines
  - Create CurveObject and link to scene
  - Return curve object

- `setup_camera_follow_path(camera_name, curve_name, duration, look_at)`: Setup Follow Path constraint
  - Add FOLLOW_PATH constraint to camera
  - Set target to curve
  - Animate offset_factor from 0 to 100
  - Configure use_curve_follow for rotation along path
  - Support look_at modes: plumb_bob, forward, manual

**Utility Functions:**
- `calculate_path_length(points)`: Calculate total path length
- `get_point_at_distance(points, distance)`: Get interpolated point at specific distance along path
- `sample_path_uniformly(points, sample_count)`: Resample path for uniform distribution

**Config-Based Functions:**
- `create_motion_path_from_config(config, target_position)`: Create path from MotionPathConfig
  - Dispatch to appropriate generation function based on path_type
  - Apply preset if config.preset is set
  - Create curve object and optionally setup follow path

**Key Implementation Details:**
- Use bmesh for mesh operations if needed (context-free)
- Use bpy.data.curves.new() for curve creation
- Handle look_at rotation using to_track_quat('-Z', 'Y')
</action>
  <verify>test -f lib/cinematic/motion_path.py && grep -c "generate_bezier_path\|create_motion_path_curve\|setup_camera_follow_path\|BLENDER_AVAILABLE" lib/cinematic/motion_path.py</verify>
  <done>motion_path.py module exists with Bezier path generation and Follow Path constraint setup</done>
</task>

</tasks>

<verification>
1. animation.py exists with orbit, dolly, truck, crane, pan, tilt, rack_focus, push_in functions
2. animation.py has create_turntable_animation with LINEAR interpolation
3. animation.py has apply_easing function supporting all easing types from easing_curves.yaml
4. motion_path.py exists with generate_bezier_path function
5. motion_path.py has create_motion_path_curve for Blender curve creation
6. motion_path.py has setup_camera_follow_path for constraint setup
7. Both modules have BLENDER_AVAILABLE guards and proper error handling
</verification>

<success_criteria>
- animation.py: 400+ lines with all camera animation types
- motion_path.py: 250+ lines with Bezier path and Follow Path support
- All keyframe operations use direct API (obj.keyframe_insert), not bpy.ops
- LINEAR interpolation set for constant-speed motion
- All angles converted with math.radians()
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-animation-system/06.5-02-SUMMARY.md`
</output>
