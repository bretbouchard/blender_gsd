# Plan 19.1-01: Types & Configuration

**Phase:** 19.1 - Tentacle Geometry
**Est. Time:** 2-3 hours
**Status:** Planned

---

## Goal

Create core data types and YAML configuration system for procedural tentacle generation.

---

## Deliverables

| File | Description |
|------|-------------|
| `lib/tentacle/__init__.py` | Package initialization |
| `lib/tentacle/types.py` | Core dataclasses |
| `lib/tentacle/presets.py` | YAML preset loader |
| `configs/tentacle/presets.yaml` | Geometry presets |
| `tests/unit/test_tentacle_types.py` | Unit tests |

---

## Type Definitions

### TentacleConfig

```python
@dataclass
class TentacleConfig:
    """Configuration for procedural tentacle generation."""

    # Dimensions
    length: float = 1.0              # meters (0.1 - 3.0)
    base_diameter: float = 0.08      # meters (0.02 - 0.20)
    tip_diameter: float = 0.02       # meters (0.005 - 0.10)

    # Segmentation
    segments: int = 20               # count (10 - 50)
    curve_resolution: int = 64       # points per segment

    # Shape
    taper_profile: str = "organic"   # linear, smooth, organic, custom
    twist: float = 0.0               # degrees along length

    # Quality
    subdivision_levels: int = 2      # for smooth surface

    # Determinism
    seed: int = 42                   # for reproducible output

    # Name
    name: str = "Tentacle"           # Blender object name
```

### TaperProfile

```python
@dataclass
class TaperProfile:
    """Radius profile along tentacle length."""

    profile_type: str = "organic"    # linear, smooth, organic, custom
    points: List[Tuple[float, float]] = field(default_factory=list)
    # points: [(position_0_to_1, radius_factor), ...]
    # Empty = use built-in profile

    # Built-in profile parameters
    base_ratio: float = 2.5          # base_diameter / tip_diameter
    mid_point: float = 0.4           # where taper accelerates
    smoothness: float = 0.5          # curve interpolation
```

### SegmentConfig

```python
@dataclass
class SegmentConfig:
    """Segmentation control for tentacle body."""

    count: int = 20                  # number of segments
    curve_resolution: int = 64       # points per segment for curve
    uniform: bool = True             # equal segment length
    variation: float = 0.0           # random variation (0-0.2)
```

### ZombieMouthConfig (Partial)

```python
@dataclass
class ZombieMouthConfig:
    """Configuration for zombie mouth tentacle attachment."""

    tentacle_count: int = 4          # 1-6 tentacles
    distribution: str = "staggered"  # uniform, random, staggered
    size_mix: float = 0.5            # 0=all thin, 1=all thick
    spread_angle: float = 60.0       # degrees across mouth

    # Individual tentacle configs
    main_tentacle: TentacleConfig = field(default_factory=TentacleConfig)
    feeler_tentacle: Optional[TentacleConfig] = None
```

---

## YAML Preset Structure

### configs/tentacle/presets.yaml

```yaml
# Tentacle Geometry Presets

presets:
  # Standard tentacles
  default:
    length: 1.0
    base_diameter: 0.08
    tip_diameter: 0.02
    segments: 20
    taper_profile: "organic"

  short_thick:
    length: 0.5
    base_diameter: 0.12
    tip_diameter: 0.04
    segments: 15
    taper_profile: "smooth"

  long_thin:
    length: 2.0
    base_diameter: 0.05
    tip_diameter: 0.01
    segments: 30
    taper_profile: "organic"

  feeler:
    length: 0.3
    base_diameter: 0.03
    tip_diameter: 0.008
    segments: 10
    taper_profile: "linear"

  # Zombie-specific
  zombie_main:
    length: 1.2
    base_diameter: 0.10
    tip_diameter: 0.025
    segments: 25
    taper_profile: "organic"
    twist: 15.0

  zombie_feeler:
    length: 0.6
    base_diameter: 0.04
    tip_diameter: 0.01
    segments: 12
    taper_profile: "smooth"

# Taper profiles
taper_profiles:
  linear:
    points: []  # Calculated: linear interpolation

  smooth:
    points: []  # Calculated: ease-in-out curve

  organic:
    points: []  # Calculated: natural bulbous shape
    base_ratio: 2.5
    mid_point: 0.4
    smoothness: 0.5

# Zombie mouth configurations
zombie_mouths:
  standard:
    tentacle_count: 4
    distribution: "staggered"
    size_mix: 0.5
    spread_angle: 60.0
    main_tentacle: "zombie_main"
    feeler_tentacle: "zombie_feeler"

  aggressive:
    tentacle_count: 6
    distribution: "uniform"
    size_mix: 0.3
    spread_angle: 80.0

  subtle:
    tentacle_count: 2
    distribution: "random"
    size_mix: 0.8
    spread_angle: 40.0
```

---

## Preset Loader Implementation

### lib/tentacle/presets.py

```python
"""Tentacle preset loading utilities."""

from pathlib import Path
from typing import Dict, List, Optional, Any
import yaml

from .types import TentacleConfig, TaperProfile, ZombieMouthConfig

PRESET_DIR = Path(__file__).parent.parent.parent.parent / "configs" / "tentacle"

class TentaclePresetLoader:
    """Load tentacle configurations from YAML presets."""

    _cache: Dict[str, Any] = {}
    _presets_path: Optional[Path] = None

    @classmethod
    def set_presets_path(cls, path: Path) -> None:
        """Set custom presets directory."""
        cls._presets_path = path
        cls._cache.clear()

    @classmethod
    def _load_presets(cls) -> Dict[str, Any]:
        """Load presets from YAML file with caching."""
        if "presets" in cls._cache:
            return cls._cache["presets"]

        presets_file = (cls._presets_path or PRESET_DIR) / "presets.yaml"
        if not presets_file.exists():
            cls._cache["presets"] = {"presets": {}, "taper_profiles": {}, "zombie_mouths": {}}
            return cls._cache["presets"]

        with open(presets_file, 'r') as f:
            cls._cache["presets"] = yaml.safe_load(f) or {}

        return cls._cache["presets"]

    @classmethod
    def load_tentacle(cls, name: str) -> TentacleConfig:
        """Load a tentacle preset by name."""
        presets = cls._load_presets()
        if name not in presets.get("presets", {}):
            raise ValueError(f"Tentacle preset '{name}' not found")

        return TentacleConfig(**presets["presets"][name])

    @classmethod
    def load_taper_profile(cls, name: str) -> TaperProfile:
        """Load a taper profile preset by name."""
        presets = cls._load_presets()
        if name not in presets.get("taper_profiles", {}):
            # Default to organic if not found
            return TaperProfile(profile_type=name)

        return TaperProfile(**presets["taper_profiles"][name])

    @classmethod
    def load_zombie_mouth(cls, name: str) -> ZombieMouthConfig:
        """Load a zombie mouth configuration by name."""
        presets = cls._load_presets()
        if name not in presets.get("zombie_mouths", {}):
            raise ValueError(f"Zombie mouth preset '{name}' not found")

        config_dict = presets["zombie_mouths"][name]

        # Resolve nested tentacle presets
        if "main_tentacle" in config_dict and isinstance(config_dict["main_tentacle"], str):
            config_dict["main_tentacle"] = cls.load_tentacle(config_dict["main_tentacle"])
        if "feeler_tentacle" in config_dict and isinstance(config_dict["feeler_tentacle"], str):
            config_dict["feeler_tentacle"] = cls.load_tentacle(config_dict["feeler_tentacle"])

        return ZombieMouthConfig(**config_dict)

    @classmethod
    def list_tentacle_presets(cls) -> List[str]:
        """List available tentacle presets."""
        presets = cls._load_presets()
        return list(presets.get("presets", {}).keys())

    @classmethod
    def list_zombie_mouth_presets(cls) -> List[str]:
        """List available zombie mouth presets."""
        presets = cls._load_presets()
        return list(presets.get("zombie_mouths", {}).keys())
```

---

## Package Exports

### lib/tentacle/__init__.py

```python
"""
Tentacle System - Procedural generation for organic tentacles.

Primary use case: Zombie mouth tentacles for horror characters.
"""

__version__ = "0.1.0"

# Core types
from .types import (
    TentacleConfig,
    TaperProfile,
    SegmentConfig,
    ZombieMouthConfig,
)

# Preset loader
from .presets import (
    TentaclePresetLoader,
    load_tentacle,
    load_zombie_mouth,
    list_tentacle_presets,
    list_zombie_mouth_presets,
)

__all__ = [
    # Version
    "__version__",

    # Types
    "TentacleConfig",
    "TaperProfile",
    "SegmentConfig",
    "ZombieMouthConfig",

    # Presets
    "TentaclePresetLoader",
    "load_tentacle",
    "load_zombie_mouth",
    "list_tentacle_presets",
    "list_zombie_mouth_presets",
]
```

---

## Test Coverage

### tests/unit/test_tentacle_types.py

```python
"""Unit tests for tentacle types and presets."""

import pytest
from lib.tentacle import (
    TentacleConfig,
    TaperProfile,
    SegmentConfig,
    ZombieMouthConfig,
    TentaclePresetLoader,
)


class TestTentacleConfig:
    """Test TentacleConfig dataclass."""

    def test_default_values(self):
        """Test default configuration values."""
        config = TentacleConfig()
        assert config.length == 1.0
        assert config.base_diameter == 0.08
        assert config.tip_diameter == 0.02
        assert config.segments == 20
        assert config.taper_profile == "organic"
        assert config.seed == 42

    def test_custom_values(self):
        """Test custom configuration values."""
        config = TentacleConfig(
            length=2.0,
            base_diameter=0.10,
            segments=30,
        )
        assert config.length == 2.0
        assert config.base_diameter == 0.10
        assert config.segments == 30

    def test_validation_ranges(self):
        """Test that values are within valid ranges."""
        # Length: 0.1 - 3.0
        assert TentacleConfig(length=0.1).length == 0.1
        assert TentacleConfig(length=3.0).length == 3.0

        # Segments: 10 - 50
        assert TentacleConfig(segments=10).segments == 10
        assert TentacleConfig(segments=50).segments == 50


class TestTaperProfile:
    """Test TaperProfile dataclass."""

    def test_default_profile(self):
        """Test default taper profile."""
        profile = TaperProfile()
        assert profile.profile_type == "organic"
        assert profile.base_ratio == 2.5

    def test_custom_points(self):
        """Test custom profile points."""
        profile = TaperProfile(
            profile_type="custom",
            points=[(0.0, 1.0), (0.5, 0.6), (1.0, 0.2)],
        )
        assert len(profile.points) == 3


class TestZombieMouthConfig:
    """Test ZombieMouthConfig dataclass."""

    def test_default_values(self):
        """Test default zombie mouth configuration."""
        config = ZombieMouthConfig()
        assert config.tentacle_count == 4
        assert config.distribution == "staggered"
        assert config.size_mix == 0.5

    def test_tentacle_count_range(self):
        """Test tentacle count is within valid range."""
        assert ZombieMouthConfig(tentacle_count=1).tentacle_count == 1
        assert ZombieMouthConfig(tentacle_count=6).tentacle_count == 6


class TestTentaclePresetLoader:
    """Test preset loading."""

    def test_list_presets(self):
        """Test listing available presets."""
        presets = TentaclePresetLoader.list_tentacle_presets()
        assert isinstance(presets, list)
        assert "default" in presets

    def test_load_default_preset(self):
        """Test loading default preset."""
        config = TentaclePresetLoader.load_tentacle("default")
        assert isinstance(config, TentacleConfig)
        assert config.length == 1.0

    def test_load_nonexistent_preset(self):
        """Test error handling for nonexistent preset."""
        with pytest.raises(ValueError):
            TentaclePresetLoader.load_tentacle("nonexistent")
```

---

## Acceptance Criteria

- [ ] TentacleConfig dataclass with all required fields
- [ ] TaperProfile dataclass for shape control
- [ ] SegmentConfig dataclass for segmentation
- [ ] ZombieMouthConfig dataclass for multi-tentacle setup
- [ ] YAML presets file with 6+ tentacle presets
- [ ] PresetLoader with caching
- [ ] 80%+ test coverage
- [ ] Package exports functional
