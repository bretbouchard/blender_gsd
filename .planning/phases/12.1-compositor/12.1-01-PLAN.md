# Phase 12.1: Compositor

**Phase**: 12.1
**Priority**: P1
**Dependencies**: Phase 6.3 (Render System)
**Est. Duration**: 5-6 days

---

## Goal

Implement multi-layer compositing system for VFX integration and final output assembly.

---

## Requirements

- REQ-COMP-01: Layer-based compositing
- REQ-COMP-02: Blend modes
- REQ-COMP-03: Color correction per layer
- REQ-COMP-04: Cryptomatte support
- REQ-COMP-05: Node-based pipeline

---

## Plans

### Plan 12.1-01: Compositor Types

**Deliverable**: `lib/vfx/compositor_types.py`

```python
@dataclass
class CompLayer:
    """Compositor layer."""
    name: str
    source: str  # Render pass, image sequence, solid
    blend_mode: str = "normal"  # normal, add, multiply, screen, overlay
    opacity: float = 1.0
    transform: Transform2D = field(default_factory=Transform2D)
    color_correction: ColorCorrection = field(default_factory=ColorCorrection)
    mask: Optional[str] = None
    enabled: bool = True

@dataclass
class Transform2D:
    """2D transform for layer."""
    position: Tuple[float, float] = (0, 0)
    rotation: float = 0.0
    scale: Tuple[float, float] = (1.0, 1.0)
    anchor: Tuple[float, float] = (0.5, 0.5)

@dataclass
class ColorCorrection:
    """Color correction settings."""
    exposure: float = 0.0
    contrast: float = 1.0
    saturation: float = 1.0
    gamma: float = 1.0
    lift: Tuple[float, float, float] = (0, 0, 0)
    gain: Tuple[float, float, float] = (1, 1, 1)
    offset: Tuple[float, float, float] = (0, 0, 0)

@dataclass
class CompositeConfig:
    """Complete composite configuration."""
    name: str
    resolution: Tuple[int, int] = (1920, 1080)
    frame_rate: float = 24.0
    frame_range: Tuple[int, int] = (1, 250)
    layers: List[CompLayer] = field(default_factory=list)
    output_path: str = ""
    output_format: str = "png"
```

**Tasks**:
1. Create all dataclasses
2. Add serialization
3. Add validation

---

### Plan 12.1-02: Layer Compositor

**Deliverable**: `lib/vfx/layer_compositor.py`

```python
class LayerCompositor:
    """Manage composite layers."""

    def __init__(self, config: CompositeConfig):
        self.config = config
        self.layers: List[CompLayer] = []

    def add_layer(self, layer: CompLayer) -> None:
        """Add layer to composite."""
        pass

    def remove_layer(self, name: str) -> None:
        """Remove layer."""
        pass

    def reorder_layer(self, name: str, new_index: int) -> None:
        """Move layer to new position."""
        pass

    def duplicate_layer(self, name: str) -> CompLayer:
        """Duplicate layer."""
        pass

    def merge_down(self, name: str) -> None:
        """Merge layer with one below."""
        pass

    def render_frame(self, frame: int) -> Any:
        """Render single frame."""
        pass

    def render_all(self) -> None:
        """Render all frames."""
        pass
```

**Tasks**:
1. Implement LayerCompositor
2. Implement layer operations
3. Implement rendering

---

### Plan 12.1-03: Blend Modes

**Deliverable**: `lib/vfx/blend_modes.py`

```python
def blend_normal(base: Any, over: Any, opacity: float) -> Any:
    """Normal blend mode."""
    pass

def blend_add(base: Any, over: Any, opacity: float) -> Any:
    """Additive blend (linear dodge)."""
    pass

def blend_multiply(base: Any, over: Any, opacity: float) -> Any:
    """Multiply blend."""
    pass

def blend_screen(base: Any, over: Any, opacity: float) -> Any:
    """Screen blend."""
    pass

def blend_overlay(base: Any, over: Any, opacity: float) -> Any:
    """Overlay blend."""
    pass

def blend_soft_light(base: Any, over: Any, opacity: float) -> Any:
    """Soft light blend."""
    pass

def blend_hard_light(base: Any, over: Any, opacity: float) -> Any:
    """Hard light blend."""
    pass

def blend_difference(base: Any, over: Any, opacity: float) -> Any:
    """Difference blend."""
    pass

BLEND_MODES = {
    "normal": blend_normal,
    "add": blend_add,
    "multiply": blend_multiply,
    "screen": blend_screen,
    "overlay": blend_overlay,
    "soft_light": blend_soft_light,
    "hard_light": blend_hard_light,
    "difference": blend_difference,
}
```

**Tasks**:
1. Implement all blend modes
2. Test with various inputs
3. Optimize for performance

---

### Plan 12.1-04: Color Correction

**Deliverable**: `lib/vfx/color_correction.py`

```python
def apply_color_correction(image: Any, cc: ColorCorrection) -> Any:
    """Apply color correction to image."""
    pass

def apply_lift_gamma_gain(image: Any, lift: Tuple, gamma: float, gain: Tuple) -> Any:
    """Apply lift/gamma/gain correction."""
    pass

def apply_curves(image: Any, rgb_curve: List, r_curve: List, g_curve: List, b_curve: List) -> Any:
    """Apply curves adjustment."""
    pass

def apply_levels(image: Any, black_point: float, white_point: float, gamma: float) -> Any:
    """Apply levels adjustment."""
    pass

def apply_hsv_adjustment(image: Any, hue: float, saturation: float, value: float) -> Any:
    """Apply HSV adjustment."""
    pass
```

**Tasks**:
1. Implement basic corrections
2. Implement curves
3. Implement levels
4. Implement HSV

---

### Plan 12.1-05: Cryptomatte

**Deliverable**: `lib/vfx/cryptomatte.py`

```python
def load_cryptomatte(path: str) -> Dict:
    """Load cryptomatte layer from EXR."""
    pass

def extract_matte(cryptomatte: Dict, object_name: str) -> Any:
    """Extract matte for specific object."""
    pass

def rank_cryptomatte(cryptomatte: Dict, rank: int) -> Dict:
    """Get objects at specific rank."""
    pass

def create_cryptomatte_manifest(objects: List[str]) -> Dict:
    """Create cryptomatte manifest."""
    pass
```

**Tasks**:
1. Implement cryptomatte loading
2. Implement matte extraction
3. Implement manifest creation

---

### Plan 12.1-06: Blender Integration

**Deliverable**: `lib/vfx/compositor_blender.py`

```python
def create_composite_nodes(config: CompositeConfig) -> Any:
    """Create Blender compositor nodes from config."""
    pass

def add_layer_node(tree: Any, layer: CompLayer) -> Any:
    """Add layer to compositor tree."""
    pass

def create_color_correct_node(tree: Any, cc: ColorCorrection) -> Any:
    """Create color correction node group."""
    pass

def create_blend_node(tree: Any, mode: str) -> Any:
    """Create blend mode node."""
    pass

def setup_render_passes(scene: Any, passes: List[str]) -> None:
    """Enable required render passes."""
    pass
```

**Tasks**:
1. Implement node creation
2. Implement layer nodes
3. Implement CC nodes
4. Implement blend nodes

---

## Acceptance Criteria

- [ ] Layers composite correctly
- [ ] All blend modes work
- [ ] Color correction applies
- [ ] Cryptomatte extracts mattes
- [ ] Blender integration works

---

## Files

```
lib/vfx/
├── __init__.py
├── compositor_types.py
├── layer_compositor.py
├── blend_modes.py
├── color_correction.py
├── cryptomatte.py
└── compositor_blender.py
```
