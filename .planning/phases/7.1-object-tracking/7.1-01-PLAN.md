# Phase 7.1: Object Tracking

**Phase**: 7.1
**Priority**: P0
**Dependencies**: Phase 6.1 (Camera System)
**Est. Duration**: 3-4 days

---

## Goal

Implement object tracking system for automated follow-focus and camera moves based on subject position.

---

## Requirements

- REQ-TRACK-01: Object tracking markers
- REQ-TRACK-02: Motion path calculation
- REQ-TRACK-03: Tracking data export
- REQ-TRACK-04: Follow-focus automation

---

## Plans

### Plan 7.1-01: Tracking Types

**Deliverable**: `lib/cinematic/tracking_types.py`

```python
@dataclass
class TrackingMarker:
    """Single tracking point on an object."""
    name: str
    object_ref: str  # Blender object name or path
    bone_name: str = ""  # For armature tracking
    offset: Tuple[float, float, float] = (0, 0, 0)
    frame_start: int = 1
    frame_end: int = 250
    enabled: bool = True

@dataclass
class TrackingData:
    """Calculated tracking data for a marker."""
    marker_name: str
    positions: Dict[int, Tuple[float, float, float]]  # frame -> world pos
    velocities: Dict[int, Tuple[float, float, float]]
    accelerations: Dict[int, Tuple[float, float, float]]

@dataclass
class TrackingConfig:
    """Complete tracking configuration."""
    markers: List[TrackingMarker] = field(default_factory=list)
    solve_method: str = "automatic"  # automatic, manual, predictive
    smoothing: float = 0.5  # 0-1
    prediction_frames: int = 5  # Look-ahead for smooth following
    export_format: str = "blender"  # blender, ae, nuke, json
```

**Tasks**:
1. Create tracking dataclasses
2. Add serialization methods
3. Add validation

---

### Plan 7.1-02: Tracking Solver

**Deliverable**: `lib/cinematic/tracking_solver.py`

```python
def solve_marker_position(marker: TrackingMarker, frame: int) -> Tuple[float, float, float]:
    """Calculate marker world position at frame."""
    pass

def solve_tracking_data(config: TrackingConfig) -> Dict[str, TrackingData]:
    """Solve all markers for frame range."""
    pass

def interpolate_position(data: TrackingData, frame: int) -> Tuple[float, float, float]:
    """Interpolate position between keyframes."""
    pass

def predict_position(data: TrackingData, frame: int, lookahead: int) -> Tuple[float, float, float]:
    """Predict future position for smooth following."""
    pass

def apply_smoothing(data: TrackingData, amount: float) -> TrackingData:
    """Apply temporal smoothing to tracking data."""
    pass
```

**Tasks**:
1. Implement position solving
2. Implement interpolation
3. Implement prediction
4. Implement smoothing

---

### Plan 7.1-03: Follow Focus

**Deliverable**: `lib/cinematic/follow_focus.py`

```python
def calculate_focus_distance(camera_pos: Tuple, target_pos: Tuple) -> float:
    """Calculate focus distance from camera to target."""
    pass

def create_follow_focus_rig(camera: str, target: TrackingMarker) -> "FollowFocusRig":
    """Create automated follow-focus setup."""
    pass

def animate_focus_distance(rig: "FollowFocusRig", tracking_data: TrackingData):
    """Keyframe focus distance based on tracking."""
    pass

def set_focus_mode(camera: str, mode: str):
    """Set focus mode: auto, manual, tracked."""
    pass
```

**Tasks**:
1. Implement distance calculation
2. Implement rig creation
3. Implement keyframe generation

---

### Plan 7.1-04: Tracking Export

**Deliverable**: `lib/cinematic/tracking_export.py`

```python
def export_tracking_json(data: Dict[str, TrackingData], path: str):
    """Export tracking data as JSON."""
    pass

def export_tracking_ae(data: Dict[str, TrackingData], path: str):
    """Export for After Effects."""
    pass

def export_tracking_nuke(data: Dict[str, TrackingData], path: str):
    """Export for Nuke."""
    pass

def export_tracking_blender(data: Dict[str, TrackingData], path: str):
    """Export as Blender markers."""
    pass
```

**Tasks**:
1. Implement JSON export
2. Implement AE format
3. Implement Nuke format
4. Implement Blender format

---

## Acceptance Criteria

- [ ] Markers track objects correctly
- [ ] Tracking data calculates motion
- [ ] Follow-focus animates correctly
- [ ] Export produces valid files

---

## Files

```
lib/cinematic/
├── tracking_types.py
├── tracking_solver.py
├── follow_focus.py
└── tracking_export.py
```
