# Phase 14.2: Master Production Config

**Phase**: 14.2
**Priority**: P0
**Dependencies**: Phase 14.1 (Production Orchestrator)
**Est. Duration**: 3-4 days

---

## Goal

Define the master production configuration schema that specifies everything needed for one-shot movie generation.

---

## Requirements

- REQ-CONFIG-01: Complete production specification
- REQ-CONFIG-02: Character definitions with wardrobe
- REQ-CONFIG-03: Location specifications
- REQ-CONFIG-04: Shot list integration
- REQ-CONFIG-05: Output format specifications
- REQ-CONFIG-06: Retro graphics configuration

---

## Plans

### Plan 14.2-01: Schema Definition

**Deliverable**: `lib/production/config_schema.py`

```python
"""
Master Production Configuration Schema

A single YAML file that defines an entire production.

Example:
```yaml
production:
  meta:
    title: "My Short Film"
    version: "1.0"
    author: "Director Name"

  source:
    script: "scripts/my_film.fountain"
    style_preset: "cinematic_teal_orange"

  characters:
    hero:
      model: "assets/characters/hero.blend"
      wardrobe:
        default: "hero_casual"
        scenes_10_20: "hero_formal"

  locations:
    warehouse:
      preset: "industrial"
      hdri: "abandoned_warehouse"

  shots:
    - scene: 1
      template: "establishing_wide"
      location: "warehouse"
    - scene: 1
      template: "character_cu"
      character: "hero"

  outputs:
    - name: "cinema"
      format: "prores_4444"
      resolution: [4096, 2160]
    - name: "snes_version"
      format: "png_sequence"
      retro:
        palette: "snes"
        dither: "error_diffusion"
```
"""

@dataclass
class ProductionMeta:
    """Production metadata."""
    title: str
    version: str = "1.0"
    author: str = ""
    created: datetime = field(default_factory=datetime.now)
    description: str = ""

@dataclass
class SourceConfig:
    """Source material configuration."""
    script: str = ""
    style_preset: str = "cinematic"
    reference_images: List[str] = field(default_factory=list)

@dataclass
class CharacterDef:
    """Character definition."""
    name: str
    model: str  # Path to character model
    voice: str = ""  # Voice reference
    wardrobe: Dict[str, str] = field(default_factory=dict)  # scene_range -> costume

@dataclass
class LocationDef:
    """Location definition."""
    name: str
    preset: str = ""  # Set preset name
    hdri: str = ""  # HDRI preset name
    custom_setup: str = ""  # Path to .blend file

@dataclass
class ShotDef:
    """Shot definition."""
    scene: int
    template: str  # Shot template name
    character: str = ""
    location: str = ""
    duration: float = 0  # Override duration (0 = auto)
    notes: str = ""

@dataclass
class OutputDef:
    """Output format definition."""
    name: str
    format: str  # prores_4444, h265, png_sequence
    resolution: Tuple[int, int] = (1920, 1080)
    frame_rate: int = 24
    retro: Optional[Dict] = None  # Retro config if applicable
    path: str = ""  # Output path

@dataclass
class MasterProductionConfig:
    """Complete production configuration."""
    meta: ProductionMeta
    source: SourceConfig
    characters: Dict[str, CharacterDef]
    locations: Dict[str, LocationDef]
    shots: List[ShotDef]
    outputs: List[OutputDef]

    @classmethod
    def from_yaml(cls, path: str) -> "MasterProductionConfig":
        """Load from YAML file."""
        pass

    def to_yaml(self, path: str) -> None:
        """Save to YAML file."""
        pass

    def validate(self) -> ValidationResult:
        """Validate configuration."""
        pass
```

**Tasks**:
1. Define all dataclasses
2. Implement YAML loading
3. Implement YAML saving
4. Implement validation

---

### Plan 14.2-02: Template Expansion

**Deliverable**: `lib/production/template_expansion.py`

```python
def expand_shot_templates(config: MasterProductionConfig) -> List[CompleteShotConfig]:
    """Expand shot templates into full shot configurations."""
    pass

def resolve_character_wardrobe(character: str, scene: int, config: MasterProductionConfig) -> str:
    """Resolve costume for character in scene."""
    pass

def resolve_location(location_name: str, config: MasterProductionConfig) -> LocationConfig:
    """Resolve location to full configuration."""
    pass

def apply_style_preset(style: str, shot: CompleteShotConfig) -> CompleteShotConfig:
    """Apply style preset to shot."""
    pass
```

**Tasks**:
1. Implement template expansion
2. Implement wardrobe resolution
3. Implement location resolution
4. Implement style application

---

### Plan 14.2-03: Validation

**Deliverable**: `lib/production/config_validation.py`

```python
def validate_master_config(config: MasterProductionConfig) -> ValidationResult:
    """Complete validation of production config."""
    pass

def check_file_references(config: MasterProductionConfig) -> List[ValidationIssue]:
    """Check all file paths exist."""
    pass

def check_character_models(config: MasterProductionConfig) -> List[ValidationIssue]:
    """Validate character model references."""
    pass

def check_location_presets(config: MasterProductionConfig) -> List[ValidationIssue]:
    """Validate location preset references."""
    pass

def check_shot_templates(config: MasterProductionConfig) -> List[ValidationIssue]:
    """Validate shot template references."""
    pass

def check_output_formats(config: MasterProductionConfig) -> List[ValidationIssue]:
    """Validate output format specifications."""
    pass
```

**Tasks**:
1. Implement full validation
2. Implement file checking
3. Implement reference checking

---

### Plan 14.2-04: Example Productions

**Deliverable**: `configs/production/examples/`

```yaml
# example: short_film.yaml
production:
  meta:
    title: "The Discovery"
    version: "1.0"
    author: "Demo"

  source:
    script: "scripts/discovery.fountain"
    style_preset: "cinematic_warm"

  characters:
    alex:
      model: "assets/characters/alex.blend"
      wardrobe:
        default: "alex_casual"
        scenes_5_8: "alex_formal"

    sam:
      model: "assets/characters/sam.blend"
      wardrobe:
        default: "sam_work"

  locations:
    apartment:
      preset: "modern_apartment"
    office:
      preset: "corporate_office"
    rooftop:
      preset: "urban_rooftop"
      hdri: "city_night"

  shots:
    - scene: 1
      template: "establishing_wide"
      location: "apartment"
    - scene: 1
      template: "two_shot"
      character: "alex"
      character2: "sam"
    - scene: 2
      template: "cu_dialogue"
      character: "alex"

  outputs:
    - name: "master"
      format: "prores_4444"
      resolution: [4096, 2160]
      path: "output/master/"
    - name: "web"
      format: "h265"
      resolution: [1920, 1080]
      path: "output/web/"
```

**Tasks**:
1. Create example short film
2. Create example commercial
3. Create example game assets

---

### Plan 14.2-05: CLI Integration

**Deliverable**: Update `lib/production/cli.py`

```python
@production.command()
@click.argument('yaml_path')
@click.option('--expand', is_flag=True, help='Show expanded configuration')
def show(yaml_path, expand):
    """Show production configuration."""
    config = MasterProductionConfig.from_yaml(yaml_path)

    if expand:
        shots = expand_shot_templates(config)
        # Show expanded shots

    # Print summary
    pass

@production.command()
@click.argument('yaml_path')
def check(yaml_path):
    """Validate production configuration."""
    config = MasterProductionConfig.from_yaml(yaml_path)
    result = config.validate()

    # Print results
    pass
```

**Tasks**:
1. Implement show command
2. Implement check command
3. Implement verbose output

---

## Acceptance Criteria

- [ ] Schema defines all necessary fields
- [ ] YAML loads correctly
- [ ] Templates expand to full shots
- [ ] Validation catches all errors
- [ ] Examples demonstrate all features
- [ ] CLI works with config

---

## Files

```
lib/production/
├── config_schema.py
├── template_expansion.py
├── config_validation.py
└── cli.py (updated)

configs/production/
├── schema.yaml
├── templates/
│   ├── short_film.yaml
│   ├── commercial.yaml
│   └── game_assets.yaml
└── examples/
    ├── the_discovery.yaml
    └── product_demo.yaml
```
