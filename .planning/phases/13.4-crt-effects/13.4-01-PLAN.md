# Phase 13.4: CRT & Display Effects

**Phase**: 13.4
**Priority**: P2
**Dependencies**: Phase 13.1 (Pixel Converter)
**Est. Duration**: 3-4 days

---

## Goal

Implement authentic retro display simulation effects for vintage CRT, LCD, and other display technologies.

---

## Requirements

- REQ-RETRO-06: Scanline effects
- REQ-RETRO-06: Phosphor patterns
- REQ-RETRO-06: Screen curvature
- REQ-RETRO-06: CRT presets (arcade, TV, PVM)
- REQ-RETRO-06: Additional effects (vignette, bloom, flicker)

---

## Plans

### Plan 13.4-01: CRT Types

**Deliverable**: `lib/retro/crt_types.py`

```python
@dataclass
class ScanlineConfig:
    """Scanline effect configuration."""
    enabled: bool = True
    intensity: float = 0.3  # 0-1
    spacing: int = 2  # Pixels per scanline (1 = every line)
    thickness: float = 0.5  # 0-1, how much of each line is dark
    mode: str = "alternate"  # alternate, every_line

@dataclass
class PhosphorConfig:
    """Phosphor mask configuration."""
    enabled: bool = False
    pattern: str = "rgb"  # rgb, bgr, aperture_grille, slot_mask
    intensity: float = 0.5
    scale: float = 1.0  # Scale of phosphor pattern

@dataclass
class CurvatureConfig:
    """Screen curvature configuration."""
    enabled: bool = False
    amount: float = 0.1  # 0-1
    vignette_amount: float = 0.2

@dataclass
class CRTConfig:
    """Complete CRT effect configuration."""
    name: str = "custom"

    # Scanlines
    scanlines: ScanlineConfig = field(default_factory=ScanlineConfig)

    # Phosphor mask
    phosphor: PhosphorConfig = field(default_factory=PhosphorConfig)

    # Screen curvature
    curvature: CurvatureConfig = field(default_factory=CurvatureConfig)

    # Additional effects
    bloom: float = 0.0
    chromatic_aberration: float = 0.0
    flicker: float = 0.0
    interlace: bool = False
    pixel_jitter: float = 0.0
    noise: float = 0.0

    # Color adjustments
    brightness: float = 1.0
    contrast: float = 1.0
    saturation: float = 1.0
    gamma: float = 2.2

# Preset configurations
CRT_PRESETS = {
    "crt_arcade": CRTConfig(
        name="crt_arcade",
        scanlines=ScanlineConfig(enabled=True, intensity=0.25),
        phosphor=PhosphorConfig(enabled=True, pattern="aperture_grille"),
        curvature=CurvatureConfig(enabled=True, amount=0.08),
        bloom=0.15,
    ),
    "crt_tv": CRTConfig(
        name="crt_tv",
        scanlines=ScanlineConfig(enabled=True, intensity=0.4),
        phosphor=PhosphorConfig(enabled=True, pattern="slot_mask"),
        curvature=CurvatureConfig(enabled=True, amount=0.12),
        noise=0.05,
    ),
    "pvm": CRTConfig(
        name="pvm",  # Sony PVM professional monitor
        scanlines=ScanlineConfig(enabled=True, intensity=0.15, spacing=1),
        phosphor=PhosphorConfig(enabled=True, pattern="aperture_grille", intensity=0.3),
        curvature=CurvatureConfig(enabled=False),
    ),
    "lcd_gameboy": CRTConfig(
        name="lcd_gameboy",
        scanlines=ScanlineConfig(enabled=False),
        phosphor=PhosphorConfig(enabled=False),
        pixel_jitter=0.02,
        contrast=1.2,
        saturation=0.8,
    ),
}
```

**Tasks**:
1. Create all dataclasses
2. Define presets
3. Add validation

---

### Plan 13.4-02: Scanline Effect

**Deliverable**: `lib/retro/scanlines.py`

```python
def apply_scanlines(image: Any, config: ScanlineConfig) -> Any:
    """Apply scanline effect to image."""
    pass

def create_scanline_overlay(height: int, config: ScanlineConfig) -> Any:
    """Create scanline overlay mask."""
    pass

def apply_scanlines_gpu(image: Any, config: ScanlineConfig) -> Any:
    """GPU-accelerated scanline effect (OpenGL/compositor)."""
    pass

# Scanline patterns
def alternate_scanlines(height: int, intensity: float, thickness: float) -> List[float]:
    """Generate alternate line pattern (dark/light/dark/light)."""
    pass

def every_line_scanlines(height: int, intensity: float, thickness: float) -> List[float]:
    """Generate every-line pattern."""
    pass
```

**Tasks**:
1. Implement basic scanline effect
2. Implement different patterns
3. Implement GPU version (Blender compositor)
4. Test with various settings

---

### Plan 13.4-03: Phosphor Mask

**Deliverable**: `lib/retro/phosphor.py`

```python
# Phosphor patterns
PHOSPHOR_PATTERNS = {
    "rgb": [
        # R G B stripe pattern
        [1, 0, 0], [0, 1, 0], [0, 0, 1]
    ],
    "bgr": [
        # B G R stripe pattern
        [0, 0, 1], [0, 1, 0], [1, 0, 0]
    ],
    "aperture_grille": [
        # Sony Trinitron style
        # Vertical RGB stripes
    ],
    "slot_mask": [
        # Standard CRT slot mask
        # Delta pattern
    ],
}

def create_phosphor_mask(width: int, height: int, pattern: str, scale: float) -> Any:
    """Create phosphor mask pattern."""
    pass

def apply_phosphor_mask(image: Any, config: PhosphorConfig) -> Any:
    """Apply phosphor mask effect."""
    pass

def create_aperture_grille_mask(width: int, height: int, scale: float) -> Any:
    """Create Trinitron-style aperture grille mask."""
    pass

def create_slot_mask(width: int, height: int, scale: float) -> Any:
    """Create standard CRT slot mask."""
    pass
```

**Tasks**:
1. Implement mask generation
2. Implement aperture grille
3. Implement slot mask
4. Implement application
5. Test with various scales

---

### Plan 13.4-04: Screen Curvature

**Deliverable**: `lib/retro/curvature.py`

```python
def apply_curvature(image: Any, config: CurvatureConfig) -> Any:
    """Apply screen curvature distortion."""
    pass

def calculate_curved_uv(u: float, v: float, amount: float) -> Tuple[float, float]:
    """Calculate curved screen UV coordinates."""
    pass

def apply_vignette(image: Any, amount: float) -> Any:
    """Apply vignette (edge darkening)."""
    pass

def create_barrel_distortion(amount: float) -> Any:
    """Create barrel distortion map."""
    pass

def combine_curvature_vignette(image: Any, curvature: float, vignette: float) -> Any:
    """Apply both effects in one pass."""
    pass
```

**Tasks**:
1. Implement curvature distortion
2. Implement vignette
3. Implement combined effect
4. Test with various amounts

---

### Plan 13.4-05: Additional Effects

**Deliverable**: `lib/retro/crt_effects.py`

```python
def apply_bloom(image: Any, amount: float) -> Any:
    """Apply bloom/glow effect."""
    pass

def apply_chromatic_aberration(image: Any, amount: float) -> Any:
    """Apply RGB channel separation."""
    pass

def apply_flicker(image: Any, amount: float, frame: int) -> Any:
    """Apply frame brightness flicker."""
    pass

def apply_interlace(image: Any, field: int) -> Any:
    """Apply interlacing effect."""
    pass

def apply_pixel_jitter(image: Any, amount: float, frame: int) -> Any:
    """Apply subtle pixel movement."""
    pass

def apply_noise(image: Any, amount: float) -> Any:
    """Apply analog noise."""
    pass

def apply_all_effects(image: Any, config: CRTConfig, frame: int = 0) -> Any:
    """Apply all CRT effects in correct order."""
    # Order: curvature → chromatic aberration → scanlines → phosphor → bloom → noise → flicker
    pass
```

**Tasks**:
1. Implement bloom
2. Implement chromatic aberration
3. Implement flicker
4. Implement interlace
5. Implement jitter
6. Implement noise
7. Implement combined pipeline

---

### Plan 13.4-06: Compositor Integration

**Deliverable**: `lib/retro/crt_compositor.py`

```python
def create_crt_node_group(config: CRTConfig) -> Any:
    """Create Blender compositor node group for CRT effects."""
    pass

def setup_crt_compositing(node_tree: Any, config: CRTConfig) -> None:
    """Set up full CRT compositing pipeline."""
    pass

def create_scanline_node(node_tree: Any, config: ScanlineConfig) -> Any:
    """Create scanline compositor node."""
    pass

def create_curvature_node(node_tree: Any, config: CurvatureConfig) -> Any:
    """Create curvature compositor node."""
    pass

# Node group templates
CRT_NODE_GROUP_NAME = "CRT_Effects"
```

**Tasks**:
1. Implement node group creation
2. Implement individual nodes
3. Implement full pipeline
4. Test in Blender
5. Update __init__.py

---

### Plan 13.4-07: Presets

**Deliverable**: `configs/cinematic/retro/crt_presets.yaml`

```yaml
presets:
  # 80s Arcade monitor
  arcade_80s:
    scanlines:
      enabled: true
      intensity: 0.25
      spacing: 2
    phosphor:
      enabled: true
      pattern: "aperture_grille"
      intensity: 0.4
    curvature:
      enabled: true
      amount: 0.08
      vignette_amount: 0.15
    bloom: 0.15
    chromatic_aberration: 0.002

  # Home CRT TV
  crt_tv_90s:
    scanlines:
      enabled: true
      intensity: 0.35
      spacing: 1
    phosphor:
      enabled: true
      pattern: "slot_mask"
      intensity: 0.5
    curvature:
      enabled: true
      amount: 0.12
      vignette_amount: 0.2
    noise: 0.03
    flicker: 0.02

  # Sony PVM Professional
  sony_pvm:
    scanlines:
      enabled: true
      intensity: 0.15
      spacing: 1
      thickness: 0.3
    phosphor:
      enabled: true
      pattern: "aperture_grille"
      intensity: 0.25
    curvature:
      enabled: false
    bloom: 0.05

  # Game Boy LCD
  gameboy_lcd:
    scanlines:
      enabled: false
    phosphor:
      enabled: false
    curvature:
      enabled: false
    pixel_jitter: 0.02
    contrast: 1.3
    saturation: 0.7
    gamma: 2.4

  # CGA Monitor
  cga_monitor:
    scanlines:
      enabled: true
      intensity: 0.5
      spacing: 1
    phosphor:
      enabled: true
      pattern: "rgb"
      intensity: 0.6
    curvature:
      enabled: true
      amount: 0.05
    flicker: 0.03

  # Modern LCD (clean)
  modern_lcd:
    scanlines:
      enabled: false
    phosphor:
      enabled: false
    curvature:
      enabled: false
    # Just subtle effects
    chromatic_aberration: 0.001
```

**Tasks**:
1. Create preset file
2. Implement preset loader
3. Document each preset
4. Create comparison images

---

## Acceptance Criteria

- [ ] Scanlines render correctly with various settings
- [ ] Phosphor masks produce authentic patterns
- [ ] Curvature distortion looks natural
- [ ] All additional effects work
- [ ] Effects combine correctly in pipeline
- [ ] Presets produce expected looks
- [ ] Compositor integration works in Blender

---

## Files

```
lib/retro/
├── crt_types.py           # Data structures
├── scanlines.py           # Scanline effect
├── phosphor.py            # Phosphor mask
├── curvature.py           # Screen curvature
├── crt_effects.py         # Additional effects
└── crt_compositor.py      # Blender integration

configs/cinematic/retro/
└── crt_presets.yaml       # CRT presets
```
